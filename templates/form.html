<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>VinayagaTex Data Management System</title>
    <title>VinayagaTex Data Management System</title>
    <link rel="icon" type="image/png" href="{{ url_for('static', filename='favicon.png') }}">

    <title>powerloom Data Management System</title>

    <!-- Tailwind CSS CDN - Re-added for simplicity and to ensure all classes are rendered correctly. If a build process is used, this can be removed. -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- jsPDF and jspdf-autotable for PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <!-- Chart.js for graphs -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* Base styles for the body */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8; /* Softer light gray background */
            color: #333;
            margin: 0;
            padding: 0;
        }
        /* Ensure main content takes full height */
        html, body {
            height: 100%;
        }
        #app-container {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }
        /* Custom styles */
        .form-group {
            transition: all 0.3s ease;
        }
        .form-group:hover {
            transform: translateY(-2px);
        }
        .btn {
            transition: all 0.2s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.15);
        }
        .btn:active {
            transform: translateY(0);
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        }
        /* Gradient Button Styles */
        .btn-primary {
            background-image: linear-gradient(to right, #6366f1, #8b5cf6); /* Indigo-500 to Violet-500 */
            color: white;
            border: none;
            position: relative;
            overflow: hidden;
            z-index: 1;
        }
        .btn-primary:hover {
            background-image: linear-gradient(to right, #4f46e5, #7c3aed); /* Darker shades */
            transform: translateY(-3px) scale(1.02); /* More pronounced hover */
        }
        .btn-primary:active {
            transform: translateY(0) scale(0.98); /* Click effect */
        }
        .btn-primary::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 300%;
            height: 300%;
            background: rgba(255, 255, 255, 0.15);
            border-radius: 50%;
            transform: translate(-50%, -50%) scale(0);
            transition: transform 0.5s ease-out;
            z-index: -1;
        }
        .btn-primary:hover::before {
            transform: translate(-50%, -50%) scale(1);
        }


        #notification {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            transition: all 0.4s ease-out;
            opacity: 0;
            transform: translateY(-30px);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1rem 1.5rem;
            border-radius: 0.75rem; /* rounded-xl */
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2);
            min-width: 250px;
        }
        #notification.show {
            opacity: 1;
            transform: translateY(0);
        }
        #notification.success {
            background-color: #10b981; /* Emerald-500 */
        }
        #notification.error {
            background-color: #ef4444; /* Red-500 */
        }
        #notification.info {
            background-color: #3b82f6; /* Blue-500 */
        }
        .notification-close-btn {
            background: none;
            border: none;
            color: white;
            font-size: 1.2rem;
            cursor: pointer;
            margin-left: 1rem;
        }

        /* Basic table styles for better readability */
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
            border-radius: 0.5rem; /* rounded-lg */
            overflow: hidden; /* Ensures rounded corners apply to content */
        }
        th, td {
            padding: 0.9rem; /* Increased padding */
            text-align: left;
            border-bottom: 1px solid #e2e8f0; /* gray-200 */
        }
        th {
            background-color: #e0e7ff; /* Indigo-100 */
            font-weight: 700; /* Bolder headers */
            color: #4338ca; /* Indigo-700 */
            text-transform: uppercase;
            font-size: 0.85rem;
        }
        tr:hover {
            background-color: #f0f4f8; /* gray-100 */
        }
        /* Loading spinner styles */
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid #fff;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            animation: spin 1s linear infinite;
            display: inline-block;
            vertical-align: middle;
            /* margin-left: 8px; */ /* Removed to center it when text is hidden */
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* New classes for meter coloring */
        .meters-red { color: #ef4444; } /* red-500 */
        .meters-orange { color: #ea580c; } /* orange-600 */
        .meters-green { color: #22c55e; } /* green-500 */
        .meters-dark-red { color: #991b1b; } /* red-800 */
    
        /* Navigation Active State - IMPROVED */
        .nav-item-active {
            background-color: #3730a3; /* Deeper indigo for active state */
            color: white;
            font-weight: bold;
            box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.3); /* Inner shadow for depth */
            border-bottom: 4px solid #a78bfa; /* Light violet border at the bottom */
            transform: translateY(-2px); /* Slight lift */
            padding-bottom: calc(0.75rem - 4px); /* Adjust padding for border */
        }
        .nav-item-active:hover {
            background-color: #312e81; /* Even darker on hover for active */
            transform: translateY(-3px) scale(1.01); /* More pronounced hover */
        }
        /* LLM Response Box - REMOVED, but keeping the style in case it's re-added */
        .llm-response-box {
            background-color: #e0f2fe; /* Light blue background */
            border: 1px solid #90cdf4; /* Blue border */
            border-left: 5px solid #3b82f6; /* Stronger left border */
            padding: 1.25rem;
            border-radius: 0.75rem;
            margin-top: 1.5rem;
            font-size: 0.95rem;
            color: #2c5282; /* Darker blue text */
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            line-height: 1.6;
        }
        .llm-response-box p {
            margin-bottom: 0.5rem;
        }
        .llm-response-box p:last-child {
            margin-bottom: 0;
        }
        .llm-response-box ul {
            list-style-type: disc;
            margin-left: 1.25rem;
            padding-left: 0.5rem;
        }
        .llm-response-box li {
            margin-bottom: 0.25rem;
        }

        /* Tabs for Admin Section and Report Section */
        .tab-button {
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem 0.5rem 0 0;
            background-color: #e0e7ff; /* indigo-100 */
            color: #4f46e5; /* indigo-600 */
            font-weight: 600;
            transition: all 0.2s ease;
            cursor: pointer;
            border-bottom: 2px solid transparent;
        }
        .tab-button.active {
            background-color: #fff;
            border-bottom-color: #4f46e5; /* indigo-600 */
            color: #3730a3; /* indigo-800 */
        }
        .tab-button:hover {
            background-color: #c7d2fe; /* indigo-200 */
        }
        .tab-content {
            border: 1px solid #e2e8f0; /* gray-200 */
            border-top: none;
            padding: 1.5rem;
            background-color: #fff;
            border-radius: 0 0 0.5rem 0.5rem;
        }
    </style>
</head>
<body class="bg-gray-50">
    <div id="notification" class="hidden">
        <span></span>
        <button class="notification-close-btn" onclick="document.getElementById('notification').classList.add('hidden');">&times;</button>
    </div>

    <div class="container mx-auto px-4 py-8 max-w-5xl">
        <header class="mb-10 text-center bg-gradient-to-r from-indigo-50 to-blue-50 p-6 rounded-lg shadow-lg">
            
            <h1 class="text-4xl font-extrabold text-indigo-800 mb-2">Powerloom Data Management System</h1>
            <p class="text-gray-700 mt-2 text-lg">Efficiently track loom production metrics and gain valuable insights</p>
            
            <div class="mt-6 text-gray-700 flex flex-col sm:flex-row justify-center items-center space-y-2 sm:space-y-0 sm:space-x-4">
                <p>Welcome, <span id="currentUsername" class="font-semibold capitalize text-indigo-600"></span> (<span id="currentUserRole" class="font-semibold capitalize text-indigo-600"></span>)</p>
                <button id="logoutBtn" class="btn bg-gray-200 text-gray-700 py-2 px-4 rounded-lg hover:bg-gray-300 text-sm shadow-md">Logout</button>
            </div>
        </header>

        <!-- Navigation Menu -->
        <nav class="mb-8 bg-indigo-700 rounded-lg shadow-xl">
            <ul class="flex flex-col sm:flex-row justify-around p-4 text-white font-medium">
                <li id="navHomeLink" class="hidden"><a href="#" id="navHome" class="block py-2 px-4 rounded-md hover:bg-indigo-600 transition duration-200 text-lg">Enter Data</a></li>
                <li><a href="#" id="navReport" class="block py-2 px-4 rounded-md hover:bg-indigo-600 transition duration-200 text-lg">Reports</a></li>
                <li><a href="#" id="navGraphs" class="block py-2 px-4 rounded-md hover:bg-indigo-600 transition duration-200 text-lg">Graphs</a></li>
                <li id="navAdminLink" class="hidden">
                    <a href="#" id="navAdmin" class="block py-2 px-4 rounded-md hover:bg-indigo-600 transition duration-200 text-lg">Admin Tools</a>
                </li>
            </ul>
        </nav>

        <div id="contentSections">
            <!-- Section: Enter Loom Data -->
            <section id="dataEntrySection" class="main-content-section bg-white p-8 rounded-lg shadow-xl mb-8 hidden">
                <h2 class="text-2xl font-bold mb-6 text-indigo-700 border-b-2 border-indigo-200 pb-3">Enter Loom Data</h2>
                <form id="dataEntryForm" class="space-y-5">
                    <div class="form-group">
                        <label class="block text-gray-700 mb-1 font-semibold">Loomer Name</label>
                        <input type="text" name="loomer_name" id="data_loomer_name" required 
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-400 focus:border-indigo-400 transition duration-200 shadow-sm">
                    </div>

                    <div class="form-group">
                        <label class="block text-gray-700 mb-1 font-semibold">Loom Number</label>
                        <input type="text" name="loom_number" required 
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-400 focus:border-indigo-400 transition duration-200 shadow-sm">
                    </div>

                    <div class="form-group">
                        <label class="block text-gray-700 mb-1 font-semibold">Shift</label>
                        <select name="shift" required 
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-400 focus:border-indigo-400 transition duration-200 shadow-sm">
                            <option value="">-- Select Shift --</option>
                            <option value="Morning">Morning</option>
                            <option value="Night">Night</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="block text-gray-700 mb-1 font-semibold">Meters</label>
                        <input type="number" name="meters" min="0" required 
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-400 focus:border-indigo-400 transition duration-200 shadow-sm">
                    </div>

                    <div class="form-group">
                        <label class="block text-gray-700 mb-1 font-semibold">Salary per Meter</label>
                        <input type="number" name="salary_per_meter" min="0" step="0.01" required 
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-400 focus:border-indigo-400 transition duration-200 shadow-sm">
                    </div>

                    <div class="form-group">
                        <label class="block text-gray-700 mb-1 font-semibold">Date</label>
                        <input type="date" name="date" id="data_date" required max="2100-12-31" min="2000-01-01" 
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-400 focus:border-indigo-400 transition duration-200 shadow-sm">
                    </div>

                    <button type="submit" id="submitDataBtn" class="btn btn-primary w-full py-3 px-4 rounded-lg flex items-center justify-center text-lg">
                        <span id="submitDataBtnText">Submit Data</span><span id="submitDataSpinner" class="spinner hidden"></span>
                    </button>
                </form>
            </section>

            <!-- Section: Production Report -->
            <section id="reportSection" class="main-content-section bg-white p-8 rounded-lg shadow-xl mb-8 hidden">
                <h2 class="text-2xl font-bold mb-6 text-indigo-700 border-b-2 border-indigo-200 pb-3">Production Report</h2>
                <form id="dataQueryForm" class="space-y-5">
                    <div class="form-group" id="loomerNameQueryGroup">
                        <label class="block text-gray-700 mb-1 font-semibold">Loomer Name</label>
                        <input type="text" name="loomer_name" id="report_loomer_name" required 
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-400 focus:border-indigo-400 transition duration-200 shadow-sm">
                        <p class="text-xs text-gray-500 mt-1 hidden" id="loomerNameReportHint">Enter "all" for all loomers (Admin only)</p> 
                    </div>

                    <div class="form-group">
                        <label class="block text-gray-700 mb-1 font-semibold">Shift</label>
                        <select name="shift" required 
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-400 focus:border-indigo-400 transition duration-200 shadow-sm">
                            <option value="all">All Shifts</option>
                            <option value="Morning">Morning</option>
                            <option value="Night">Night</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="block text-gray-700 mb-1 font-semibold">Loom Number</label>
                        <input type="text" name="loom_number" value="all" required 
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-400 focus:border-indigo-400 transition duration-200 shadow-sm">
                        <p class="text-xs text-gray-500 mt-1">Enter "all" for all looms</p>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="form-group">
                            <label class="block text-gray-700 mb-1 font-semibold">From Date</label>
                            <input type="date" name="from_date" id="report_from_date" required max="2100-12-31" min="2000-01-01" 
                                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-400 focus:border-indigo-400 transition duration-200 shadow-sm">
                        </div>
                        <div class="form-group">
                            <label class="block text-gray-700 mb-1 font-semibold">To Date</label>
                            <input type="date" name="to_date" id="report_to_date" required max="2100-12-31" min="2000-01-01" 
                                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-400 focus:focus:border-indigo-400 transition duration-200 shadow-sm">
                        </div>
                    </div>

                    <button type="submit" id="generateReportBtn" class="btn btn-primary w-full py-3 px-4 rounded-lg flex items-center justify-center text-lg">
                        <span id="generateReportBtnText">Generate Report</span><span id="generateReportSpinner" class="spinner hidden"></span>
                    </button>
                </form>

                <div id="resultContainer" class="mt-8 hidden">
                    <div class="bg-indigo-50 p-5 rounded-lg border border-indigo-200 shadow-md">
                        <h3 class="font-bold text-indigo-800 text-xl mb-3">Total Production Summary</h3>
                        <!-- Removed conditional coloring from here as per user request -->
                        <p class="text-2xl font-extrabold text-indigo-600 mb-2">Meters: <span id="totalMeters">0</span></p>
                        <p class="text-2xl font-extrabold text-indigo-600">Salary: â‚¹<span id="totalSalary">0.00</span></p>
                        <p class="text-sm text-gray-600 mt-2">for the selected criteria</p>
                    </div>
                </div>

                <!-- Report Tabs -->
                <div class="mt-8">
                    <div class="flex border-b border-gray-200 mb-6">
                        <button type="button" class="tab-button active" data-tab="detailedRecords">Detailed Records</button>
                        <button type="button" class="tab-button" data-tab="loomSubtotals">Subtotals Per Loom</button>
                        <button type="button" class="tab-button" data-tab="dailySubtotals">Subtotals Per Day</button>
                    </div>

                    <!-- Tab Content: Detailed Records -->
                    <div id="detailedRecordsTabContent" class="tab-content">
                        <h3 class="font-bold text-indigo-800 text-xl mb-4 border-b-2 border-indigo-200 pb-2">Detailed Records</h3>
                        <div id="reportTable" class="overflow-x-auto">
                            </div>
                        <p id="noRecordsMessage" class="text-gray-600 text-center mt-6 hidden">No records found for the selected criteria.</p>
                        
                        <button id="downloadPdfBtn" class="btn bg-red-600 text-white py-3 px-4 rounded-lg hover:bg-red-700 mt-6 w-full text-lg shadow-md">
                            Download Report as PDF
                        </button>
                    </div>

                    <!-- Tab Content: Loom Subtotals -->
                    <div id="loomSubtotalsTabContent" class="tab-content hidden">
                        <h3 class="font-bold text-indigo-800 text-xl mb-4 border-b-2 border-indigo-200 pb-2">Subtotals Per Loom</h3>
                        <div id="loomSubtotalsTable" class="overflow-x-auto">
                            <!-- Subtotals table will be rendered here by JavaScript -->
                        </div>
                    </div>

                    <!-- Tab Content: Daily Subtotals -->
                    <div id="dailySubtotalsTabContent" class="tab-content hidden">
                        <h3 class="font-bold text-indigo-800 text-xl mb-4 border-b-2 border-indigo-200 pb-2">Subtotals Per Day</h3>
                        <div id="dailySubtotalsTable" class="overflow-x-auto">
                            <!-- Daily subtotals table will be rendered here by JavaScript -->
                        </div>
                    </div>
                </div>

            </section>

            <!-- Section: Production Graphs -->
            <section id="graphsSection" class="main-content-section bg-white p-8 rounded-lg shadow-xl mb-8 hidden">
                <h2 class="text-2xl font-bold mb-6 text-indigo-700 border-b-2 border-indigo-200 pb-3">Production Graphs</h2>
                <form id="graphQueryForm" class="space-y-5">
                    <div class="form-group">
                        <label class="block text-gray-700 mb-1 font-semibold">Loomer Name</label>
                        <input type="text" name="loomer_name" id="graph_loomer_name" required 
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-400 focus:border-indigo-400 transition duration-200 shadow-sm">
                        <p class="text-xs text-gray-500 mt-1">Enter "all" for all loomers (Admin only)</p>
                    </div>

                    <div class="form-group">
                        <label class="block text-gray-700 mb-1 font-semibold">Period</label>
                        <select name="period" id="graphPeriod" required 
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-400 focus:border-indigo-400 transition duration-200 shadow-sm">
                            <option value="day">Daily</option>
                            <option value="week">Weekly</option>
                            <option value="month">Monthly</option>
                            <option value="year">Yearly</option>
                        </select>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="form-group">
                            <label class="block text-gray-700 mb-1 font-semibold">From Date</label>
                            <input type="date" name="from_date" id="graph_from_date" required max="2100-12-31" min="2000-01-01" 
                                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-400 focus:border-indigo-400 transition duration-200 shadow-sm">
                        </div>
                        <div class="form-group">
                            <label class="block text-gray-700 mb-1 font-semibold">To Date</label>
                            <input type="date" name="to_date" id="graph_to_date" required max="2100-12-31" min="2000-01-01" 
                                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-400 focus:focus:border-indigo-400 transition duration-200 shadow-sm">
                        </div>
                    </div>

                    <button type="submit" id="generateGraphBtn" class="btn btn-primary w-full py-3 px-4 rounded-lg flex items-center justify-center text-lg">
                        <span id="generateGraphBtnText">Generate Graph</span><span id="generateGraphSpinner" class="spinner hidden"></span>
                    </button>
                </form>

                <div class="mt-6">
                    <canvas id="productionChart"></canvas>
                    <p id="noGraphDataMessage" class="text-gray-600 text-center mt-4 hidden">No data found for the selected graph criteria.</p>
                </div>
            </section>

            <!-- Section: Admin Tools -->
            <section id="adminSection" class="main-content-section mt-10 bg-white p-8 rounded-lg shadow-xl hidden">
                <h2 class="text-2xl font-bold mb-6 text-indigo-700 border-b-2 border-indigo-200 pb-3">Admin Tools</h2>
                
                <!-- Admin Tabs -->
                <div class="flex border-b border-gray-200 mb-6">
                    <button type="button" class="tab-button active" data-tab="addUser">Add User</button>
                    <button type="button" class="tab-button" data-tab="updatePassword">Update Password</button>
                    <button type="button" class="tab-button" data-tab="removeUser">Remove User</button>
                    <button type="button" class="tab-button" data-tab="removeLoomData">Remove Loom Data</button>
                    <button type="button" class="tab-button" data-tab="listUsers">List All Users</button>
                    <button type="button" class="tab-button" data-tab="warpManagement">Warp Management</button> <!-- New Warp Tab -->
                </div>

                <!-- Tab Content: Add New User -->
                <div id="addUserTabContent" class="tab-content">
                    <h3 class="text-xl font-semibold text-indigo-600 mb-4">Add New User</h3>
                    <form id="addUserForm" class="space-y-4">
                        <div class="form-group">
                            <label class="block text-gray-700 mb-1 font-semibold">Username</label>
                            <input type="text" name="username" id="newUsernameInput" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-400 focus:border-indigo-400 transition duration-200 shadow-sm">
                        </div>
                        <div class="form-group">
                            <label class="block text-gray-700 mb-1 font-semibold">Password</label>
                            <input type="password" name="password" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-400 focus:border-indigo-400 transition duration-200 shadow-sm">
                        </div>
                        <div class="form-group">
                            <label class="block text-gray-700 mb-1 font-semibold">Role</label>
                            <select name="role" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-400 focus:border-indigo-400 transition duration-200 shadow-sm">
                                <option value="">-- Select Role --</option>
                                <option value="loomer">Loomer</option>
                                <option value="admin">Admin</option>
                            </select>
                        </div>
                        <button type="submit" id="addUserBtn" class="btn bg-green-600 text-white py-3 px-4 rounded-lg hover:bg-green-700 flex items-center justify-center text-lg shadow-md">
                            <span id="addUserBtnText">Add User</span><span id="addUserSpinner" class="spinner hidden"></span>
                        </button>
                    </form>
                </div>

                <!-- Tab Content: Update User Password -->
                <div id="updatePasswordTabContent" class="tab-content hidden">
                    <h3 class="text-xl font-semibold text-indigo-600 mb-4">Update User Password</h3>
                    <form id="updatePasswordForm" class="space-y-4">
                        <div class="form-group">
                            <label class="block text-gray-700 mb-1 font-semibold">Username to Update</label>
                            <input type="text" name="username" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-400 focus:border-indigo-400 transition duration-200 shadow-sm">
                        </div>
                        <div class="form-group">
                            <label class="block text-gray-700 mb-1 font-semibold">New Password</label>
                            <input type="password" name="new_password" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-400 focus:border-indigo-400 transition duration-200 shadow-sm">
                        </div>
                        <div class="form-group">
                            <label class="block text-gray-700 mb-1 font-semibold">Confirm New Password</label>
                            <input type="password" name="confirm_password" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-400 focus:border-indigo-400 transition duration-200 shadow-sm">
                        </div>
                        <button type="submit" id="updatePasswordBtn" class="btn bg-blue-600 text-white py-3 px-4 rounded-lg hover:bg-blue-700 flex items-center justify-center text-lg shadow-md">
                            <span id="updatePasswordBtnText">Update Password</span><span id="updatePasswordSpinner" class="spinner hidden"></span>
                        </button>
                    </form>
                </div>

                <!-- Tab Content: Remove User -->
                <div id="removeUserTabContent" class="tab-content hidden">
                    <h3 class="text-xl font-semibold text-indigo-600 mb-4">Remove User</h3>
                    <form id="removeUserForm" class="space-y-4">
                        <div class="form-group">
                            <label class="block text-gray-700 mb-1 font-semibold">Username to Remove</label>
                            <input type="text" name="username" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-400 focus:border-indigo-400 transition duration-200 shadow-sm">
                        </div>
                        <button type="submit" id="removeUserBtn" class="btn bg-red-600 text-white py-3 px-4 rounded-lg hover:bg-red-700 flex items-center justify-center text-lg shadow-md">
                            <span id="removeUserBtnText">Remove User</span><span id="removeUserSpinner" class="spinner hidden"></span>
                        </button>
                    </form>
                </div>

                <!-- Tab Content: Remove Loom Data -->
                <div id="removeLoomDataTabContent" class="tab-content hidden">
                    <h3 class="text-xl font-semibold text-indigo-600 mb-4">Remove Loom Data</h3>
                    <p class="text-sm text-gray-600 mb-3">Specify criteria to remove matching loom data records. At least 'Loomer Name' or a 'Date Range' is required.</p>
                    <form id="removeLoomDataForm" class="space-y-4">
                        <div class="form-group">
                            <label class="block text-gray-700 mb-1 font-semibold">Loomer Name</label>
                            <input type="text" name="loomer_name" id="remove_data_loomer_name"
                                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-400 focus:border-indigo-400 transition duration-200 shadow-sm">
                            <p class="text-xs text-gray-500 mt-1">Leave empty to not filter by loomer name.</p>
                        </div>

                        <div class="form-group">
                            <label class="block text-gray-700 mb-1 font-semibold">Loom Number</label>
                            <input type="text" name="loom_number" id="remove_data_loom_number" value=""
                                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-400 focus:border-indigo-400 transition duration-200 shadow-sm">
                            <p class="text-xs text-gray-500 mt-1">Leave empty to not filter by loom number.</p>
                        </div>

                        <div class="form-group">
                            <label class="block text-gray-700 mb-1 font-semibold">Shift</label>
                            <select name="shift" id="remove_data_shift"
                                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-400 focus:border-indigo-400 transition duration-200 shadow-sm">
                                <option value="">-- Any Shift --</option>
                                <option value="Morning">Morning</option>
                                <option value="Night">Night</option>
                            </select>
                            <p class="text-xs text-gray-500 mt-1">Leave as "Any Shift" to not filter by shift.</p>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="form-group">
                                <label class="block text-gray-700 mb-1 font-semibold">From Date</label>
                                <input type="date" name="from_date" id="remove_from_date" max="2100-12-31" min="2000-01-01" 
                                       class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-400 focus:border-indigo-400 transition duration-200 shadow-sm">
                            </div>
                            <div class="form-group">
                                <label class="block text-gray-700 mb-1 font-semibold">To Date</label>
                                <input type="date" name="to_date" id="remove_to_date" max="2100-12-31" min="2000-01-01" 
                                       class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-400 focus:focus:border-indigo-400 transition duration-200 shadow-sm">
                            </div>
                        </div>
                        <p class="text-xs text-gray-500 mt-1">Both dates must be selected for date range filtering.</p>
                        <button type="submit" id="removeDataBtn" class="btn bg-red-700 text-white py-3 px-4 rounded-lg hover:bg-red-800 flex items-center justify-center text-lg shadow-md">
                            <span id="removeDataBtnText">Remove Data</span><span id="removeDataSpinner" class="spinner hidden"></span>
                        </button>
                    </form>
                </div>

                <!-- Tab Content: All Users List -->
                <div id="listUsersTabContent" class="tab-content hidden">
                    <h3 class="text-xl font-semibold text-indigo-600 mb-4">All Users</h3>
                    <button type="button" id="refreshUsersBtn" class="btn bg-blue-600 text-white py-3 px-4 rounded-lg hover:bg-blue-700 mb-4 flex items-center justify-center text-lg shadow-md">
                        <span id="refreshUsersBtnText">Refresh User List</span><span id="refreshUsersSpinner" class="spinner hidden"></span>
                    </button>
                    <div id="usersListContainer" class="overflow-x-auto">
                        <table id="usersTable" class="min-w-full bg-white rounded-lg shadow-md hidden">
                            <thead>
                                <tr>
                                    <th class="px-4 py-2 text-indigo-700">Username</th>
                                    <th class="px-4 py-2 text-indigo-700">Role</th>
                                    <th class="px-4 py-2 text-indigo-700">ID</th>
                                </tr>
                            </thead>
                            <tbody id="usersTableBody">
                                </tbody>
                        </table>
                        <p id="noUsersMessage" class="text-gray-600 text-center mt-4 hidden">No users found.</p>
                    </div>
                </div>

                <!-- NEW Tab Content: Warp Management -->
                <div id="warpManagementTabContent" class="tab-content hidden">
                    <h3 class="text-xl font-semibold text-indigo-600 mb-4">Warp Management</h3>
                    
                    <!-- Current Total Warp Display -->
                    <div class="mb-6 bg-indigo-50 p-4 rounded-md flex justify-between items-center shadow-md">
                        <p class="text-lg font-medium text-indigo-700">Current Total Warp (Count):</p>
                        <span id="currentTotalWarp" class="text-2xl font-bold text-indigo-900">0</span>
                    </div>

                    <!-- Update Total Warp Form -->
                    <div class="mb-8 p-6 border border-gray-200 rounded-lg shadow-sm">
                        <h3 class="text-lg font-semibold mb-3 text-gray-800">Update Total Warp</h3>
                        <form id="updateWarpForm" class="flex flex-col gap-4">
                            <div class="form-group">
                                <label for="warpUpdateValue" class="block text-sm font-medium text-gray-700">Warp Change (Count):</label>
                                <input type="number" id="warpUpdateValue" name="value" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2" placeholder="e.g., 500 or -100" required>
                            </div>
                            <div class="form-group">
                                <label for="warpUpdateDate" class="block text-sm font-medium text-gray-700">Date:</label>
                                <input type="date" id="warpUpdateDate" name="date" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2" required>
                            </div>
                            <div class="form-group">
                                <label for="warpUpdateRemarks" class="block text-sm font-medium text-gray-700">Remarks (Optional):</label>
                                <textarea id="warpUpdateRemarks" name="remarks" rows="2" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2" placeholder="Reason for update"></textarea>
                            </div>
                            <button type="submit" id="updateWarpBtn" class="btn bg-indigo-600 text-white py-2 px-4 rounded-lg hover:bg-indigo-700 flex items-center justify-center text-lg shadow-md">
                                <span id="updateWarpBtnText">Update Warp</span><span id="updateWarpSpinner" class="spinner hidden"></span>
                            </button>
                        </form>
                    </div>

                    <!-- Knotting Count Form -->
                    <div class="mb-8 p-6 border border-gray-200 rounded-lg shadow-sm">
                        <h3 class="text-lg font-semibold mb-3 text-gray-800">Generate Knotting Count</h3>
                        <form id="applyKnottingForm" class="flex flex-col gap-4">
                            <div class="form-group">
                                <label for="knottingCountValue" class="block text-sm font-medium text-gray-700">Knotting Count (Count to subtract):</label>
                                <input type="number" id="knottingCountValue" name="knotting_value" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2" placeholder="e.g., 200" min="0" required>
                            </div>
                            <div class="form-group">
                                <label for="knottingDate" class="block text-sm font-medium text-gray-700">Date:</label>
                                <input type="date" id="knottingDate" name="date" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2" required>
                            </div>
                            <div class="form-group">
                                <label for="knottingRemarks" class="block text-sm font-medium text-gray-700">Remarks (Optional):</label>
                                <textarea id="knottingRemarks" name="remarks" rows="2" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2" placeholder="Loom number, reason for knotting, etc."></textarea>
                            </div>
                            <button type="submit" id="applyKnottingBtn" class="btn bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700 flex items-center justify-center text-lg shadow-md">
                                <span id="applyKnottingBtnText">Generate Knotting</span><span id="applyKnottingSpinner" class="spinner hidden"></span>
                            </button>
                        </form>
                    </div>

                    <!-- Knotting Calculation Result Display -->
                    <div id="knottingResultDisplay" class="hidden mb-8 p-6 bg-yellow-50 border border-yellow-200 rounded-lg shadow-sm">
                        <h3 class="text-lg font-semibold mb-3 text-gray-800">Calculated Warp After Knotting:</h3>
                        <p class="text-2xl font-bold text-yellow-800"><span id="calculatedRemainingWarp">0.00</span></p>
                        <p class="text-sm text-gray-600 mt-2">This value is for display only and does not alter the total warp.</p>
                    </div>

                    <!-- Warp Update History -->
                    <div class="p-6 border border-gray-200 rounded-lg shadow-sm">
                        <h3 class="text-lg font-semibold mb-3 text-gray-800">Warp Update History</h3>
                        <div id="warpHistoryTableContainer" class="overflow-x-auto">
                            <table id="warpHistoryTable" class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">User</th>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Type</th>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Change</th>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">New Total</th>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Remarks</th>
                                    </tr>
                                </thead>
                                <tbody id="warpHistoryTableBody" class="bg-white divide-y divide-gray-200">
                                    <!-- History records will be loaded here by JavaScript -->
                                    <tr><td colspan="6" class="px-4 py-2 text-center text-gray-500">Loading history...</td></tr>
                                </tbody>
                            </table>
                        </div>
                        <p id="noWarpHistoryMessage" class="hidden text-center text-gray-500 mt-4">No warp update history found.</p>
                        <button type="button" id="clearWarpHistoryBtn" class="btn bg-red-600 text-white py-2 px-4 rounded-lg hover:bg-red-700 mt-6 w-full text-lg shadow-md">
                            <span id="clearWarpHistoryBtnText">Clear Warp History</span><span id="clearWarpHistorySpinner" class="spinner hidden"></span>
                        </button>
                    </div>
                </div>
            </section>
        </div>
    </div>

    <script>
        const { jsPDF } = window.jspdf;
        let productionChartInstance = null; // To store the Chart.js instance
        let lastReportData = null; // To store the last fetched report data for PDF generation
        let currentWarpValue = 0; // Global variable to store current total warp

        const notifications = {
            dataAddedSuccess: "Data added successfully!",
            failedToAddData: "Failed to add data (server reported an issue)",
            reportGeneratedSuccess: "Report generated successfully!",
            reportDownloaded: "Report downloaded as PDF!",
            sessionExpired: "Session expired or not authorized. Please log in.",
            notAuthorizedAdmin: "Session expired or not authorized. Please log in as an Admin.",
            networkError: "A network error occurred or client-side processing failed.",
            missingRequiredFields: "Missing required fields:",
            loomerNameRequired: "Loomer Name is required to generate a report.",
            invalidUsernameOrPassword: "Invalid username or password.",
            loginFailed: "Login failed.",
            logoutSuccess: "Logged out successfully.",
            logoutFailed: "Failed to log out.",
            userAddedSuccess: "User added successfully.",
            failedToAddUser: "Failed to add user.",
            userExists: "User with this username already exists.",
            userRemovedSuccess: "User removed successfully.",
            userNotFound: "User not found.",
            failedToRemoveUser: "Failed to remove user.",
            cannotRemoveSelf: "Cannot remove your own admin account.",
            failedToFetchUsers: "Failed to fetch users.",
            removeDataConfirm: "Are you sure you want to remove data based on the specified criteria? This action cannot be undone.",
            removeDataSuccess: "records removed successfully.", 
            noMatchingRecords: "No matching records found to remove.",
            loomerNameOrDateRangeRequired: "At least 'Loomer Name' or a 'Date Range' is required to remove data. To remove all data for a loomer, enter their name and leave other fields as 'all'.",
            fromDateAfterToDate: "From Date cannot be after To Date for removal.",
            invalidDateFormat: "Invalid date format.",
            bothDatesRequired: "Both From Date and To Date are required for date-based removal.",
            failedToRemoveData: "Failed to remove data. An internal error occurred.",
            passwordMismatch: "New password and confirm password do not match.",
            passwordUpdateSuccess: "User password updated successfully!",
            passwordUpdateFailed: "Failed to update password.",
            userNotFoundForPasswordUpdate: "User not found for password update.",
            graphGeneratedSuccess: "Graph generated successfully!",
            noGraphDataFound: "No data found for the selected graph criteria.",
            warpUpdateSuccess: "Warp updated successfully!",
            failedToUpdateWarp: "Failed to update warp.",
            knottingAppliedSuccess: "Knotting calculation successful!", // Updated message
            failedToApplyKnotting: "Failed to perform knotting calculation.", // Updated message
            invalidWarpValue: "Please enter a valid number for warp change.",
            invalidKnottingValue: "Please enter a valid non-negative number for knotting count.",
            noRecordsFound: "No records found for the selected criteria.", 
            warpHistoryCleared: "Warp history cleared successfully!",
            failedToClearWarpHistory: "Failed to clear warp history.",
            confirmClearWarpHistory: "Are you sure you want to clear ALL warp history? This action cannot be undone."
        };

        function showNotification(messageKey, type = 'success', params = {}) {
            const notification = document.getElementById('notification');
            if (!notification) {
                console.error("Notification element not found!");
                return;
            }
            const messageSpan = notification.querySelector('span');
            if (!messageSpan) {
                console.error("Notification message span not found!");
                return;
            }

            notification.className = ``; // Reset classes
            notification.classList.add(type);
            
            let message = notifications[messageKey] || messageKey; 

            if (params.count !== undefined) {
                message = `${params.count} ${message}`; 
            }
            if (params.fields) {
                message = `${message} ${params.fields}`; 
            }

            messageSpan.textContent = message;
            notification.classList.remove('hidden');
            notification.classList.add('show');

            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => notification.classList.add('hidden'), 400); // Hide after transition
            }, 3000);
        }

        /**
         * Shows a specific content section and hides all other main sections.
         * Also manages active state of navigation links.
         * @param {string} sectionId The ID of the section to show.
         */
        function showSection(sectionId) {
            console.log(`Activating section: ${sectionId}`); // Log for debugging
            const sections = ['dataEntrySection', 'reportSection', 'graphsSection', 'adminSection']; 

            sections.forEach(id => {
                const section = document.getElementById(id);
                if (section) {
                    if (id === sectionId) {
                        section.classList.remove('hidden');
                    } else {
                        section.classList.add('hidden');
                    }
                }
            });

            // Update active navigation link
            document.querySelectorAll('nav ul li a').forEach(link => {
                link.classList.remove('nav-item-active'); // Remove from all links
                console.log(`Removed active from: ${link.id}`); // Debugging
            });
            
            // For the main navigation links (Enter Data, Reports, Graphs, Admin Tools)
            const activeLink = document.querySelector(`nav ul li a[id="nav${sectionId.replace('Section', '')}"]`);
            if (activeLink) {
                activeLink.classList.add('nav-item-active');
                console.log(`Added active to: ${activeLink.id}`);
            }


            // If admin section is shown, activate its default tab
            if (sectionId === 'adminSection') {
                activateAdminTab('addUser'); // Default to Add User tab
            }
            // If report section is shown, activate its default tab
            if (sectionId === 'reportSection') {
                activateReportTab('detailedRecords'); // Default to Detailed Records tab
            }
            // Warp section content is now part of admin tools, so its data fetching is tied to admin tab activation
        }

        /**
         * Manages the active state of admin tool tabs.
         * @param {string} tabId The ID of the tab to activate (e.g., 'addUser', 'updatePassword').
         */
        function activateAdminTab(tabId) {
            document.querySelectorAll('#adminSection .tab-button').forEach(button => {
                if (button.dataset.tab === tabId) {
                    button.classList.add('active');
                } else {
                    button.classList.remove('active');
                }
            });

            document.querySelectorAll('#adminSection .tab-content').forEach(content => {
                if (content.id === `${tabId}TabContent`) {
                    content.classList.remove('hidden');
                } else {
                    content.classList.add('hidden');
                }
            });

            // Special handling for List Users tab to refresh data when shown
            if (tabId === 'listUsers') {
                fetchUsers();
            } else if (tabId === 'warpManagement') { // New: Fetch warp data when warp management tab is activated
                fetchCurrentTotalWarp();
                fetchWarpHistory();
                document.getElementById('knottingResultDisplay').classList.add('hidden'); // Hide knotting result on tab change
            }
        }

        /**
         * Manages the active state of report section tabs.
         * @param {string} tabId The ID of the tab to activate (e.g., 'detailedRecords', 'loomSubtotals').
         */
        function activateReportTab(tabId) {
            document.querySelectorAll('#reportSection .tab-button').forEach(button => {
                if (button.dataset.tab === tabId) {
                    button.classList.add('active');
                } else {
                    button.classList.remove('active');
                }
            });

            document.querySelectorAll('#reportSection .tab-content').forEach(content => {
                if (content.id === `${tabId}TabContent`) {
                    content.classList.remove('hidden');
                } else {
                    content.classList.add('hidden');
                }
            });
        }


        // Custom Confirmation Modal (replaces window.confirm)
        function showCustomConfirm(message) {
            return new Promise((resolve) => {
                const modalHtml = `
                    <div id="customConfirmModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50">
                        <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full">
                            <p class="text-lg font-semibold text-gray-800 mb-4">${message}</p>
                            <div class="flex justify-end space-x-4">
                                <button id="confirmCancelBtn" class="px-4 py-2 bg-gray-300 text-gray-800 rounded-lg hover:bg-gray-400 transition">Cancel</button>
                                <button id="confirmOkBtn" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition">OK</button>
                            </div>
                        </div>
                    </div>
                `;
                document.body.insertAdjacentHTML('beforeend', modalHtml);

                const modal = document.getElementById('customConfirmModal');
                document.getElementById('confirmOkBtn').addEventListener('click', () => {
                    modal.remove();
                    resolve(true);
                });
                document.getElementById('confirmCancelBtn').addEventListener('click', () => {
                    modal.remove();
                    resolve(false);
                });
            });
        }


        document.addEventListener('DOMContentLoaded', async () => {
            // These variables are passed from Flask's render_template
            const username = "{{ username | default('') }}";
            const role = "{{ role | default('') }}";

            console.log("DOM Loaded. Username:", username, "Role:", role); 

            if (username && role) {
                const currentUsernameSpan = document.getElementById('currentUsername');
                const currentUserRoleSpan = document.getElementById('currentUserRole');

                if (currentUsernameSpan && currentUserRoleSpan) {
                    currentUsernameSpan.textContent = username;
                    currentUserRoleSpan.textContent = role;
                } else {
                    console.error("Required span elements for username/role (currentUsername, currentUserRole) not found!"); 
                }
                
                const dataEntrySection = document.getElementById('dataEntrySection');
                const reportSection = document.getElementById('reportSection');
                const graphsSection = document.getElementById('graphsSection');
                const adminSection = document.getElementById('adminSection');
                const navAdminLink = document.getElementById('navAdminLink');
                const navHomeLink = document.getElementById('navHomeLink'); // Get the 'Enter Data' list item
                
                const dataLoomerNameInput = document.getElementById('data_loomer_name'); // New ID
                const reportLoomerNameInput = document.getElementById('report_loomer_name'); // New ID
                const loomerNameReportHint = document.getElementById('loomerNameReportHint');
                const graphLoomerNameInput = document.getElementById('graph_loomer_name'); // New ID

                let initialSection = 'reportSection'; // Default for loomers

                if (role === 'admin') {
                    navAdminLink.classList.remove('hidden');
                    navHomeLink.classList.remove('hidden'); // Ensure 'Enter Data' is visible for admin
                    
                    dataLoomerNameInput.readOnly = false;
                    dataLoomerNameInput.value = ''; 

                    reportLoomerNameInput.readOnly = false;
                    reportLoomerNameInput.value = 'all'; 
                    loomerNameReportHint.classList.remove('hidden');

                    graphLoomerNameInput.readOnly = false;
                    graphLoomerNameInput.value = 'all'; 
                    initialSection = 'dataEntrySection'; // Admin's default view
                } else if (role === 'loomer') {
                    dataEntrySection.classList.add('hidden'); // Loomers don't add data
                    adminSection.classList.add('hidden'); 
                    navAdminLink.classList.add('hidden'); 
                    navHomeLink.classList.add('hidden'); // Hide 'Enter Data' nav link for loomers

                    dataLoomerNameInput.value = username; 
                    dataLoomerNameInput.readOnly = true; 

                    reportLoomerNameInput.value = username; 
                    reportLoomerNameInput.readOnly = true; 
                    loomerNameReportHint.classList.add('hidden'); 

                    graphLoomerNameInput.value = username; 
                    graphLoomerNameInput.readOnly = true; 
                    initialSection = 'reportSection'; // Loomer's default view
                }
                
                // Set default date for all date input fields to today's date
                const today = new Date().toISOString().split('T')[0];
                // Ensure IDs are correct for these inputs
                const dataDateInput = document.getElementById('data_date'); 
                if (dataDateInput) dataDateInput.value = today;
                const reportFromDateInput = document.getElementById('report_from_date');
                const reportToDateInput = document.getElementById('report_to_date');
                if (reportFromDateInput) reportFromDateInput.value = today;
                if (reportToDateInput) reportToDateInput.value = today;

                const graphFromDateInput = document.getElementById('graph_from_date'); 
                const graphToDateInput = document.getElementById('graph_to_date'); 
                if (graphFromDateInput) graphFromDateInput.value = today;
                if (graphToDateInput) graphToDateInput.value = today;

                const removeFromDate = document.getElementById('remove_from_date');
                const removeToDate = document.getElementById('remove_to_date');
                if (removeFromDate) removeFromDate.value = today;
                if (removeToDate) removeToDate.value = today;

                // Set default date for new warp date inputs
                const warpUpdateDateInput = document.getElementById('warpUpdateDate');
                if (warpUpdateDateInput) warpUpdateDateInput.value = today;
                const knottingDateInput = document.getElementById('knottingDate');
                if (knottingDateInput) knottingDateInput.value = today;


                // Attach navigation event listeners
                const navHome = document.getElementById('navHome');
                if (navHome) { 
                    navHome.addEventListener('click', (e) => { e.preventDefault(); showSection('dataEntrySection'); });
                }
                document.getElementById('navReport').addEventListener('click', (e) => { e.preventDefault(); showSection('reportSection'); });
                document.getElementById('navGraphs').addEventListener('click', (e) => { e.preventDefault(); showSection('graphsSection'); });
                const navAdmin = document.getElementById('navAdmin');
                if (navAdmin) { 
                    navAdmin.addEventListener('click', (e) => { e.preventDefault(); showSection('adminSection'); /* fetchUsers() is called by activateAdminTab */ });
                }
                

                // Admin tab navigation
                document.querySelectorAll('#adminSection .tab-button').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const tabId = e.target.dataset.tab;
                        activateAdminTab(tabId);
                    });
                });

                // Report tab navigation
                document.querySelectorAll('#reportSection .tab-button').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const tabId = e.target.dataset.tab;
                        activateReportTab(tabId);
                    });
                });

                // Show the initial section determined by Flask
                showSection(initialSection);

            } else {
                console.log("Username or role missing in template. Redirecting to login."); 
                window.location.href = '/login'; 
            }
        });

        // Helper to toggle spinner visibility and button text
        function toggleSpinner(buttonId, show) { // Removed loadingText parameter as it's not used to change text
            const button = document.getElementById(buttonId);
            if (!button) {
                console.error(`Button with ID ${buttonId} not found.`);
                return;
            }
            // Select the span that holds the text (assuming it's the first span child)
            // and the spinner span (assuming it has the 'spinner' class)
            const buttonTextSpan = button.querySelector('span:not(.spinner)'); 
            const spinner = button.querySelector('.spinner');

            if (show) {
                if (buttonTextSpan) {
                    buttonTextSpan.classList.add('hidden'); // Hide the text span
                }
                if (spinner) {
                    spinner.classList.remove('hidden'); // Show the spinner
                }
                button.disabled = true;
                button.classList.add('opacity-75', 'cursor-not-allowed');
            } else {
                if (buttonTextSpan) {
                    buttonTextSpan.classList.remove('hidden'); // Show the text span
                }
                if (spinner) {
                    spinner.classList.add('hidden'); // Hide the spinner
                }
                button.disabled = false;
                button.classList.remove('opacity-75', 'cursor-not-allowed');
            }
        }


        // Helper to hide all main content sections
        function hideAllContentSections() {
            document.querySelectorAll('.main-content-section').forEach(section => {
                section.classList.add('hidden');
            });
            // Also hide specific containers that might persist
            document.getElementById('resultContainer').classList.add('hidden');
            document.getElementById('noRecordsMessage').classList.add('hidden');
            document.getElementById('reportTable').innerHTML = ''; // Clear previous report data
            document.getElementById('loomSubtotalsTable').innerHTML = '';
            document.getElementById('dailySubtotalsTable').innerHTML = '';
            // Clear graph if exists
            if (productionChartInstance) {
                productionChartInstance.destroy();
                productionChartInstance = null;
            }
            document.getElementById('noGraphDataMessage').classList.add('hidden');
        }


        document.getElementById('logoutBtn').addEventListener('click', async () => {
            toggleSpinner('logoutBtn', true); // No text needed, spinner replaces
            try {
                const response = await fetch('/logout', {
                    method: 'POST'
                });
                const data = await response.json();
                if (response.ok && data.status === 'success') {
                    showNotification('logoutSuccess', 'success');
                    window.location.href = '/login'; 
                } else {
                    showNotification('logoutFailed', 'error');
                }
            } catch (error) {
                showNotification('networkError', 'error');
                console.error('Logout error:', error);
            } finally {
                toggleSpinner('logoutBtn', false); // No text needed, spinner hides
            }
        });


        document.getElementById('dataEntryForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            toggleSpinner('submitDataBtn', true); // No text needed, spinner replaces
            
            try {
                const formData = new FormData(e.target);
                
                // --- Debugging: Log form data before sending ---
                const formDataObject = {};
                formData.forEach((value, key) => {
                    formDataObject[key] = value;
                });
                console.log("Submitting Loom Data:", formDataObject);
                // --- End Debugging ---

                const requiredFields = ["loomer_name", "loom_number", "shift", "meters", "salary_per_meter", "date"];
                const missingFields = requiredFields.filter(field => {
                    const value = formData.get(field);
                    return value === null || value.trim() === '';
                });

                if (missingFields.length > 0) {
                    showNotification('missingRequiredFields', 'error', { fields: missingFields.join(', ') });
                    toggleSpinner('submitDataBtn', false); // Ensure spinner is hidden on validation error
                    return;
                }

                const response = await fetch('/add_form', { 
                    method: 'POST',
                    body: formData 
                });
                
                if (response.status === 401 || response.status === 403) { 
                    showNotification('sessionExpired', 'error');
                    setTimeout(() => window.location.href = '/login', 1500); 
                    return;
                }

                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    const text = await response.text(); 
                    console.error('Server response was not JSON:', text);
                    showNotification('networkError', 'error'); 
                    return;
                }

                const data = await response.json();

                if (response.ok) {
                    if (data && data.status === 'success') {
                        showNotification('dataAddedSuccess', 'success');
                        // Removed: e.target.reset(); // Form will no longer clear automatically
                    } else {
                        showNotification(data.message || 'failedToAddData', 'error');
                    }
                } else {
                    showNotification(data.message || `networkError: ${response.status} - ${response.statusText}`, 'error');
                }
            } catch (error) {
                showNotification('networkError', 'error');
                console.error("Client-side Fetch Error:", error);
            } finally {
                toggleSpinner('submitDataBtn', false); // Spinner hides
            }
        });

        // Function to apply color based on meters
        function applyMeterColor(metersValue, element) {
            if (!element) return;

            // Remove all existing color classes related to meter ranges
            element.classList.remove('meters-red', 'meters-orange', 'meters-green', 'meters-dark-red');

            // Apply new color based on value
            if (metersValue >= 0 && metersValue <= 19) {
                element.classList.add('meters-red');
            } else if (metersValue >= 20 && metersValue <= 29) {
                element.classList.add('meters-orange');
            } else if (metersValue >= 30 && metersValue <= 37) {
                element.classList.add('meters-green');
            } else if (metersValue > 37) {
                element.classList.add('meters-dark-red');
            }
        }

        document.getElementById('dataQueryForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            toggleSpinner('generateReportBtn', true); // No text needed, spinner replaces
            
            try {
                const formData = new FormData(e.target);

                if (!formData.get('loomer_name') || formData.get('loomer_name').trim() === '') {
                    showNotification('loomerNameRequired', 'error');
                    toggleSpinner('generateReportBtn', false); // Ensure spinner hides
                    return;
                }

                // Check if the query is for a single day
                const fromDate = formData.get('from_date');
                const toDate = formData.get('to_date');
                const isSingleDayQuery = (fromDate === toDate);
                
                const response = await fetch('/get_meters', {
                    method: 'POST',
                    body: formData
                });
                
                if (response.status === 401 || response.status === 403) { 
                    showNotification('sessionExpired', 'error');
                    setTimeout(() => window.location.href = '/login', 1500);
                    return;
                }

                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    const text = await response.text(); 
                    console.error('Server response was not JSON:', text);
                    showNotification('networkError', 'error');
                    return;
                }

                const data = await response.json();
                lastReportData = data; // Store the data for PDF generation

                // --- Debugging: Log received report data ---
                console.log("Report data received:", data);
                // --- End Debugging ---

                const resultContainer = document.getElementById('resultContainer');
                const totalMetersSpan = document.getElementById('totalMeters');
                const totalSalarySpan = document.getElementById('totalSalary');
                const reportTableContainer = document.getElementById('detailedRecordsTabContent'); // Changed to tab content
                const reportTableDiv = document.getElementById('reportTable');
                const noRecordsMessage = document.getElementById('noRecordsMessage');
                const downloadPdfBtn = document.getElementById('downloadPdfBtn'); 
                const loomSubtotalsContainer = document.getElementById('loomSubtotalsTabContent'); // Changed to tab content
                const loomSubtotalsTableDiv = document.getElementById('loomSubtotalsTable');
                const dailySubtotalsContainer = document.getElementById('dailySubtotalsTabContent'); // Changed to tab content
                const dailySubtotalsTableDiv = document.getElementById('dailySubtotalsTable'); Â  Â  // New


                reportTableDiv.innerHTML = '';
                noRecordsMessage.classList.add('hidden');
                reportTableContainer.classList.add('hidden'); // Hide detailed records tab content by default
                resultContainer.classList.add('hidden'); 
                downloadPdfBtn.classList.add('hidden'); 
                loomSubtotalsContainer.classList.add('hidden'); // Hide subtotals tab content by default
                loomSubtotalsTableDiv.innerHTML = ''; // Clear previous subtotals
                dailySubtotalsContainer.classList.add('hidden'); // Hide daily subtotals tab content by default
                dailySubtotalsTableDiv.innerHTML = ''; // Clear previous daily subtotals

                if (response.ok) {
                    totalMetersSpan.textContent = data.total_meters || 0;
                    totalSalarySpan.textContent = parseFloat(data.total_salary || 0).toFixed(2);
                    resultContainer.classList.remove('hidden'); 

                    // Ensure main total meters span doesn't have conditional colors
                    totalMetersSpan.classList.remove('meters-red', 'meters-orange', 'meters-green', 'meters-dark-red');


                    if (data.records && data.records.length > 0) {
                        let tableHTML = `
                            <table id="productionTable" class="min-w-full bg-white rounded-lg shadow-md">
                                <thead>
                                    <tr>
                                        <th class="px-4 py-2 text-indigo-700">Loomer Name</th>
                                        <th class="px-4 py-2 text-indigo-700">Loom Number</th>
                                        <th class="px-4 py-2 text-indigo-700">Shift</th>
                                        <th class="px-4 py-2 text-indigo-700">Meters</th>
                                        <th class="px-4 py-2 text-indigo-700">Salary/Meter</th>
                                        <th class="px-4 py-2 text-indigo-700">Calculated Salary</th>
                                        <th class="px-4 py-2 text-indigo-700">Date</th>
                                    </tr>
                                </thead>
                                <tbody>
                        `;

                        data.records.forEach(record => {
                            const recordMeters = parseFloat(record.meters || 0);
                            const recordSalaryPerMeter = parseFloat(record.salary_per_meter || 0);
                            const calculatedRecordSalary = (recordMeters * recordSalaryPerMeter).toFixed(2);

                            tableHTML += `
                                <tr>
                                    <td class="px-4 py-2">${record.loomer_name || ''}</td>
                                    <td class="px-4 py-2">${record.loom_number || ''}</td>
                                    <td class="px-4 py-2">${record.shift || ''}</td>
                                    <td class="px-4 py-2"><span class="detailed-record-meters">${recordMeters}</span></td>
                                    <td class="px-4 py-2">â‚¹${recordSalaryPerMeter.toFixed(2)}</td>
                                    <td class="px-4 py-2">â‚¹${calculatedRecordSalary}</td>
                                    <td class="px-4 py-2">${record.date_formatted || ''}</td>
                                </tr>
                            `;
                        });

                        tableHTML += `
                                </tbody>
                            </table>
                        `;
                        reportTableDiv.innerHTML = tableHTML;
                        reportTableContainer.classList.remove('hidden'); 
                        downloadPdfBtn.classList.remove('hidden'); 
                        showNotification('reportGeneratedSuccess', 'success');

                        // Apply color to each meter value in detailed records
                        document.querySelectorAll('#reportTable .detailed-record-meters').forEach(span => {
                            applyMeterColor(parseInt(span.textContent), span);
                        });

                        // Render Loom Subtotals if available
                        if (data.loom_subtotals && data.loom_subtotals.length > 0) {
                            let subtotalsTableHTML = `
                                <table class="min-w-full bg-white rounded-lg shadow-md">
                                    <thead>
                                        <tr>
                                            <th class="px-4 py-2 text-indigo-700">Loom Number</th>
                                            <th class="px-4 py-2 text-indigo-700">Total Meters</th>
                                            <th class="px-4 py-2 text-indigo-700">Total Salary</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                            `;
                            data.loom_subtotals.forEach(subtotal => {
                                subtotalsTableHTML += `
                                    <tr>
                                        <td class="px-4 py-2">${subtotal.loom_number}</td>
                                        <td class="px-4 py-2"><span class="loom-subtotal-meters">${subtotal.total_meters}</span></td>
                                        <td class="px-4 py-2">â‚¹${subtotal.total_salary}</td>
                                    </tr>
                                `;
                            });
                            subtotalsTableHTML += `
                                    </tbody>
                                </table>
                            `;
                            loomSubtotalsTableDiv.innerHTML = subtotalsTableHTML;
                            // loomSubtotalsContainer.classList.remove('hidden'); // This will be handled by tab activation

                            // Apply color to each meter value in loom subtotals
                            document.querySelectorAll('#loomSubtotalsTable .loom-subtotal-meters').forEach(span => {
                                applyMeterColor(parseInt(span.textContent), span);
                            });
                        }

                        // Render Daily Subtotals if available and it's a multi-day query
                        if (data.daily_subtotals && data.daily_subtotals.length > 0) { // Removed isSingleDayQuery check here, as daily subtotals might be useful even for single day if user wants to see it
                            let dailySubtotalsTableHTML = `
                                <table class="min-w-full bg-white rounded-lg shadow-md">
                                    <thead>
                                        <tr>
                                            <th class="px-4 py-2 text-indigo-700">Date</th>
                                            <th class="px-4 py-2 text-indigo-700">Total Meters</th>
                                            <th class="px-4 py-2 text-indigo-700">Total Salary</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                            `;
                            data.daily_subtotals.forEach(subtotal => {
                                dailySubtotalsTableHTML += `
                                    <tr>
                                        <td class="px-4 py-2">${subtotal.date}</td>
                                        <td class="px-4 py-2"><span class="daily-subtotal-meters">${subtotal.total_meters}</span></td>
                                        <td class="px-4 py-2">â‚¹${subtotal.total_salary}</td>
                                    </tr>
                                `;
                            });
                            dailySubtotalsTableHTML += `
                                    </tbody>
                                </table>
                            `;
                            dailySubtotalsTableDiv.innerHTML = dailySubtotalsTableHTML;
                            // dailySubtotalsContainer.classList.remove('hidden'); // This will be handled by tab activation

                            // Apply color to each meter value in daily subtotals
                            document.querySelectorAll('#dailySubtotalsTable .daily-subtotal-meters').forEach(span => {
                                applyMeterColor(parseInt(span.textContent), span);
                            });
                        }


                    } else {
                        noRecordsMessage.classList.remove('hidden'); 
                        showNotification('noRecordsFound', 'info');
                    }

                } else {
                    showNotification(data.message || `networkError: ${response.status} - ${response.statusText}`, 'error');
                }
            } catch (error) {
                showNotification('networkError', 'error');
                console.error("Client-side Fetch Error:", error);
            } finally {
                toggleSpinner('generateReportBtn', false); // Spinner hides
            }
        });


        document.getElementById('downloadPdfBtn').addEventListener('click', () => {
            const productionTable = document.getElementById('productionTable');

            // --- IMPORTANT: Added check for productionTable existence ---
            if (!productionTable) {
                showNotification('Please generate a report first before downloading the PDF.', 'info');
                return; // Stop execution if table is not found
            }
            // --- End of added check ---

            const doc = new jsPDF('p', 'pt', 'a4');

            const loomerName = document.querySelector('#dataQueryForm input[name="loomer_name"]').value;
            const fromDate = document.querySelector('#dataQueryForm input[name="from_date"]').value;
            const toDate = document.querySelector('#dataQueryForm input[name="to_date"]').value;

            doc.setFont('helvetica');

            doc.setFontSize(18);
            doc.text(`Powerloom Production Report for ${loomerName}`, 40, 40);
            doc.setFontSize(12);
            doc.text(`From: ${fromDate} To: ${toDate}`, 40, 60);

            const totalMeters = document.getElementById('totalMeters').textContent;
            const totalSalary = document.getElementById('totalSalary').textContent;
            
            doc.setFontSize(16); 
            doc.setFont('helvetica', 'bold'); 
            doc.text(`Total Meters: ${totalMeters}`, 40, 80); 
            doc.text(`Total Salary: â‚¹${totalSalary}`, 40, 100); 
            doc.setFontSize(12); 
            doc.setFont('helvetica', 'normal'); 

            // Define table headers for autoTable in pure English
            const tableHeaders = [
                `Loomer Name`,
                `Loom Number`,
                `Shift`,
                `Meters`,
                `Salary/Meter`,
                `Calculated Salary`,
                `Date`
            ];

            const tableRows = productionTable.querySelectorAll('tbody tr');
            const tableData = [];
            tableRows.forEach(row => {
                const rowData = [];
                // Extract text content from each cell, including the span for meters
                row.querySelectorAll('td').forEach((cell, index) => {
                    if (index === 3) { // Meters column
                        const span = cell.querySelector('.detailed-record-meters');
                        rowData.push(span ? span.textContent.trim() : '');
                    } else {
                        rowData.push(cell.textContent.trim());
                    }
                });
                tableData.push(rowData);
            });


            doc.autoTable({
                head: [tableHeaders], 
                body: tableData, Â  Â 
                startY: 140, 
                theme: 'striped', 
                styles: {
                    font: 'helvetica', 
                    fontSize: 10,
                    cellPadding: 5,
                    overflow: 'linebreak',
                    lineWidth: 0.5,
                    lineColor: [200, 200, 200]
                },
                headStyles: {
                    fillColor: [79, 70, 229], 
                    textColor: [255, 255, 255],
                    fontStyle: 'bold'
                },
                alternateRowStyles: {
                    fillColor: [248, 250, 252] 
                },
                didParseCell: function(data) {
                    if (data.column.index === 4 || data.column.index === 5) {
                        let value = data.cell.text[0]; 
                        const numericValue = parseFloat(value.replace(/[^0-9.]/g, '')); 
                        
                        if (!isNaN(numericValue)) {
                            data.cell.text = [`â‚¹${numericValue.toFixed(2)}`]; 
                        } else {
                            data.cell.text = ['â‚¹0.00']; 
                        }
                    }
                },
            });

            // Add Loom Subtotals to PDF if available
            const loomSubtotalsData = lastReportData ? lastReportData.loom_subtotals : []; 

            if (loomSubtotalsData && loomSubtotalsData.length > 0) {
                doc.addPage(); // Start a new page for subtotals
                doc.setFontSize(18);
                doc.text(`Loom Subtotals for ${loomerName}`, 40, 40);
                doc.setFontSize(12);
                doc.text(`From: ${fromDate} To: ${toDate}`, 40, 60);

                const subtotalHeaders = [
                    `Loom Number`,
                    `Total Meters`,
                    `Total Salary`
                ];
                const subtotalRows = loomSubtotalsData.map(s => [s.loom_number, s.total_meters, `â‚¹${s.total_salary}`]);

                doc.autoTable({
                    head: [subtotalHeaders],
                    body: subtotalRows,
                    startY: 80,
                    theme: 'striped',
                    styles: {
                        font: 'helvetica',
                        fontSize: 10,
                        cellPadding: 5,
                        overflow: 'linebreak',
                        lineWidth: 0.5,
                        lineColor: [200, 200, 200]
                    },
                    headStyles: {
                        fillColor: [79, 70, 229],
                        textColor: [255, 255, 255],
                        fontStyle: 'bold'
                    },
                    alternateRowStyles: {
                        fillColor: [248, 250, 252]
                    }
                });
            }

            // Add Daily Subtotals to PDF if available
            const dailySubtotalsData = lastReportData ? lastReportData.daily_subtotals : []; 

            if (dailySubtotalsData && dailySubtotalsData.length > 0) {
                doc.addPage(); // Start a new page for daily subtotals
                doc.setFontSize(18);
                doc.text(`Daily Subtotals for ${loomerName}`, 40, 40);
                doc.setFontSize(12);
                doc.text(`From: ${fromDate} To: ${toDate}`, 40, 60);

                const dailySubtotalHeaders = [
                    `Date`,
                    `Total Meters`,
                    `Total Salary`
                ];
                const dailySubtotalRows = dailySubtotalsData.map(s => [s.date, s.total_meters, `â‚¹${s.total_salary}`]);

                doc.autoTable({
                    head: [dailySubtotalHeaders],
                    body: dailySubtotalRows,
                    startY: 80,
                    theme: 'striped',
                    styles: {
                        font: 'helvetica',
                        fontSize: 10,
                        cellPadding: 5,
                        overflow: 'linebreak',
                        lineWidth: 0.5,
                        lineColor: [200, 200, 200]
                    },
                    headStyles: {
                        fillColor: [79, 70, 229],
                        textColor: [255, 255, 255],
                        fontStyle: 'bold'
                    },
                    alternateRowStyles: {
                        fillColor: [248, 250, 252]
                    }
                });
            }


            doc.save(`Powerloom_Report_${loomerName}_${fromDate}_to_${toDate}.pdf`);
            showNotification('reportDownloaded', 'success');
        });

        document.getElementById('addUserForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            toggleSpinner('addUserBtn', true); // No text needed, spinner replaces
            const formData = new FormData(e.target);

            try {
                const response = await fetch('/admin/add_user', {
                    method: 'POST',
                    body: formData
                });

                if (response.status === 401 || response.status === 403) { 
                    showNotification('sessionExpired', 'error');
                    setTimeout(() => window.location.href = '/login', 1500);
                    return;
                }

                const data = await response.json();
                if (response.ok && data.status === 'success') {
                    showNotification('userAddedSuccess', 'success');
                    e.target.reset();
                    fetchUsers(); 
                } else {
                    showNotification(data.message || 'failedToAddUser', 'error');
                }
            } catch (error) {
                showNotification('networkError', 'error');
                console.error("Client-side Fetch Error:", error);
            } finally {
                toggleSpinner('addUserBtn', false); // Spinner hides
            }
        });


        document.getElementById('updatePasswordForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            toggleSpinner('updatePasswordBtn', true); // No text needed, spinner replaces
            const formData = new FormData(e.target);
            const newPassword = formData.get('new_password');
            const confirmPassword = formData.get('confirm_password');

            if (newPassword !== confirmPassword) {
                showNotification('passwordMismatch', 'error');
                toggleSpinner('updatePasswordBtn', false); // Ensure spinner hides
                return;
            }

            try {
                const response = await fetch('/admin/update_password', {
                    method: 'POST',
                    body: formData
                });

                if (response.status === 401 || response.status === 403) { 
                    showNotification('sessionExpired', 'error');
                    setTimeout(() => window.location.href = '/login', 1500);
                    return;
                }

                const data = await response.json();
                if (response.ok && data.status === 'success') {
                    showNotification('passwordUpdateSuccess', 'success');
                    e.target.reset();
                } else {
                    showNotification(data.message || 'passwordUpdateFailed', 'error');
                }
            } catch (error) {
                showNotification('networkError', 'error');
                console.error("Client-side Fetch Error:", error);
            } finally {
                toggleSpinner('updatePasswordBtn', false); // Spinner hides
            }
        });

        document.getElementById('removeUserForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            toggleSpinner('removeUserBtn', true); // No text needed, spinner replaces
            const formData = new FormData(e.target);
            const usernameToRemove = formData.get('username');
            const currentLoggedInUsername = document.getElementById('currentUsername').textContent;

            if (usernameToRemove === currentLoggedInUsername) {
                showNotification('cannotRemoveSelf', 'error');
                toggleSpinner('removeUserBtn', false); // Ensure spinner hides
                return;
            }

            // Use custom confirmation for removing user
            if (!await showCustomConfirm(`Are you sure you want to remove user "${usernameToRemove}"? This action cannot be undone.`)) {
                toggleSpinner('removeUserBtn', false); // Ensure spinner hides
                return;
            }

            try {
                const response = await fetch('/admin/remove_user', {
                    method: 'POST',
                    body: formData
                });

                if (response.status === 401 || response.status === 403) { 
                    showNotification('sessionExpired', 'error');
                    setTimeout(() => window.location.href = '/login', 1500);
                    return;
                }

                const data = await response.json();
                if (response.ok && data.status === 'success') {
                    showNotification('userRemovedSuccess', 'success');
                    e.target.reset();
                    fetchUsers(); 
                } else {
                    showNotification(data.message || 'failedToRemoveUser', 'error');
                }
            } catch (error) {
                showNotification('networkError', 'error');
                console.error("Client-side Fetch Error:", error);
            } finally {
                toggleSpinner('removeUserBtn', false); // Spinner hides
            }
        });

        document.getElementById('removeLoomDataForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            toggleSpinner('removeDataBtn', true); // No text needed, spinner replaces
            const formData = new FormData(e.target);

            const loomerName = formData.get('loomer_name').trim();
            const fromDate = formData.get('from_date');
            const toDate = formData.get('to_date');

            // Validation: At least loomer name or a date range must be provided
            if (!loomerName && (!fromDate || !toDate)) {
                showNotification('loomerNameOrDateRangeRequired', 'error');
                toggleSpinner('removeDataBtn', false); // Ensure spinner hides
                return;
            }

            // Date range validation
            if (fromDate && toDate) {
                if (new Date(fromDate) > new Date(toDate)) {
                    showNotification('fromDateAfterToDate', 'error');
                    toggleSpinner('removeDataBtn', false); // Ensure spinner hides
                    return;
                }
            } else if (fromDate || toDate) { // If only one date is provided
                showNotification('bothDatesRequired', 'error');
                toggleSpinner('removeDataBtn', false); // Ensure spinner hides
                return;
            }

            // Confirmation before removal
            if (!await showCustomConfirm(notifications.removeDataConfirm)) {
                toggleSpinner('removeDataBtn', false); // Ensure spinner hides
                return;
            }

            try {
                const response = await fetch('/admin/remove_data', {
                    method: 'POST',
                    body: formData
                });

                if (response.status === 401 || response.status === 403) {
                    showNotification('sessionExpired', 'error');
                    setTimeout(() => window.location.href = '/login', 1500);
                    return;
                }

                const data = await response.json();
                if (response.ok && data.status === 'success') {
                    showNotification('removeDataSuccess', 'success', { count: data.deleted_count });
                    e.target.reset(); // Clear the form
                } else if (data.status === 'info') {
                    showNotification('noMatchingRecords', 'info');
                } else {
                    showNotification(data.message || 'failedToRemoveData', 'error');
                }
            } catch (error) {
                showNotification('networkError', 'error');
                console.error("Client-side Fetch Error:", error);
            } finally {
                toggleSpinner('removeDataBtn', false); // Spinner hides
            }
        });

        document.getElementById('graphQueryForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            toggleSpinner('generateGraphBtn', true); // No text needed, spinner replaces

            try {
                const formData = new FormData(e.target);
                const response = await fetch('/get_graph_data', {
                    method: 'POST',
                    body: formData
                });

                if (response.status === 401 || response.status === 403) {
                    showNotification('sessionExpired', 'error');
                    setTimeout(() => window.location.href = '/login', 1500);
                    return;
                }

                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    const text = await response.text();
                    console.error('Server response was not JSON:', text);
                    showNotification('networkError', 'error');
                    return;
                }

                const data = await response.json();

                const productionChartCanvas = document.getElementById('productionChart');
                const noGraphDataMessage = document.getElementById('noGraphDataMessage');

                if (productionChartInstance) {
                    productionChartInstance.destroy(); // Destroy previous chart instance
                }

                if (data.graph_data && data.graph_data.labels.length > 0) {
                    noGraphDataMessage.classList.add('hidden');
                    productionChartCanvas.classList.remove('hidden'); // Ensure canvas is visible

                    productionChartInstance = new Chart(productionChartCanvas, {
                        type: 'line', // Line chart is good for time series
                        data: {
                            labels: data.graph_data.labels,
                            datasets: [
                                {
                                    label: 'Meters Produced',
                                    data: data.graph_data.meters,
                                    borderColor: 'rgb(75, 192, 192)',
                                    tension: 0.1,
                                    fill: false
                                },
                                {
                                    label: 'Salary Paid (â‚¹)',
                                    data: data.graph_data.salary,
                                    borderColor: 'rgb(255, 99, 132)',
                                    tension: 0.1,
                                    fill: false,
                                    yAxisID: 'y1', // Use a second Y-axis for salary
                                }
                            ]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    title: {
                                        display: true,
                                        text: 'Meters'
                                    }
                                },
                                y1: { // Second Y-axis for salary
                                    type: 'linear',
                                    display: true,
                                    position: 'right',
                                    beginAtZero: true,
                                    grid: {
                                        drawOnChartArea: false, // Only draw grid lines for the first Y-axis
                                    },
                                    title: {
                                        display: true,
                                        text: 'Salary (â‚¹)'
                                    }
                                }
                            },
                            plugins: {
                                title: {
                                    display: true,
                                    text: 'Production Metrics Over Time'
                                }
                            }
                        }
                    });
                    showNotification('graphGeneratedSuccess', 'success');
                } else {
                    productionChartCanvas.classList.add('hidden'); // Hide canvas if no data
                    noGraphDataMessage.classList.remove('hidden');
                    showNotification('noGraphDataFound', 'info');
                }
            } catch (error) {
                showNotification('networkError', 'error');
                console.error("Client-side Fetch Error:", error);
            } finally {
                toggleSpinner('generateGraphBtn', false); // Spinner hides
            }
        });


        // --- WARP MANAGEMENT JAVASCRIPT (Now integrated into Admin Tools) ---

        // Helper function to fetch and display current total warp
        async function fetchCurrentTotalWarp() {
            const currentTotalWarpSpan = document.getElementById('currentTotalWarp');
            if (!currentTotalWarpSpan) return; // Exit if element not found

            try {
                const response = await fetch('/get_current_warp'); // New backend endpoint
                if (response.status === 401 || response.status === 403) {
                    showNotification('sessionExpired', 'error');
                    setTimeout(() => window.location.href = '/login', 1500);
                    return;
                }
                if (!response.ok) {
                    const errorData = await response.json();
                    showNotification(errorData.message || 'Failed to fetch current warp.', 'error');
                    return;
                }
                const data = await response.json();
                currentWarpValue = parseFloat(data.total_warp); // Ensure it's parsed as a float
                currentTotalWarpSpan.textContent = currentWarpValue.toFixed(2); // Display with 2 decimal places
            } catch (error) {
                showNotification('networkError', 'error');
                console.error("Client-side Fetch Error (Current Warp):", error);
            }
        }

        // Helper function to fetch and display warp history
        async function fetchWarpHistory() {
            const historyTableBody = document.getElementById('warpHistoryTableBody');
            const noWarpHistoryMessage = document.getElementById('noWarpHistoryMessage');
            historyTableBody.innerHTML = '<tr><td colspan="6" class="px-4 py-2 text-center text-gray-500">Loading history...</td></tr>'; // Adjusted colspan

            try {
                const response = await fetch('/get_warp_history'); // New backend endpoint
                if (response.status === 401 || response.status === 403) {
                    showNotification('sessionExpired', 'error');
                    setTimeout(() => window.location.href = '/login', 1500);
                    return;
                }
                if (!response.ok) {
                    const errorData = await response.json();
                    showNotification(errorData.message || 'Failed to fetch warp history.', 'error');
                    historyTableBody.innerHTML = '<tr><td colspan="6" class="px-4 py-2 text-center text-gray-500">Failed to load history.</td></tr>'; // Adjusted colspan
                    return;
                }
                const data = await response.json();

                historyTableBody.innerHTML = ''; // Clear loading message
                if (data.history && data.history.length > 0) {
                    noWarpHistoryMessage.classList.add('hidden');
                    data.history.forEach(record => {
                        const row = historyTableBody.insertRow();
                        const changeValue = parseFloat(record.value_change);
                        const changeColorClass = changeValue > 0 ? 'text-green-600' : (changeValue < 0 ? 'text-red-600' : 'text-gray-600');
                        
                        // Use event_date from backend, which is the user-selected date
                        const dateString = record.event_date || 'N/A'; 

                        row.innerHTML = `
                            <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-900">${dateString}</td>
                            <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-900">${record.username || 'N/A'}</td>
                            <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-900">${record.change_type}</td>
                            <td class="px-4 py-2 whitespace-nowrap text-sm ${changeColorClass}">${changeValue >= 0 ? '+' : ''}${changeValue.toFixed(2)}</td>
                            <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-900">${parseFloat(record.new_total_warp).toFixed(2)}</td>
                            <td class="px-4 py-2 text-sm text-gray-900">${record.remarks || '-'}</td>
                        `;
                    });
                } else {
                    noWarpHistoryMessage.classList.remove('hidden');
                    historyTableBody.innerHTML = '<tr><td colspan="6" class="px-4 py-2 text-center text-gray-500">No history to display.</td></tr>'; // Adjusted colspan
                }
            } catch (error) {
                showNotification('networkError', 'error');
                console.error("Client-side Fetch Error (Warp History):", error);
                historyTableBody.innerHTML = '<tr><td colspan="6" class="px-4 py-2 text-center text-gray-500">Failed to load history.</td></tr>'; // Adjusted colspan
            }
        }

        // Event listener for Update Warp Form submission
        document.getElementById('updateWarpForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            toggleSpinner('updateWarpBtn', true); // No text needed, spinner replaces
            const formData = new FormData(e.target);
            const value = parseFloat(formData.get('value'));
            const date = formData.get('date'); // Get the date
            const remarks = formData.get('remarks');

            if (isNaN(value)) {
                showNotification('invalidWarpValue', 'error');
                toggleSpinner('updateWarpBtn', false); // Ensure spinner hides
                return;
            }

            try {
                const response = await fetch('/update_warp', { // New backend endpoint
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ value: value, date: date, remarks: remarks }) // Include date
                });

                if (response.status === 401 || response.status === 403) {
                    showNotification('sessionExpired', 'error');
                    setTimeout(() => window.location.href = '/login', 1500);
                    return;
                }

                const data = await response.json();
                if (response.ok && data.status === 'success') {
                    showNotification('warpUpdateSuccess', 'success');
                    e.target.reset(); // Clear the form
                    // Set default date for new warp date inputs
                    const today = new Date().toISOString().split('T')[0];
                    document.getElementById('warpUpdateDate').value = today;
                    document.getElementById('knottingDate').value = today;

                    fetchCurrentTotalWarp(); // Refresh current warp display
                    fetchWarpHistory();     // Refresh history
                } else {
                    showNotification(data.message || 'failedToUpdateWarp', 'error');
                }
            } catch (error) {
                showNotification('networkError', 'error');
                console.error("Client-side Fetch Error (Update Warp):", error);
            } finally {
                toggleSpinner('updateWarpBtn', false); // Spinner hides
            }
        });

        // Event listener for Generate Knotting Form submission
        document.getElementById('applyKnottingForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            toggleSpinner('applyKnottingBtn', true); // No text needed, spinner replaces
            
            const formData = new FormData(e.target);
            const knottingValue = parseFloat(formData.get('knotting_value'));
            const currentTotalWarp = currentWarpValue; 

            if (isNaN(knottingValue) || knottingValue < 0) {
                showNotification('invalidKnottingValue', 'error');
                toggleSpinner('applyKnottingBtn', false); 
                document.getElementById('knottingResultDisplay').classList.add('hidden'); 
                return;
            }

            if (isNaN(currentTotalWarp)) { 
                showNotification('Failed to get current warp for calculation. Please refresh the page.', 'error');
                toggleSpinner('applyKnottingBtn', false); 
                document.getElementById('knottingResultDisplay').classList.add('hidden'); 
                return;
            }

            if (knottingValue > currentTotalWarp) { 
                if (!await showCustomConfirm(`Knotting value (${knottingValue}) is greater than current total warp (${currentTotalWarp}). Are you sure you want to proceed? This calculation will result in a negative value.`)) {
                    toggleSpinner('applyKnottingBtn', false); 
                    document.getElementById('knottingResultDisplay').classList.add('hidden'); 
                    return;
                }
            }

            try {
                const response = await fetch('/apply_knotting', { 
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ 
                        knotting_value: knottingValue, 
                        current_total_warp: currentTotalWarp 
                    }) 
                });

                if (response.status === 401 || response.status === 403) {
                    showNotification('sessionExpired', 'error');
                    setTimeout(() => window.location.href = '/login', 1500);
                    return;
                }

                const data = await response.json();
                const calculatedRemainingWarpSpan = document.getElementById('calculatedRemainingWarp');
                const knottingResultDisplay = document.getElementById('knottingResultDisplay');

                if (response.ok && data.status === 'success') {
                    showNotification('knottingAppliedSuccess', 'success'); 
                    
                    calculatedRemainingWarpSpan.textContent = parseFloat(data.calculated_remaining_warp).toFixed(2);
                    knottingResultDisplay.classList.remove('hidden'); 

                    document.getElementById('knottingCountValue').value = ''; 
                    const today = new Date().toISOString().split('T')[0];
                    document.getElementById('warpUpdateDate').value = today;
                    document.getElementById('knottingDate').value = today;

                } else {
                    showNotification(data.message || 'failedToApplyKnotting', 'error');
                    knottingResultDisplay.classList.add('hidden'); 
                }
            } catch (error) {
                showNotification('networkError', 'error');
                console.error("Client-side Fetch Error (Generate Knotting):", error);
                document.getElementById('knottingResultDisplay').classList.add('hidden'); 
            } finally {
                toggleSpinner('applyKnottingBtn', false); 
            }
        });

        // New function to clear warp history
        async function clearWarpHistory() {
            if (!await showCustomConfirm(notifications.confirmClearWarpHistory)) {
                return;
            }

            toggleSpinner('clearWarpHistoryBtn', true); // No text needed, spinner replaces
            try {
                const response = await fetch('/clear_warp_history', { // New backend endpoint
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                if (response.status === 401 || response.status === 403) {
                    showNotification('sessionExpired', 'error');
                    setTimeout(() => window.location.href = '/login', 1500);
                    return;
                }

                const data = await response.json();
                if (response.ok && data.status === 'success') {
                    showNotification('warpHistoryCleared', 'success');
                    fetchWarpHistory(); // Refresh history table
                } else {
                    showNotification(data.message || 'failedToClearWarpHistory', 'error');
                }
            } catch (error) {
                showNotification('networkError', 'error');
                console.error("Client-side Fetch Error (Clear Warp History):", error);
            } finally {
                toggleSpinner('clearWarpHistoryBtn', false); // Spinner hides
            }
        }

        // Attach event listener for Clear Warp History button
        document.getElementById('clearWarpHistoryBtn').addEventListener('click', clearWarpHistory);

        // Fetch users for admin panel (existing function)
        async function fetchUsers() {
            const usersTableBody = document.getElementById('usersTableBody');
            const usersTable = document.getElementById('usersTable');
            const noUsersMessage = document.getElementById('noUsersMessage');
            toggleSpinner('refreshUsersBtn', true); // No text needed, spinner replaces
            usersTableBody.innerHTML = '<tr><td colspan="3" class="px-4 py-2 text-center text-gray-500">Loading users...</td></tr>';
            usersTable.classList.add('hidden');
            noUsersMessage.classList.add('hidden');

            try {
                const response = await fetch('/admin/get_users');
                if (response.status === 401 || response.status === 403) {
                    showNotification('sessionExpired', 'error');
                    setTimeout(() => window.location.href = '/login', 1500);
                    return;
                }
                const data = await response.json();
                usersTableBody.innerHTML = ''; // Clear loading message

                if (response.ok && data.status === 'success' && data.users.length > 0) {
                    usersTable.classList.remove('hidden');
                    data.users.forEach(user => {
                        const row = usersTableBody.insertRow();
                        row.innerHTML = `
                            <td class="px-4 py-2">${user.username}</td>
                            <td class="px-4 py-2">${user.role}</td>
                            <td class="px-4 py-2 text-xs">${user._id}</td>
                        `;
                    });
                } else {
                    noUsersMessage.classList.remove('hidden');
                    usersTable.classList.add('hidden');
                    usersTableBody.innerHTML = '<tr><td colspan="3" class="px-4 py-2 text-center text-red-500">Error loading users.</td></tr>';
                }
            } catch (error) {
                showNotification('failedToFetchUsers', 'error');
                console.error("Failed to fetch users:", error);
                usersTableBody.innerHTML = '<tr><td colspan="3" class="px-4 py-2 text-center text-red-500">Error loading users.</td></tr>';
            } finally {
                toggleSpinner('refreshUsersBtn', false); // Spinner hides
            }
        }

        // Event listener for Refresh Users button
        document.getElementById('refreshUsersBtn').addEventListener('click', fetchUsers);
    </script>
</body>
</html>
