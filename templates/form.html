<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>Powerloom Data Management System</title>
    <link rel="icon" type="image/png" href="{{ url_for('static', filename='favicon.png') }}">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- Tailwind CSS CDN - Re-added for simplicity and to ensure all classes are rendered correctly. If a build process is used, this can be removed. -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load after Tailwind so our two-tone overrides win -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/custom.css') }}">
    <!-- jsPDF and jspdf-autotable for PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <!-- Chart.js for graphs -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* Loading spinner styles */
        .spinner {
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-top: 3px solid #fff;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 0.8s linear infinite;
            display: inline-block;
            vertical-align: middle;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Notification Animation */
        #notification {
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            backdrop-filter: blur(8px);
        }
        #notification.show {
            opacity: 1;
            transform: translateY(0) scale(1);
        }
        #notification.success {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%); /* Emerald Gradient */
            box-shadow: 0 10px 15px -3px rgba(16, 185, 129, 0.3), 0 4px 6px -2px rgba(16, 185, 129, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        #notification.error {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); /* Red Gradient */
            box-shadow: 0 10px 15px -3px rgba(239, 68, 68, 0.3), 0 4px 6px -2px rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        #notification.info {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); /* Blue Gradient */
            box-shadow: 0 10px 15px -3px rgba(59, 130, 246, 0.3), 0 4px 6px -2px rgba(59, 130, 246, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .llm-response-box p:last-child {
            margin-bottom: 0;
        }
        .llm-response-box ul {
            list-style-type: disc;
            margin-left: 1.25rem;
            padding-left: 0.5rem;
        }
        .llm-response-box li {
            margin-bottom: 0.25rem;
        }

        /* Tabs for Admin Section and Report Section */
        .tab-button {
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem 0.5rem 0 0;
            background-color: rgba(255, 255, 255, 0.5);
            color: #4f46e5; /* indigo-600 */
            font-weight: 600;
            transition: all 0.2s ease;
            cursor: pointer;
            border-bottom: 2px solid transparent;
        }
        .tab-button.active {
            background-color: #fff;
            border-bottom-color: #4f46e5; /* indigo-600 */
            color: #3730a3; /* indigo-800 */
        }
        .tab-button:hover {
            background-color: rgba(255, 255, 255, 0.8);
        }
        .tab-content {
            border: 1px solid rgba(255, 255, 255, 0.6);
            border-top: none;
            padding: 1.5rem;
            background-color: rgba(255, 255, 255, 0.9);
            border-radius: 0 0 0.5rem 0.5rem;
            backdrop-filter: blur(10px);
        }
    </style>
</head>
<body class="min-h-screen font-inter text-slate-800">
    <!-- Toast Notification -->
    <div id="notification" class="hidden fixed top-6 right-6 z-50 transition-all duration-300 transform translate-y-[-20px] scale-95 opacity-0 flex items-center p-4 mb-4 text-white rounded-xl shadow-2xl min-w-[320px] border border-white/20" role="alert">
        <div class="flex-shrink-0 mr-3 bg-white/20 rounded-full p-1.5">
             <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2.5"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"></path></svg>
        </div>
        <div class="flex-1">
            <span id="notification-message" class="font-medium text-sm tracking-wide"></span>
        </div>
        <button class="ml-3 -mx-1.5 -my-1.5 bg-transparent text-white rounded-lg focus:ring-2 focus:ring-white/50 p-1.5 hover:bg-white/20 inline-flex h-8 w-8 transition-colors" onclick="document.getElementById('notification').classList.add('hidden');">
            <span class="sr-only">Close</span>
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2.5"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"></path></svg>
        </button>
    </div>

    <!-- Top Navigation Bar -->
    <nav class="glass-card mx-4 mt-4 sticky top-4 z-40 mb-8 animate-slide-up">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex">
                    <div class="flex-shrink-0 flex items-center">
                        <div class="w-10 h-10 bg-gradient-to-r from-indigo-600 to-purple-600 rounded-xl flex items-center justify-center text-white font-bold text-xl mr-3 shadow-lg animate-pulse-glow">P</div>
                        <span class="font-bold text-xl text-gradient tracking-tight">Powerloom DMS</span>
                    </div>
                    <div class="hidden sm:ml-10 sm:flex sm:space-x-8 items-center">
                        <div id="navHomeLink" class="hidden">
                            <a href="{{ url_for('enter_data_page') }}" id="navHome" class="text-gray-700 hover:text-indigo-600 px-3 py-2 rounded-md text-sm font-bold transition-all hover:bg-indigo-50/50">Enter Data</a>
                        </div>
                        <div>
                            <a href="{{ url_for('reports_page') }}" id="navReport" class="text-gray-700 hover:text-indigo-600 px-3 py-2 rounded-md text-sm font-bold transition-all hover:bg-indigo-50/50">Reports</a>
                        </div>
                        <div>
                            <a href="{{ url_for('graphs_page') }}" id="navGraphs" class="text-gray-700 hover:text-indigo-600 px-3 py-2 rounded-md text-sm font-bold transition-all hover:bg-indigo-50/50">Graphs</a>
                        </div>
                        <div>
                            <a href="{{ url_for('profile_page') }}" id="navProfile" class="text-gray-700 hover:text-indigo-600 px-3 py-2 rounded-md text-sm font-bold transition-all hover:bg-indigo-50/50">Profile</a>
                        </div>
                        <div id="navAdminLink" class="hidden">
                            <a href="{{ url_for('admin_tools_page') }}" id="navAdmin" class="text-gray-700 hover:text-indigo-600 px-3 py-2 rounded-md text-sm font-bold transition-all hover:bg-indigo-50/50">Admin Tools</a>
                        </div>
                    </div>
                </div>
                <div class="flex items-center">
                    <div class="flex items-center space-x-4">
                        <div class="text-right hidden sm:block">
                            <p class="text-sm font-bold text-gray-800" id="currentUsername">User</p>
                            <p class="text-xs text-indigo-600 font-bold capitalize" id="currentUserRole">Role</p>
                        </div>
                        <button id="logoutBtn" class="p-2 rounded-full text-gray-500 hover:text-red-600 hover:bg-red-50 transition-all transform hover:scale-110" title="Logout">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path></svg>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- Mobile Navigation (Small Screens) -->
    <div class="sm:hidden mx-4 -mt-4 mb-8">
        <div class="glass-card px-3 py-2 overflow-x-auto">
            <div class="flex items-center gap-2 min-w-max">
                <a href="{{ url_for('enter_data_page') }}" id="navHomeMobile" class="px-3 py-2 rounded-lg text-sm font-bold text-gray-700 hover:text-indigo-600 hover:bg-indigo-50/50 transition-all">Enter Data</a>
                <a href="{{ url_for('reports_page') }}" id="navReportMobile" class="px-3 py-2 rounded-lg text-sm font-bold text-gray-700 hover:text-indigo-600 hover:bg-indigo-50/50 transition-all">Reports</a>
                <a href="{{ url_for('graphs_page') }}" id="navGraphsMobile" class="px-3 py-2 rounded-lg text-sm font-bold text-gray-700 hover:text-indigo-600 hover:bg-indigo-50/50 transition-all">Graphs</a>
                <a href="{{ url_for('profile_page') }}" id="navProfileMobile" class="px-3 py-2 rounded-lg text-sm font-bold text-gray-700 hover:text-indigo-600 hover:bg-indigo-50/50 transition-all">Profile</a>
                <a href="{{ url_for('admin_tools_page') }}" id="navAdminMobile" class="px-3 py-2 rounded-lg text-sm font-bold text-gray-700 hover:text-indigo-600 hover:bg-indigo-50/50 transition-all">Admin Tools</a>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <div id="contentSections">
            <!-- Section: Enter Loom Data -->
            <section id="dataEntrySection" class="main-content-section glass-card mb-8 hidden animate-slide-up">
                <div class="p-4 sm:p-6 border-b border-white/20 bg-white/30 backdrop-blur-sm section-header">
                    <h2 class="text-2xl font-bold text-gradient">Enter Loom Data</h2>
                    <p class="text-sm text-gray-600 mt-1 font-medium">Record daily production metrics for looms.</p>
                </div>
                <div class="p-4 sm:p-6">
                    <form id="dataEntryForm" class="space-y-6">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="form-group">
                                <label class="block text-sm font-bold text-gray-700 mb-2">Loomer Name</label>
                                <input type="text" name="loomer_name" id="data_loomer_name" required 
                                    class="w-full px-4 py-3 modern-input rounded-xl outline-none text-gray-800 font-medium placeholder-gray-400">
                            </div>

                            <div class="form-group">
                                <label class="block text-sm font-bold text-gray-700 mb-2">Loom Number</label>
                                <input type="text" name="loom_number" required 
                                    class="w-full px-4 py-3 modern-input rounded-xl outline-none text-gray-800 font-medium placeholder-gray-400">
                            </div>

                            <div class="form-group">
                                <label class="block text-sm font-bold text-gray-700 mb-2">Shift</label>
                                <select name="shift" required 
                                        class="w-full px-4 py-3 modern-input modern-select rounded-xl outline-none cursor-pointer text-gray-800 font-medium appearance-none">
                                    <option value="">Select Shift</option>
                                    <option value="Morning">Morning</option>
                                    <option value="Night">Night</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label class="block text-sm font-bold text-gray-700 mb-2">Meters</label>
                                <input type="number" name="meters" min="0" required 
                                    class="w-full px-4 py-3 modern-input rounded-xl outline-none text-gray-800 font-medium placeholder-gray-400">
                            </div>

                            <div class="form-group">
                                <label class="block text-sm font-bold text-gray-700 mb-2">Salary per Meter</label>
                                <div class="relative">
                                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                        <span class="text-gray-500 font-bold sm:text-sm">₹</span>
                                    </div>
                                    <input type="number" name="salary_per_meter" min="0" step="0.01" required 
                                        class="w-full pl-7 px-4 py-3 modern-input rounded-xl outline-none text-gray-800 font-medium placeholder-gray-400">
                                </div>
                            </div>

                            <div class="form-group">
                                <label class="block text-sm font-bold text-gray-700 mb-2">Date</label>
                                <input type="date" name="date" id="data_date" required max="2100-12-31" min="2000-01-01" 
                                    class="w-full px-4 py-3 modern-input rounded-xl outline-none text-gray-800 font-medium">
                            </div>
                        </div>

                        <div class="pt-4">
                            <button type="submit" id="submitDataBtn" class="w-full md:w-auto md:min-w-[200px] btn-primary py-3.5 px-8 rounded-xl font-bold shadow-lg flex items-center justify-center text-lg tracking-wide">
                                <span id="submitDataBtnText">Submit Data</span>
                                <span id="submitDataSpinner" class="spinner hidden ml-2"></span>
                            </button>
                        </div>
                    </form>
                </div>
            </section>

            <!-- Section: Production Report -->
            <section id="reportSection" class="main-content-section bg-white rounded-2xl shadow-sm border border-slate-200 border-t-4 border-t-indigo-500 mb-8 hidden">
                <div class="p-4 sm:p-6 border-b border-slate-100 bg-indigo-50/30">
                    <h2 class="text-xl font-bold text-slate-800">Production Report</h2>
                    <p class="text-sm text-slate-500 mt-1">Generate and analyze production reports.</p>
                </div>
                
                <div class="p-4 sm:p-6">
                    <form id="dataQueryForm" class="space-y-6">
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                            <div class="form-group" id="loomerNameQueryGroup">
                                <label class="block text-sm font-medium text-slate-700 mb-2">Loomer Name</label>
                                <input type="text" name="loomer_name" id="report_loomer_name" required 
                                    class="w-full px-4 py-2.5 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none transition-all bg-slate-50 focus:bg-white">
                                <p class="text-xs text-slate-500 mt-1 hidden" id="loomerNameReportHint">Enter "all" for all loomers (Admin only)</p> 
                            </div>

                            <div class="form-group">
                                <label class="block text-sm font-medium text-slate-700 mb-2">Shift</label>
                                <select name="shift" required 
                                        class="w-full px-4 py-2.5 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none transition-all bg-slate-50 focus:bg-white">
                                    <option value="all">All Shifts</option>
                                    <option value="Morning">Morning</option>
                                    <option value="Night">Night</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label class="block text-sm font-medium text-slate-700 mb-2">Loom Number</label>
                                <input type="text" name="loom_number" value="all" required 
                                    class="w-full px-4 py-2.5 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none transition-all bg-slate-50 focus:bg-white">
                                <p class="text-xs text-slate-500 mt-1">Enter "all" for all looms</p>
                            </div>

                            <div class="form-group">
                                <label class="block text-sm font-medium text-slate-700 mb-2">From Date</label>
                                <input type="date" name="from_date" id="report_from_date" required max="2100-12-31" min="2000-01-01" 
                                    class="w-full px-4 py-2.5 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none transition-all bg-slate-50 focus:bg-white">
                            </div>
                            <div class="form-group">
                                <label class="block text-sm font-medium text-slate-700 mb-2">To Date</label>
                                <input type="date" name="to_date" id="report_to_date" required max="2100-12-31" min="2000-01-01" 
                                    class="w-full px-4 py-2.5 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none transition-all bg-slate-50 focus:bg-white">
                            </div>
                        </div>

                        <div class="flex flex-col sm:flex-row gap-4 pt-4">
                            <button type="submit" id="generateReportBtn" class="flex-1 btn-primary py-3.5 px-6 rounded-xl font-bold shadow-lg flex items-center justify-center text-lg tracking-wide">
                                <span id="generateReportBtnText">Generate Report</span>
                                <span id="generateReportSpinner" class="spinner hidden ml-2"></span>
                            </button>
                            <!-- AI Analysis Button - Added -->
                            <button type="button" id="analyzeReportBtn" class="flex-1 btn-secondary py-3.5 px-6 rounded-xl font-bold shadow-sm flex items-center justify-center text-lg tracking-wide">
                                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
                                <span id="analyzeReportBtnText">Analyze with AI</span>
                                <span id="analyzeReportSpinner" class="spinner hidden ml-2"></span>
                            </button>
                        </div>
                    </form>

                    <div id="resultContainer" class="mt-8 hidden animate-fade-in">
                        <div class="glass-card p-6 border border-white/40">
                            <h3 class="font-bold text-gradient text-xl mb-6 flex items-center">
                                <svg class="w-6 h-6 mr-2 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path></svg>
                                Total Production Summary
                            </h3>
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
                                <div class="bg-white/60 backdrop-blur-sm p-6 rounded-2xl border border-white/50 shadow-sm transition-transform hover:scale-105">
                                    <p class="text-sm text-gray-500 font-bold uppercase tracking-wide">Total Meters</p>
                                    <p class="text-4xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-indigo-600 to-blue-600 mt-2"><span id="totalMeters">0</span></p>
                                </div>
                                <div class="bg-white/60 backdrop-blur-sm p-6 rounded-2xl border border-white/50 shadow-sm transition-transform hover:scale-105">
                                    <p class="text-sm text-gray-500 font-bold uppercase tracking-wide">Total Salary</p>
                                    <p class="text-4xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-emerald-600 to-teal-600 mt-2">₹<span id="totalSalary">0.00</span></p>
                                </div>
                            </div>
                            <p class="text-xs text-gray-400 mt-4 text-right font-medium">Based on selected criteria</p>
                        </div>
                    </div>

                    <!-- AI Analysis Response Box -->
                    <div id="aiResponseContainer" class="mt-8 hidden animate-fade-in">
                        <div class="bg-purple-50/80 backdrop-blur-sm border border-purple-100 rounded-2xl p-6 shadow-sm">
                            <h3 class="font-bold text-purple-900 text-lg mb-4 flex items-center">
                                <svg class="w-5 h-5 mr-2 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z"></path></svg>
                                AI Analysis & Insights
                            </h3>
                            <div id="aiAnalysisContent" class="prose prose-purple max-w-none text-slate-700 text-sm leading-relaxed">
                                <!-- AI analysis will be injected here -->
                            </div>
                            <p id="noAiAnalysisMessage" class="text-slate-500 text-center mt-4 hidden italic">No AI analysis available for the current report.</p>
                        </div>
                    </div>

                    <!-- AI Follow-up Question Section - NEW -->
                    <div id="aiFollowUpSection" class="mt-6 hidden animate-fade-in">
                        <div class="bg-white/80 backdrop-blur-sm border border-slate-200 rounded-2xl p-6 shadow-sm">
                            <h3 class="font-bold text-slate-800 text-lg mb-4">Ask Follow-up Question</h3>
                            <div class="form-group mb-4">
                                <label for="aiQuestionInput" class="block text-sm font-bold text-gray-700 mb-2">Your Question:</label>
                                <div class="relative">
                                    <textarea id="aiQuestionInput" rows="2" class="w-full px-4 py-3 modern-input rounded-xl outline-none text-gray-800 font-medium pr-12" placeholder="e.g., 'What are the main reasons for low production on Loom 4?'"></textarea>
                                    <button type="button" id="askAiQuestionBtn" class="absolute bottom-3 right-3 bg-indigo-600 text-white p-2 rounded-lg hover:bg-indigo-700 transition-colors shadow-md" title="Ask AI">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3"></path></svg>
                                        <span id="askAiQuestionSpinner" class="spinner hidden"></span>
                                    </button>
                                </div>
                            </div>
                            
                            <div id="aiFollowUpAnswerContent" class="mt-4 prose prose-indigo max-w-none text-slate-700 text-sm bg-slate-50 p-4 rounded-xl border border-slate-100 hidden:empty">
                                <!-- AI's answer to follow-up questions will be displayed here -->
                            </div>
                            <p id="noAiFollowUpAnswerMessage" class="text-slate-400 text-center mt-2 text-sm hidden">No answer from AI yet. Ask a question above.</p>
                        </div>
                    </div>
                    <!-- End AI Follow-up Question Section -->


                    <!-- Report Tabs -->
                    <div class="mt-10">
                        <div class="flex border-b border-gray-200 mb-6 overflow-x-auto">
                            <button type="button" class="tab-button active px-6 py-3 text-sm font-bold text-gray-500 border-b-2 border-transparent hover:text-indigo-600 hover:border-indigo-400 transition-all whitespace-nowrap" data-tab="detailedRecords">Detailed Records</button>
                            <button type="button" class="tab-button px-6 py-3 text-sm font-bold text-gray-500 border-b-2 border-transparent hover:text-indigo-600 hover:border-indigo-400 transition-all whitespace-nowrap" data-tab="loomSubtotals">Subtotals Per Loom</button>
                            <button type="button" class="tab-button px-6 py-3 text-sm font-bold text-gray-500 border-b-2 border-transparent hover:text-indigo-600 hover:border-indigo-400 transition-all whitespace-nowrap" data-tab="dailySubtotals">Subtotals Per Day</button>
                        </div>

                        <!-- Tab Content: Detailed Records -->
                        <div id="detailedRecordsTabContent" class="tab-content animate-fade-in">
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="font-bold text-gray-800 text-lg">Detailed Records</h3>
                                <button id="downloadPdfBtn" class="btn-secondary px-4 py-2 rounded-lg text-sm font-bold transition-colors flex items-center shadow-sm">
                                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                                    Download PDF
                                </button>
                            </div>
                            <div id="reportTable" class="overflow-x-auto rounded-xl border border-gray-200 shadow-sm">
                                </div>
                            <p id="noRecordsMessage" class="text-gray-500 text-center py-8 hidden bg-gray-50/50 rounded-xl mt-4 font-medium">No records found for the selected criteria.</p>
                        </div>

                        <!-- Tab Content: Loom Subtotals -->
                        <div id="loomSubtotalsTabContent" class="tab-content hidden animate-fade-in">
                            <h3 class="font-bold text-gray-800 text-lg mb-4">Subtotals Per Loom</h3>
                            <div id="loomSubtotalsTable" class="overflow-x-auto rounded-xl border border-gray-200 shadow-sm">
                                <!-- Subtotals table will be rendered here by JavaScript -->
                            </div>
                        </div>

                        <!-- Tab Content: Daily Subtotals -->
                        <div id="dailySubtotalsTabContent" class="tab-content hidden animate-fade-in">
                            <h3 class="font-bold text-gray-800 text-lg mb-4">Subtotals Per Day</h3>
                            <div id="dailySubtotalsTable" class="overflow-x-auto rounded-xl border border-gray-200 shadow-sm">
                                <!-- Daily subtotals table will be rendered here by JavaScript -->
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Section: Production Graphs -->
            <section id="graphsSection" class="main-content-section glass-card mb-8 hidden animate-slide-up">
                <div class="p-4 sm:p-6 border-b border-white/20 bg-white/30 backdrop-blur-sm section-header">
                    <h2 class="text-2xl font-bold text-gradient">Production Graphs</h2>
                    <p class="text-sm text-gray-600 mt-1 font-medium">Visualize production trends over time.</p>
                </div>

                <div class="p-4 sm:p-6">
                    <form id="graphQueryForm" class="space-y-6">
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                            <div class="form-group">
                                <label class="block text-sm font-bold text-gray-700 mb-2">Loomer Name</label>
                                <input type="text" name="loomer_name" id="graph_loomer_name" required 
                                    class="w-full px-4 py-3 modern-input rounded-xl outline-none text-gray-800 font-medium placeholder-gray-400">
                                <p class="text-xs text-gray-500 mt-1 font-medium">Enter "all" for all loomers (Admin only)</p>
                            </div>

                            <div class="form-group">
                                <label class="block text-sm font-bold text-gray-700 mb-2">Period</label>
                                <select name="period" id="graphPeriod" required 
                                        class="w-full px-4 py-3 modern-input rounded-xl outline-none text-gray-800 font-medium bg-white/50">
                                    <option value="day">Daily</option>
                                    <option value="week">Weekly</option>
                                    <option value="month">Monthly</option>
                                    <option value="year">Yearly</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label class="block text-sm font-bold text-gray-700 mb-2">From Date</label>
                                <input type="date" name="from_date" id="graph_from_date" required max="2100-12-31" min="2000-01-01" 
                                    class="w-full px-4 py-3 modern-input rounded-xl outline-none text-gray-800 font-medium">
                            </div>
                            <div class="form-group">
                                <label class="block text-sm font-bold text-gray-700 mb-2">To Date</label>
                                <input type="date" name="to_date" id="graph_to_date" required max="2100-12-31" min="2000-01-01" 
                                    class="w-full px-4 py-3 modern-input rounded-xl outline-none text-gray-800 font-medium">
                            </div>
                        </div>

                        <div class="pt-4">
                            <button type="submit" id="generateGraphBtn" class="w-full md:w-auto md:min-w-[200px] btn-primary py-3.5 px-6 rounded-xl font-bold shadow-lg flex items-center justify-center text-lg tracking-wide">
                                <span id="generateGraphBtnText">Generate Graph</span>
                                <span id="generateGraphSpinner" class="spinner hidden ml-2"></span>
                            </button>
                        </div>
                    </form>

                    <div class="mt-8 bg-white/50 backdrop-blur-sm rounded-2xl p-4 border border-white/40 min-h-[400px] flex items-center justify-center relative shadow-inner">
                        <canvas id="productionChart" class="w-full h-full"></canvas>
                        <p id="noGraphDataMessage" class="text-gray-500 text-center absolute inset-0 flex items-center justify-center hidden font-medium">No data found for the selected graph criteria.</p>
                    </div>
                </div>
            </section>

            <!-- Section: Admin Tools -->
            <section id="adminSection" class="main-content-section mt-10 glass-card hidden animate-slide-up">
                <div class="p-4 sm:p-6 border-b border-white/20 bg-white/30 backdrop-blur-sm section-header">
                    <h2 class="text-2xl font-bold text-gradient">Admin Tools</h2>
                    <p class="text-sm text-gray-600 mt-1 font-medium">Manage users, data, and system settings.</p>
                </div>
                
                <div class="p-4 sm:p-6">
                    <!-- Admin Tabs -->
                    <div class="flex border-b border-gray-200 mb-8 overflow-x-auto">
                        <a href="{{ url_for('admin_tools_add_user_page') }}" class="tab-button px-5 py-3 text-sm font-bold text-gray-500 border-b-2 border-transparent hover:text-indigo-600 hover:border-indigo-400 transition-all whitespace-nowrap" data-tab="addUser">Add User</a>
                        <a href="{{ url_for('admin_tools_update_password_page') }}" class="tab-button px-5 py-3 text-sm font-bold text-gray-500 border-b-2 border-transparent hover:text-indigo-600 hover:border-indigo-400 transition-all whitespace-nowrap" data-tab="updatePassword">Update Password</a>
                        <a href="{{ url_for('admin_tools_remove_user_page') }}" class="tab-button px-5 py-3 text-sm font-bold text-gray-500 border-b-2 border-transparent hover:text-indigo-600 hover:border-indigo-400 transition-all whitespace-nowrap" data-tab="removeUser">Remove User</a>
                        <a href="{{ url_for('admin_tools_remove_data_page') }}" class="tab-button px-5 py-3 text-sm font-bold text-gray-500 border-b-2 border-transparent hover:text-indigo-600 hover:border-indigo-400 transition-all whitespace-nowrap" data-tab="removeLoomData">Remove Data</a>
                        <a href="{{ url_for('admin_tools_list_users_page') }}" class="tab-button px-5 py-3 text-sm font-bold text-gray-500 border-b-2 border-transparent hover:text-indigo-600 hover:border-indigo-400 transition-all whitespace-nowrap" data-tab="listUsers">List Users</a>
                        <a href="{{ url_for('admin_tools_warp_management_page') }}" class="tab-button px-5 py-3 text-sm font-bold text-gray-500 border-b-2 border-transparent hover:text-indigo-600 hover:border-indigo-400 transition-all whitespace-nowrap" data-tab="warpManagement">Warp Mgmt</a>
                    </div>

                    <!-- Tab Content: Add New User -->
                    <div id="addUserTabContent" class="tab-content max-w-2xl mx-auto animate-fade-in">
                        <h3 class="text-xl font-bold text-gray-800 mb-6">Add New User</h3>
                        <form id="addUserForm" class="space-y-6">
                            <div class="form-group">
                                <label class="block text-sm font-bold text-gray-700 mb-2">Username</label>
                                <div class="flex space-x-2">
                                    <input type="text" name="username" id="newUsernameInput" required class="flex-grow px-4 py-3 modern-input rounded-xl outline-none text-gray-800 font-medium">
                                    <button type="button" id="suggestLoomerNameBtn" class="bg-white/80 text-indigo-600 px-4 py-2 rounded-xl hover:bg-white text-sm font-bold transition-colors border border-indigo-100 shadow-sm">
                                        <span id="suggestLoomerNameBtnText">Suggest</span><span id="suggestLoomerNameSpinner" class="spinner hidden"></span>
                                    </button>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="block text-sm font-bold text-gray-700 mb-2">Password</label>
                                <input type="password" name="password" required class="w-full px-4 py-3 modern-input rounded-xl outline-none text-gray-800 font-medium">
                            </div>
                            <div class="form-group">
                                <label class="block text-sm font-bold text-gray-700 mb-2">Role</label>
                                <select name="role" required class="w-full px-4 py-3 modern-input rounded-xl outline-none text-gray-800 font-medium bg-white/50">
                                    <option value="">Select Role</option>
                                    <option value="loomer">Loomer</option>
                                    <option value="admin">Admin</option>
                                </select>
                            </div>
                            <button type="submit" id="addUserBtn" class="w-full btn-primary py-3.5 px-6 rounded-xl font-bold shadow-lg flex items-center justify-center text-lg tracking-wide">
                                <span id="addUserBtnText">Add User</span><span id="addUserSpinner" class="spinner hidden ml-2"></span>
                            </button>
                        </form>
                    </div>

                    <!-- Tab Content: Update User Password -->
                    <div id="updatePasswordTabContent" class="tab-content hidden max-w-2xl mx-auto animate-fade-in">
                        <h3 class="text-xl font-bold text-gray-800 mb-6">Update User Password</h3>
                        <form id="updatePasswordForm" class="space-y-6">
                            <div class="form-group">
                                <label class="block text-sm font-bold text-gray-700 mb-2">Username to Update</label>
                                <input type="text" name="username" required class="w-full px-4 py-3 modern-input rounded-xl outline-none text-gray-800 font-medium">
                            </div>
                            <div class="form-group">
                                <label class="block text-sm font-bold text-gray-700 mb-2">New Password</label>
                                <input type="password" name="new_password" required class="w-full px-4 py-3 modern-input rounded-xl outline-none text-gray-800 font-medium">
                            </div>
                            <div class="form-group">
                                <label class="block text-sm font-bold text-gray-700 mb-2">Confirm New Password</label>
                                <input type="password" name="confirm_password" required class="w-full px-4 py-3 modern-input rounded-xl outline-none text-gray-800 font-medium">
                            </div>
                            <button type="submit" id="updatePasswordBtn" class="w-full btn-secondary py-3.5 px-6 rounded-xl font-bold shadow-lg flex items-center justify-center text-lg tracking-wide">
                                <span id="updatePasswordBtnText">Update Password</span><span id="updatePasswordSpinner" class="spinner hidden ml-2"></span>
                            </button>
                        </form>
                    </div>

                    <!-- Tab Content: Remove User -->
                    <div id="removeUserTabContent" class="tab-content hidden max-w-2xl mx-auto animate-fade-in">
                        <h3 class="text-xl font-bold text-gray-800 mb-6">Remove User</h3>
                        <div class="bg-red-50/80 backdrop-blur-sm border border-red-100 rounded-xl p-4 mb-6 text-sm text-red-700 font-medium">
                            Warning: This action cannot be undone.
                        </div>
                        <form id="removeUserForm" class="space-y-6">
                            <div class="form-group">
                                <label class="block text-sm font-bold text-gray-700 mb-2">Username to Remove</label>
                                <input type="text" name="username" required class="w-full px-4 py-3 modern-input rounded-xl outline-none text-gray-800 font-medium border-red-200 focus:border-red-500 focus:ring-red-500/20">
                            </div>
                            <button type="submit" id="removeUserBtn" class="w-full bg-gradient-to-r from-red-600 to-rose-600 text-white py-3.5 px-6 rounded-xl font-bold shadow-lg hover:from-red-700 hover:to-rose-700 focus:outline-none focus:ring-4 focus:ring-red-500/30 transition-all flex items-center justify-center text-lg tracking-wide">
                                <span id="removeUserBtnText">Remove User</span><span id="removeUserSpinner" class="spinner hidden ml-2"></span>
                            </button>
                        </form>
                    </div>

                    <!-- Tab Content: Remove Loom Data -->
                    <div id="removeLoomDataTabContent" class="tab-content hidden max-w-2xl mx-auto animate-fade-in">
                        <h3 class="text-xl font-bold text-gray-800 mb-6">Remove Loom Data</h3>
                        <p class="text-sm text-gray-500 mb-6 font-medium">Specify criteria to remove matching loom data records. At least 'Loomer Name' or a 'Date Range' is required.</p>
                        <form id="removeLoomDataForm" class="space-y-6">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div class="form-group">
                                    <label class="block text-sm font-bold text-gray-700 mb-2">Loomer Name</label>
                                    <input type="text" name="loomer_name" id="remove_data_loomer_name"
                                        class="w-full px-4 py-3 modern-input rounded-xl outline-none text-gray-800 font-medium border-red-200 focus:border-red-500 focus:ring-red-500/20">
                                    <p class="text-xs text-gray-400 mt-1 font-medium">Leave empty to ignore.</p>
                                </div>

                                <div class="form-group">
                                    <label class="block text-sm font-bold text-gray-700 mb-2">Loom Number</label>
                                    <input type="text" name="loom_number" id="remove_data_loom_number" value=""
                                        class="w-full px-4 py-3 modern-input rounded-xl outline-none text-gray-800 font-medium border-red-200 focus:border-red-500 focus:ring-red-500/20">
                                    <p class="text-xs text-gray-400 mt-1 font-medium">Leave empty to ignore.</p>
                                </div>

                                <div class="form-group md:col-span-2">
                                    <label class="block text-sm font-bold text-gray-700 mb-2">Shift</label>
                                    <select name="shift" id="remove_data_shift"
                                            class="w-full px-4 py-3 modern-input rounded-xl outline-none text-gray-800 font-medium border-red-200 focus:border-red-500 focus:ring-red-500/20 bg-white/50">
                                        <option value="">-- Any Shift --</option>
                                        <option value="Morning">Morning</option>
                                        <option value="Night">Night</option>
                                    </select>
                                </div>

                                <div class="form-group">
                                    <label class="block text-sm font-bold text-gray-700 mb-2">From Date</label>
                                    <input type="date" name="from_date" id="remove_from_date" max="2100-12-31" min="2000-01-01" 
                                        class="w-full px-4 py-3 modern-input rounded-xl outline-none text-gray-800 font-medium border-red-200 focus:border-red-500 focus:ring-red-500/20">
                                </div>
                                <div class="form-group">
                                    <label class="block text-sm font-bold text-gray-700 mb-2">To Date</label>
                                    <input type="date" name="to_date" id="remove_to_date" max="2100-12-31" min="2000-01-01" 
                                        class="w-full px-4 py-3 modern-input rounded-xl outline-none text-gray-800 font-medium border-red-200 focus:border-red-500 focus:ring-red-500/20">
                                </div>
                            </div>
                            
                            <button type="submit" id="removeDataBtn" class="w-full bg-gradient-to-r from-red-700 to-rose-800 text-white py-3.5 px-6 rounded-xl font-bold shadow-lg hover:from-red-800 hover:to-rose-900 focus:outline-none focus:ring-4 focus:ring-red-500/30 transition-all flex items-center justify-center text-lg tracking-wide">
                                <span id="removeDataBtnText">Remove Data</span><span id="removeDataSpinner" class="spinner hidden ml-2"></span>
                            </button>
                        </form>
                    </div>

                    <!-- Tab Content: All Users List -->
                    <div id="listUsersTabContent" class="tab-content hidden animate-fade-in">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-xl font-bold text-gray-800">All Users</h3>
                            <button type="button" id="refreshUsersBtn" class="btn-secondary px-4 py-2 rounded-xl text-sm font-bold transition-colors flex items-center shadow-sm">
                                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>
                                Refresh List
                                <span id="refreshUsersSpinner" class="spinner hidden ml-2"></span>
                            </button>
                        </div>
                        <div id="usersListContainer" class="overflow-x-auto rounded-xl border border-gray-200 shadow-sm">
                            <table id="usersTable" class="min-w-full dark-table hidden">
                                <thead>
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Username</th>
                                        <th class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Role</th>
                                        <th class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">ID</th>
                                    </tr>
                                </thead>
                                <tbody id="usersTableBody" class="divide-y divide-gray-200">
                                    </tbody>
                            </table>
                            <p id="noUsersMessage" class="text-gray-500 text-center py-8 hidden font-medium">No users found.</p>
                        </div>
                    </div>

                    <!-- NEW Tab Content: Warp Management -->
                    <div id="warpManagementTabContent" class="tab-content hidden animate-fade-in">
                        <h3 class="text-xl font-bold text-gray-800 mb-6">Warp Management</h3>
                        
                        <!-- Current Total Warp Display -->
                        <div class="mb-8 bg-gradient-to-r from-indigo-600 to-purple-600 p-6 rounded-2xl text-white shadow-lg flex justify-between items-center transform transition-transform hover:scale-[1.02]">
                            <div>
                                <p class="text-indigo-100 text-sm font-bold uppercase tracking-wide">Current Total Warp</p>
                                <p class="text-5xl font-extrabold mt-2 tracking-tight"><span id="currentTotalWarp">0</span></p>
                            </div>
                            <div class="bg-white/20 p-4 rounded-xl backdrop-blur-sm">
                                <svg class="w-10 h-10 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                            <!-- Update Total Warp Form -->
                            <div class="bg-white/60 backdrop-blur-sm p-6 rounded-2xl border border-white/50 shadow-sm">
                                <h3 class="text-lg font-bold mb-4 text-gray-800 flex items-center">
                                    <svg class="w-6 h-6 mr-2 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>
                                    Update Total Warp
                                </h3>
                                <form id="updateWarpForm" class="space-y-4">
                                    <div class="form-group">
                                        <label for="warpUpdateValue" class="block text-sm font-bold text-gray-700">Warp Change (Count)</label>
                                        <input type="number" id="warpUpdateValue" name="value" class="mt-1 block w-full modern-input rounded-xl border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-3 font-medium" placeholder="e.g., 500 or -100" required>
                                    </div>
                                    <div class="form-group">
                                        <label for="warpUpdateDate" class="block text-sm font-bold text-gray-700">Date</label>
                                        <input type="date" id="warpUpdateDate" name="date" class="mt-1 block w-full modern-input rounded-xl border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-3 font-medium" required>
                                    </div>
                                    <div class="form-group">
                                        <label for="warpUpdateRemarks" class="block text-sm font-bold text-gray-700">Remarks (Optional)</label>
                                        <textarea id="warpUpdateRemarks" name="remarks" rows="2" class="mt-1 block w-full modern-input rounded-xl border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-3 font-medium" placeholder="Reason for update"></textarea>
                                    </div>
                                    <button type="submit" id="updateWarpBtn" class="w-full btn-primary py-3 px-4 rounded-xl hover:bg-indigo-700 flex items-center justify-center text-sm font-bold shadow-md transition-all">
                                        <span id="updateWarpBtnText">Update Warp</span><span id="updateWarpSpinner" class="spinner hidden ml-2"></span>
                                    </button>
                                </form>
                            </div>

                            <!-- Knotting Count Form -->
                            <div class="bg-white/60 backdrop-blur-sm p-6 rounded-2xl border border-white/50 shadow-sm">
                                <h3 class="text-lg font-bold mb-4 text-gray-800 flex items-center">
                                    <svg class="w-6 h-6 mr-2 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path></svg>
                                    Generate Knotting Count
                                </h3>
                                <form id="applyKnottingForm" class="space-y-4">
                                    <div class="form-group">
                                        <label for="knottingCountValue" class="block text-sm font-bold text-gray-700">Knotting Count (Subtract)</label>
                                        <input type="number" id="knottingCountValue" name="knotting_value" class="mt-1 block w-full modern-input rounded-xl border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-3 font-medium" placeholder="e.g., 200" min="0" required>
                                    </div>
                                    <div class="form-group">
                                        <label for="knottingDate" class="block text-sm font-bold text-gray-700">Date</label>
                                        <input type="date" id="knottingDate" name="date" class="mt-1 block w-full modern-input rounded-xl border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-3 font-medium" required>
                                    </div>
                                    <div class="form-group">
                                        <label for="knottingRemarks" class="block text-sm font-bold text-gray-700">Remarks (Optional)</label>
                                        <textarea id="knottingRemarks" name="remarks" rows="2" class="mt-1 block w-full modern-input rounded-xl border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-3 font-medium" placeholder="Loom number, reason, etc."></textarea>
                                    </div>
                                    <button type="submit" id="applyKnottingBtn" class="w-full btn-secondary py-3 px-4 rounded-xl hover:bg-blue-700 flex items-center justify-center text-sm font-bold shadow-md transition-all">
                                        <span id="applyKnottingBtnText">Generate Knotting</span><span id="applyKnottingSpinner" class="spinner hidden ml-2"></span>
                                    </button>
                                </form>
                            </div>
                        </div>

                        <!-- Knotting Calculation Result Display -->
                        <div id="knottingResultDisplay" class="hidden mb-8 p-6 bg-amber-50/80 backdrop-blur-sm border border-amber-200 rounded-2xl shadow-sm flex items-center justify-between animate-fade-in">
                            <div>
                                <h3 class="text-sm font-bold text-amber-800 uppercase tracking-wide">Calculated Warp After Knotting</h3>
                                <p class="text-4xl font-extrabold text-amber-900 mt-2"><span id="calculatedRemainingWarp">0.00</span></p>
                            </div>
                            <div class="text-right max-w-xs">
                                <p class="text-xs text-amber-700 font-medium">This value is for display only and does not alter the total warp.</p>
                            </div>
                        </div>

                        <!-- Warp Update History -->
                        <div class="border border-gray-200 rounded-2xl overflow-hidden shadow-sm">
                            <div class="bg-gray-50/80 backdrop-blur-sm px-6 py-4 border-b border-gray-200 flex justify-between items-center">
                                <h3 class="text-base font-bold text-gray-800">Warp Update History</h3>
                                <button id="clearWarpHistoryBtn" class="text-xs text-red-600 hover:text-red-800 font-bold hover:underline uppercase tracking-wide">Clear History</button>
                            </div>
                            <div id="warpHistoryTableContainer" class="overflow-x-auto">
                                <table id="warpHistoryTable" class="min-w-full divide-y divide-gray-200">
                                    <thead class="bg-white">
                                        <tr>
                                            <th class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Date</th>
                                            <th class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">User</th>
                                            <th class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Type</th>
                                            <th class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Change</th>
                                            <th class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">New Total</th>
                                            <th class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Remarks</th>
                                        </tr>
                                    </thead>
                                    <tbody id="warpHistoryTableBody" class="bg-white divide-y divide-gray-200">
                                        <!-- History records will be loaded here by JavaScript -->
                                        <tr><td colspan="6" class="px-6 py-4 text-center text-gray-500 font-medium">Loading history...</td></tr>
                                    </tbody>
                                </table>
                            </div>
                            <p id="noWarpHistoryMessage" class="hidden text-center text-gray-500 py-8 font-medium">No warp update history found.</p>
                            
                        </div>
                    </div>
                </div>
            </section>

            <!-- Section: Profile -->
            <section id="profileSection" class="main-content-section glass-card mb-8 hidden animate-slide-up">
                <div class="p-4 sm:p-6 border-b border-white/20 bg-white/30 backdrop-blur-sm section-header">
                    <h2 class="text-2xl font-bold text-gradient">Profile</h2>
                    <p class="text-sm text-gray-600 mt-1 font-medium" id="profileSubtitle">Your account details and lifetime totals.</p>
                </div>

                <div class="p-4 sm:p-6">
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <div class="bg-white/60 backdrop-blur-sm p-6 rounded-2xl border border-white/50 shadow-sm">
                            <h3 class="text-lg font-bold text-gray-800 mb-4">Account</h3>
                            <div class="space-y-2 text-sm">
                                <div class="flex items-center justify-between">
                                    <span class="text-gray-500 font-bold">Username</span>
                                    <span class="text-gray-800 font-bold" id="profileUsername">-</span>
                                </div>
                                <div class="flex items-center justify-between">
                                    <span class="text-gray-500 font-bold">Role</span>
                                    <span class="text-indigo-700 font-bold capitalize" id="profileRole">-</span>
                                </div>
                                <div class="flex items-center justify-between">
                                    <span class="text-gray-500 font-bold">Joined</span>
                                    <span class="text-gray-800 font-bold" id="profileCreatedAt">-</span>
                                </div>
                            </div>
                        </div>

                        <div class="bg-white/60 backdrop-blur-sm p-6 rounded-2xl border border-white/50 shadow-sm">
                            <h3 class="text-lg font-bold text-gray-800 mb-4" id="profileTotalsTitle">Lifetime Totals</h3>
                            <div class="grid grid-cols-1 gap-4">
                                <div class="p-4 rounded-xl bg-white/70 border border-white/60">
                                    <p class="text-xs font-bold text-gray-500 uppercase tracking-wide" id="profileMetersLabel">Total Meters</p>
                                    <p class="text-3xl font-extrabold text-gray-900 mt-1"><span id="profileTotalMeters">0</span></p>
                                </div>
                                <div class="p-4 rounded-xl bg-white/70 border border-white/60">
                                    <p class="text-xs font-bold text-gray-500 uppercase tracking-wide" id="profileSalaryLabel">Total Salary</p>
                                    <p class="text-3xl font-extrabold text-gray-900 mt-1">₹<span id="profileTotalSalary">0</span></p>
                                </div>
                            </div>
                        </div>

                        <div class="bg-white/60 backdrop-blur-sm p-6 rounded-2xl border border-white/50 shadow-sm">
                            <h3 class="text-lg font-bold text-gray-800 mb-4">Stats</h3>
                            <div class="space-y-2 text-sm">
                                <div class="flex items-center justify-between">
                                    <span class="text-gray-500 font-bold">Total Records</span>
                                    <span class="text-gray-900 font-extrabold" id="profileTotalRecords">0</span>
                                </div>
                                <p class="text-xs text-gray-500 mt-4 font-medium" id="profileScopeHint">Totals are calculated across your entire history.</p>
                                <p class="text-xs text-gray-500 font-medium hidden" id="profileLoadingHint">Loading…</p>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </div>
    </div>

    <script>
        const { jsPDF } = window.jspdf;
        let productionChartInstance = null; // To store the Chart.js instance
        let lastReportData = null; // To store the last fetched report data for PDF generation
        let currentWarpValue = 0; // Global variable to store current total warp

        const notifications = {
            dataAddedSuccess: "Data added successfully!",
            failedToAddData: "Failed to add data (server reported an issue)",
            reportGeneratedSuccess: "Report generated successfully!",
            reportDownloaded: "Report downloaded as PDF!",
            sessionExpired: "Session expired or not authorized. Please log in.",
            notAuthorizedAdmin: "Session expired or not authorized. Please log in as an Admin.",
            networkError: "A network error occurred or client-side processing failed.",
            missingRequiredFields: "Missing required fields:",
            loomerNameRequired: "Loomer Name is required to generate a report.",
            invalidUsernameOrPassword: "Invalid username or password.",
            loginFailed: "Login failed.",
            logoutSuccess: "Logged out successfully.",
            logoutFailed: "Failed to log out.",
            userAddedSuccess: "User added successfully.",
            failedToAddUser: "Failed to add user.",
            userExists: "User with this username already exists.",
            userRemovedSuccess: "User removed successfully.",
            userNotFound: "User not found.",
            failedToRemoveUser: "Failed to remove user.",
            cannotRemoveSelf: "Cannot remove your own admin account.",
            failedToFetchUsers: "Failed to fetch users.",
            removeDataConfirm: "Are you sure you want to remove data based on the specified criteria? This action cannot be undone.",
            removeDataSuccess: "records removed successfully.", 
            noMatchingRecords: "No matching records found to remove.",
            loomerNameOrDateRangeRequired: "At least 'Loomer Name' or a 'Date Range' is required to remove data. To remove all data for a loomer, enter their name and leave other fields as 'all'.",
            fromDateAfterToDate: "From Date cannot be after To Date for removal.",
            invalidDateFormat: "Invalid date format.",
            bothDatesRequired: "Both From Date and To Date are required for date-based removal.",
            failedToRemoveData: "Failed to remove data. An internal error occurred.",
            passwordMismatch: "New password and confirm password do not match.",
            passwordUpdateSuccess: "User password updated successfully!",
            passwordUpdateFailed: "Failed to update password.",
            userNotFoundForPasswordUpdate: "User not found for password update.",
            graphGeneratedSuccess: "Graph generated successfully!",
            noGraphDataFound: "No data found for the selected graph criteria.",
            warpUpdateSuccess: "Warp updated successfully!",
            failedToUpdateWarp: "Failed to update warp.",
            knottingAppliedSuccess: "Knotting calculation successful!", // Updated message
            failedToApplyKnotting: "Failed to perform knotting calculation.", // Updated message
            invalidWarpValue: "Please enter a valid number for warp change.",
            invalidKnottingValue: "Please enter a valid non-negative number for knotting count.",
            noRecordsFound: "No records found for the selected criteria.", 
            warpHistoryCleared: "Warp history cleared successfully!",
            failedToClearWarpHistory: "Failed to clear warp history.",
            confirmClearWarpHistory: "Are you sure you want to clear ALL warp history? This action cannot be undone.",
            aiAnalysisGenerated: "AI analysis generated successfully!", // New
            failedToGenerateAiAnalysis: "Failed to generate AI analysis.", // New
            noDataForAiAnalysis: "No data found for the selected criteria to analyze.", // New
            aiSuggestionGenerated: "AI loomer name suggested successfully!", // New
            failedToGenerateAiSuggestion: "Failed to generate AI loomer name suggestion.", // New
            aiQuestionAnswered: "AI answered your question!", // New
            failedToAnswerAiQuestion: "Failed to get AI answer." // New
        };

        function showNotification(messageKey, type = 'success', params = {}) {
            const notification = document.getElementById('notification');
            if (!notification) {
                console.error("Notification element not found!");
                return;
            }
            const messageSpan = notification.querySelector('#notification-message');
            if (!messageSpan) {
                console.error("Notification message span not found!");
                return;
            }

            // Reset classes but keep base structure
            notification.className = 'hidden fixed top-6 right-6 z-50 transition-all duration-300 transform translate-y-[-20px] scale-95 opacity-0 flex items-center p-4 mb-4 text-white rounded-xl shadow-2xl min-w-[320px] border border-white/20';
            notification.classList.add(type);
            
            // Update Icon based on type
            const iconContainer = notification.querySelector('div.flex-shrink-0');
            if (iconContainer) {
                let iconPath = '';
                if (type === 'success') {
                    iconPath = '<path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"></path>';
                } else if (type === 'error') {
                    iconPath = '<path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"></path>';
                } else if (type === 'info') {
                    iconPath = '<path stroke-linecap="round" stroke-linejoin="round" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>';
                }
                iconContainer.innerHTML = `<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2.5">${iconPath}</svg>`;
            }
            
            let message = notifications[messageKey] || messageKey; 

            if (params.count !== undefined) {
                message = `${params.count} ${message}`; 
            }
            if (params.fields) {
                message = `${message} ${params.fields}`; 
            }

            messageSpan.textContent = message;
            notification.classList.remove('hidden');
            // Small delay to allow display:block to apply before adding opacity/transform classes for transition
            requestAnimationFrame(() => {
                notification.classList.add('show');
            });

            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => notification.classList.add('hidden'), 400); // Hide after transition
            }, 4000); // Increased duration slightly
        }

        /**
         * Shows a specific content section and hides all other main sections.
         * Also manages active state of navigation links.
         * @param {string} sectionId The ID of the section to show.
         */
        function showSection(sectionId) {
            console.log(`Activating section: ${sectionId}`); // Log for debugging
            const sections = ['dataEntrySection', 'reportSection', 'graphsSection', 'adminSection', 'profileSection']; 

            sections.forEach(id => {
                const section = document.getElementById(id);
                if (section) {
                    if (id === sectionId) {
                        section.classList.remove('hidden');
                    } else {
                        section.classList.add('hidden');
                    }
                }
            });

            // Update active navigation link (desktop + mobile)
            document.querySelectorAll('a#navHome, a#navReport, a#navGraphs, a#navProfile, a#navAdmin, a#navHomeMobile, a#navReportMobile, a#navGraphsMobile, a#navProfileMobile, a#navAdminMobile').forEach(link => {
                link.classList.remove('nav-item-active');
            });

            // For the main navigation links (Enter Data, Reports, Graphs, Admin Tools)
            const baseId = `nav${sectionId.replace('Section', '')}`;
            const activeLink = document.getElementById(baseId);
            if (activeLink) {
                activeLink.classList.add('nav-item-active');
            }
            const mobileLink = document.getElementById(`${baseId}Mobile`);
            if (mobileLink) {
                mobileLink.classList.add('nav-item-active');
            }


            // If admin section is shown, activate its default tab (or override)
            if (sectionId === 'adminSection') {
                const preferredAdminTab = window.__initialAdminTab || 'addUser';
                activateAdminTab(preferredAdminTab);
            }
            // If report section is shown, activate its default tab
            if (sectionId === 'reportSection') {
                activateReportTab('detailedRecords'); // Default to Detailed Records tab
            }

            if (sectionId === 'profileSection') {
                fetchProfileSummary();
            }
            // Warp section content is now part of admin tools, so its data fetching is tied to admin tab activation
            
            // Always hide AI follow-up section when changing main sections
            document.getElementById('aiFollowUpSection').classList.add('hidden');
            document.getElementById('aiFollowUpAnswerContent').innerHTML = '';
            document.getElementById('aiQuestionInput').value = '';
            document.getElementById('noAiFollowUpAnswerMessage').classList.add('hidden');
        }

        /**
         * Manages the active state of admin tool tabs.
         * @param {string} tabId The ID of the tab to activate (e.g., 'addUser', 'updatePassword').
         */
        function activateAdminTab(tabId) {
            document.querySelectorAll('#adminSection .tab-button').forEach(button => {
                if (button.dataset.tab === tabId) {
                    button.classList.add('active');
                } else {
                    button.classList.remove('active');
                }
            });

            document.querySelectorAll('#adminSection .tab-content').forEach(content => {
                if (content.id === `${tabId}TabContent`) {
                    content.classList.remove('hidden');
                } else {
                    content.classList.add('hidden');
                }
            });

            // Special handling for List Users tab to refresh data when shown
            if (tabId === 'listUsers') {
                fetchUsers();
            } else if (tabId === 'warpManagement') { // New: Fetch warp data when warp management tab is activated
                fetchCurrentTotalWarp();
                fetchWarpHistory();
                document.getElementById('knottingResultDisplay').classList.add('hidden'); // Hide knotting result on tab change
            }
        }

        /**
         * Manages the active state of report section tabs.
         * @param {string} tabId The ID of the tab to activate (e.g., 'detailedRecords', 'loomSubtotals').
         */
        function activateReportTab(tabId) {
            document.querySelectorAll('#reportSection .tab-button').forEach(button => {
                if (button.dataset.tab === tabId) {
                    button.classList.add('active');
                } else {
                    button.classList.remove('active');
                }
            });

            document.querySelectorAll('#reportSection .tab-content').forEach(content => {
                if (content.id === `${tabId}TabContent`) {
                    content.classList.remove('hidden');
                } else {
                    content.classList.add('hidden');
                }
            });
        }


        // Custom Confirmation Modal (replaces window.confirm)
        function showCustomConfirm(message) {
            return new Promise((resolve) => {
                const modalHtml = `
                    <div id="customConfirmModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50">
                        <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full">
                            <p class="text-lg font-semibold text-gray-800 mb-4">${message}</p>
                            <div class="flex justify-end space-x-4">
                                <button id="confirmCancelBtn" class="px-4 py-2 bg-gray-300 text-gray-800 rounded-lg hover:bg-gray-400 transition">Cancel</button>
                                <button id="confirmOkBtn" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition">OK</button>
                            </div>
                        </div>
                    </div>
                `;
                document.body.insertAdjacentHTML('beforeend', modalHtml);

                const modal = document.getElementById('customConfirmModal');
                document.getElementById('confirmOkBtn').addEventListener('click', () => {
                    modal.remove();
                    resolve(true);
                });
                document.getElementById('confirmCancelBtn').addEventListener('click', () => {
                    modal.remove();
                    resolve(false);
                });
            });
        }


        document.addEventListener('DOMContentLoaded', async () => {
            // These variables are passed from Flask's render_template
            const username = "{{ username | default('') }}";
            const role = "{{ role | default('') }}";

            // Optional page overrides (used for "separate page" navigation)
            const initialSectionOverride = "{{ initial_section | default('') }}";
            const initialAdminTabOverride = "{{ initial_admin_tab | default('') }}";
            window.__initialAdminTab = initialAdminTabOverride || null;

            console.log("DOM Loaded. Username:", username, "Role:", role); 

            if (username && role) {
                const currentUsernameSpan = document.getElementById('currentUsername');
                const currentUserRoleSpan = document.getElementById('currentUserRole');

                if (currentUsernameSpan && currentUserRoleSpan) {
                    currentUsernameSpan.textContent = username;
                    currentUserRoleSpan.textContent = role;
                } else {
                    console.error("Required span elements for username/role (currentUsername, currentUserRole) not found!"); 
                }
                
                const dataEntrySection = document.getElementById('dataEntrySection');
                const reportSection = document.getElementById('reportSection');
                const graphsSection = document.getElementById('graphsSection');
                const adminSection = document.getElementById('adminSection');
                const navAdminLink = document.getElementById('navAdminLink');
                const navHomeLink = document.getElementById('navHomeLink'); // Get the 'Enter Data' list item

                const navHomeMobile = document.getElementById('navHomeMobile');
                const navAdminMobile = document.getElementById('navAdminMobile');
                
                const dataLoomerNameInput = document.getElementById('data_loomer_name'); // New ID
                const reportLoomerNameInput = document.getElementById('report_loomer_name'); // New ID
                const loomerNameReportHint = document.getElementById('loomerNameReportHint');
                const graphLoomerNameInput = document.getElementById('graph_loomer_name'); // New ID
                const analyzeReportBtn = document.getElementById('analyzeReportBtn'); // New button

                let initialSection = 'reportSection'; // Default for loomers

                if (role === 'admin') {
                    navAdminLink.classList.remove('hidden');
                    navHomeLink.classList.remove('hidden'); // Ensure 'Enter Data' is visible for admin

                    if (navAdminMobile) navAdminMobile.classList.remove('hidden');
                    if (navHomeMobile) navHomeMobile.classList.remove('hidden');
                    
                    dataLoomerNameInput.readOnly = false;
                    dataLoomerNameInput.value = ''; 

                    reportLoomerNameInput.readOnly = false;
                    reportLoomerNameInput.value = 'all'; 
                    loomerNameReportHint.classList.remove('hidden');
                    analyzeReportBtn.classList.remove('hidden'); // Show for admin

                    graphLoomerNameInput.readOnly = false;
                    graphLoomerNameInput.value = 'all'; 
                    initialSection = 'dataEntrySection'; // Admin's default view
                } else if (role === 'loomer') {
                    dataEntrySection.classList.add('hidden'); // Loomers don't add data
                    adminSection.classList.add('hidden'); 
                    navAdminLink.classList.add('hidden'); 
                    navHomeLink.classList.add('hidden'); // Hide 'Enter Data' nav link for loomers

                    if (navAdminMobile) navAdminMobile.classList.add('hidden');
                    if (navHomeMobile) navHomeMobile.classList.add('hidden');
                    analyzeReportBtn.classList.add('hidden'); // Hide for loomer

                    dataLoomerNameInput.value = username; 
                    dataLoomerNameInput.readOnly = true; 

                    reportLoomerNameInput.value = username; 
                    reportLoomerNameInput.readOnly = true; 
                    loomerNameReportHint.classList.add('hidden'); 

                    graphLoomerNameInput.value = username; 
                    graphLoomerNameInput.readOnly = true; 
                    initialSection = 'reportSection'; // Loomer's default view
                }
                
                // Set default date for all date input fields to today's date
                const today = new Date().toISOString().split('T')[0];
                // Ensure IDs are correct for these inputs
                const dataDateInput = document.getElementById('data_date'); 
                if (dataDateInput) dataDateInput.value = today;
                const reportFromDateInput = document.getElementById('report_from_date');
                const reportToDateInput = document.getElementById('report_to_date');
                if (reportFromDateInput) reportFromDateInput.value = today;
                if (reportToDateInput) reportToDateInput.value = today;

                const graphFromDateInput = document.getElementById('graph_from_date'); 
                const graphToDateInput = document.getElementById('graph_to_date'); 
                if (graphFromDateInput) graphFromDateInput.value = today;
                if (graphToDateInput) graphToDateInput.value = today;

                const removeFromDate = document.getElementById('remove_from_date');
                const removeToDate = document.getElementById('remove_to_date');
                if (removeFromDate) removeFromDate.value = today;
                if (removeToDate) removeToDate.value = today;

                // Set default date for new warp date inputs
                const warpUpdateDateInput = document.getElementById('warpUpdateDate');
                if (warpUpdateDateInput) warpUpdateDateInput.value = today;
                const knottingDateInput = document.getElementById('knottingDate');
                if (knottingDateInput) knottingDateInput.value = today;


                // Attach navigation event listeners
                const navHome = document.getElementById('navHome');
                if (navHome) { 
                    navHome.addEventListener('click', (e) => {
                        const href = navHome.getAttribute('href');
                        if (!href || href === '#') {
                            e.preventDefault();
                            showSection('dataEntrySection');
                        }
                    });
                }
                const navReport = document.getElementById('navReport');
                if (navReport) {
                    navReport.addEventListener('click', (e) => {
                        const href = navReport.getAttribute('href');
                        if (!href || href === '#') {
                            e.preventDefault();
                            showSection('reportSection');
                        }
                    });
                }

                const navGraphs = document.getElementById('navGraphs');
                if (navGraphs) {
                    navGraphs.addEventListener('click', (e) => {
                        const href = navGraphs.getAttribute('href');
                        if (!href || href === '#') {
                            e.preventDefault();
                            showSection('graphsSection');
                        }
                    });
                }

                const navAdmin = document.getElementById('navAdmin');
                if (navAdmin) { 
                    navAdmin.addEventListener('click', (e) => {
                        const href = navAdmin.getAttribute('href');
                        if (!href || href === '#') {
                            e.preventDefault();
                            showSection('adminSection');
                        }
                    });
                }

                const navProfile = document.getElementById('navProfile');
                if (navProfile) {
                    navProfile.addEventListener('click', (e) => {
                        const href = navProfile.getAttribute('href');
                        if (!href || href === '#') {
                            e.preventDefault();
                            showSection('profileSection');
                        }
                    });
                }
                

                // Admin tab navigation
                document.querySelectorAll('#adminSection .tab-button').forEach(button => {
                    button.addEventListener('click', (e) => {
                        // If the admin tabs are real links, let navigation happen.
                        if (button.tagName === 'A') {
                            const href = button.getAttribute('href');
                            if (href && href !== '#') {
                                return;
                            }
                            e.preventDefault();
                        }

                        const tabId = button.dataset.tab;
                        if (tabId) {
                            activateAdminTab(tabId);
                        }
                    });
                });

                // Report tab navigation
                document.querySelectorAll('#reportSection .tab-button').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const tabId = e.target.dataset.tab;
                        activateReportTab(tabId);
                    });
                });

                // Apply optional overrides coming from server-side routes
                if (initialSectionOverride) {
                    initialSection = initialSectionOverride;
                }
                if (initialAdminTabOverride) {
                    window.__initialAdminTab = initialAdminTabOverride;
                }

                // Show the initial section determined by Flask (or overridden)
                showSection(initialSection);

            } else {
                console.log("Username or role missing in template. Redirecting to login."); 
                window.location.href = '/login'; 
            }
        });

        async function fetchProfileSummary() {
            const loadingHint = document.getElementById('profileLoadingHint');
            const subtitle = document.getElementById('profileSubtitle');
            const totalsTitle = document.getElementById('profileTotalsTitle');
            const scopeHint = document.getElementById('profileScopeHint');

            const usernameEl = document.getElementById('profileUsername');
            const roleEl = document.getElementById('profileRole');
            const createdAtEl = document.getElementById('profileCreatedAt');
            const metersEl = document.getElementById('profileTotalMeters');
            const salaryEl = document.getElementById('profileTotalSalary');
            const recordsEl = document.getElementById('profileTotalRecords');

            try {
                if (loadingHint) loadingHint.classList.remove('hidden');
                const response = await fetch('/profile/summary');

                if (response.status === 401 || response.status === 403) {
                    showNotification('sessionExpired', 'error');
                    setTimeout(() => window.location.href = '/login', 1500);
                    return;
                }

                const data = await response.json();
                if (!response.ok || data.status !== 'success') {
                    showNotification(data.message || 'networkError', 'error');
                    return;
                }

                const user = data.user || {};
                const totals = data.totals || {};

                if (usernameEl) usernameEl.textContent = user.username || '-';
                if (roleEl) roleEl.textContent = user.role || '-';
                if (createdAtEl) createdAtEl.textContent = user.created_at ? new Date(user.created_at).toLocaleString() : '-';

                if (user.role === 'admin') {
                    if (subtitle) subtitle.textContent = 'Admin overview and lifetime totals.';
                    if (totalsTitle) totalsTitle.textContent = 'Overall Totals (All Loomers)';
                    if (scopeHint) scopeHint.textContent = 'Totals are calculated across all loomers.';
                } else {
                    if (subtitle) subtitle.textContent = 'Your account details and lifetime totals.';
                    if (totalsTitle) totalsTitle.textContent = 'Your Lifetime Totals';
                    if (scopeHint) scopeHint.textContent = 'Totals are calculated across your entire history.';
                }

                if (metersEl) metersEl.textContent = (totals.total_meters ?? 0).toLocaleString();
                if (salaryEl) salaryEl.textContent = (totals.total_salary ?? 0).toFixed(2);
                if (recordsEl) recordsEl.textContent = (totals.total_records ?? 0).toLocaleString();
            } catch (error) {
                console.error('Profile summary error:', error);
                showNotification('networkError', 'error');
            } finally {
                if (loadingHint) loadingHint.classList.add('hidden');
            }
        }

        // Helper to toggle spinner visibility and button text
        function toggleSpinner(buttonId, show) { // Removed loadingText parameter as it's not used to change text
            const button = document.getElementById(buttonId);
            if (!button) {
                console.error(`Button with ID ${buttonId} not found.`);
                return;
            }
            // Select the span that holds the text (assuming it's the first span child)
            // and the spinner span (assuming it has the 'spinner' class)
            const buttonTextSpan = button.querySelector('span:not(.spinner)'); 
            const spinner = button.querySelector('.spinner');

            if (show) {
                if (buttonTextSpan) {
                    buttonTextSpan.classList.add('hidden'); // Hide the text span
                }
                if (spinner) {
                    spinner.classList.remove('hidden'); // Show the spinner
                }
                button.disabled = true;
                button.classList.add('opacity-75', 'cursor-not-allowed');
            } else {
                if (buttonTextSpan) {
                    buttonTextSpan.classList.remove('hidden'); // Show the text span
                }
                if (spinner) {
                    spinner.classList.add('hidden'); // Hide the spinner
                }
                button.disabled = false;
                button.classList.remove('opacity-75', 'cursor-not-allowed');
            }
        }


        // Helper to hide all main content sections
        function hideAllContentSections() {
            document.querySelectorAll('.main-content-section').forEach(section => {
                section.classList.add('hidden');
            });
            // Also hide specific containers that might persist
            document.getElementById('resultContainer').classList.add('hidden');
            document.getElementById('noRecordsMessage').classList.add('hidden');
            document.getElementById('reportTable').innerHTML = ''; // Clear previous report data
            document.getElementById('loomSubtotalsTable').innerHTML = '';
            document.getElementById('dailySubtotalsTable').innerHTML = '';
            document.getElementById('aiResponseContainer').classList.add('hidden'); // Hide AI analysis container
            document.getElementById('aiAnalysisContent').innerHTML = ''; // Clear AI analysis content
            document.getElementById('aiFollowUpSection').classList.add('hidden'); // NEW: Hide AI follow-up section
            document.getElementById('aiFollowUpAnswerContent').innerHTML = ''; // NEW: Clear follow-up answer
            document.getElementById('aiQuestionInput').value = ''; // NEW: Clear question input
            document.getElementById('noAiFollowUpAnswerMessage').classList.add('hidden'); // NEW: Hide follow-up message

            // Clear graph if exists
            if (productionChartInstance) {
                productionChartInstance.destroy();
                productionChartInstance = null;
            }
            document.getElementById('noGraphDataMessage').classList.add('hidden');
        }


        document.getElementById('logoutBtn').addEventListener('click', async () => {
            toggleSpinner('logoutBtn', true); // No text needed, spinner replaces
            try {
                const response = await fetch('/logout', {
                    method: 'POST'
                });
                const data = await response.json();
                if (response.ok && data.status === 'success') {
                    showNotification('logoutSuccess', 'success');
                    window.location.href = '/login'; 
                } else {
                    showNotification('logoutFailed', 'error');
                }
            } catch (error) {
                showNotification('networkError', 'error');
                console.error('Logout error:', error);
            } finally {
                toggleSpinner('logoutBtn', false); // No text needed, spinner hides
            }
        });


        document.getElementById('dataEntryForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            toggleSpinner('submitDataBtn', true); // No text needed, spinner replaces
            
            try {
                const formData = new FormData(e.target);
                
                // --- Debugging: Log form data before sending ---
                const formDataObject = {};
                formData.forEach((value, key) => {
                    formDataObject[key] = value;
                });
                console.log("Submitting Loom Data:", formDataObject);
                // --- End Debugging ---

                const requiredFields = ["loomer_name", "loom_number", "shift", "meters", "salary_per_meter", "date"];
                const missingFields = requiredFields.filter(field => {
                    const value = formData.get(field);
                    return value === null || value.trim() === '';
                });

                if (missingFields.length > 0) {
                    showNotification('missingRequiredFields', 'error', { fields: missingFields.join(', ') });
                    toggleSpinner('submitDataBtn', false); // Ensure spinner is hidden on validation error
                    return;
                }

                const response = await fetch('/add_form', { 
                    method: 'POST',
                    body: formData 
                });
                
                if (response.status === 401 || response.status === 403) { 
                    showNotification('sessionExpired', 'error');
                    setTimeout(() => window.location.href = '/login', 1500); 
                    return;
                }

                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    const text = await response.text(); 
                    console.error('Server response was not JSON:', text);
                    showNotification('networkError', 'error'); 
                    return;
                }

                const data = await response.json();

                if (response.ok) {
                    if (data && data.status === 'success') {
                        showNotification('dataAddedSuccess', 'success');
                        // Removed: e.target.reset(); // Form will no longer clear automatically
                    } else {
                        showNotification(data.message || 'failedToAddData', 'error');
                    }
                } else {
                    showNotification(data.message || `networkError: ${response.status} - ${response.statusText}`, 'error');
                }
            } catch (error) {
                showNotification('networkError', 'error');
                console.error("Client-side Fetch Error:", error);
            } finally {
                toggleSpinner('submitDataBtn', false); // Spinner hides
            }
        });

        // Function to apply color based on meters
        function applyMeterColor(metersValue, element) {
            if (!element) return;

            // Remove all existing color classes related to meter ranges
            element.classList.remove('meters-red', 'meters-orange', 'meters-green', 'meters-dark-red');

            // Apply new color based on value
            if (metersValue >= 0 && metersValue <= 19) {
                element.classList.add('meters-red');
            } else if (metersValue >= 20 && metersValue <= 29) {
                element.classList.add('meters-orange');
            } else if (metersValue >= 30 && metersValue <= 37) {
                element.classList.add('meters-green');
            } else if (metersValue > 37) {
                element.classList.add('meters-dark-red');
            }
        }

        document.getElementById('dataQueryForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            toggleSpinner('generateReportBtn', true); // No text needed, spinner replaces
            
            try {
                const formData = new FormData(e.target);

                if (!formData.get('loomer_name') || formData.get('loomer_name').trim() === '') {
                    showNotification('loomerNameRequired', 'error');
                    toggleSpinner('generateReportBtn', false); // Ensure spinner hides
                    return;
                }

                // Check if the query is for a single day
                const fromDate = formData.get('from_date');
                const toDate = formData.get('to_date');
                const isSingleDayQuery = (fromDate === toDate);
                
                const response = await fetch('/get_meters', {
                    method: 'POST',
                    body: formData
                });
                
                if (response.status === 401 || response.status === 403) { 
                    showNotification('sessionExpired', 'error');
                    setTimeout(() => window.location.href = '/login', 1500);
                    return;
                }

                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    const text = await response.text(); 
                    console.error('Server response was not JSON:', text);
                    showNotification('networkError', 'error');
                    return;
                }

                const data = await response.json();
                lastReportData = data; // Store the data for PDF generation

                // --- Debugging: Log received report data ---
                console.log("Report data received:", data);
                // --- End Debugging ---

                const resultContainer = document.getElementById('resultContainer');
                const totalMetersSpan = document.getElementById('totalMeters');
                const totalSalarySpan = document.getElementById('totalSalary');
                const reportTableContainer = document.getElementById('detailedRecordsTabContent'); // Changed to tab content
                const reportTableDiv = document.getElementById('reportTable');
                const noRecordsMessage = document.getElementById('noRecordsMessage');
                const downloadPdfBtn = document.getElementById('downloadPdfBtn'); 
                const loomSubtotalsContainer = document.getElementById('loomSubtotalsTabContent'); // Changed to tab content
                const loomSubtotalsTableDiv = document.getElementById('loomSubtotalsTable');
                const dailySubtotalsContainer = document.getElementById('dailySubtotalsTabContent'); // Changed to tab content
                const dailySubtotalsTableDiv = document.getElementById('dailySubtotalsTable');     // New
                const aiResponseContainer = document.getElementById('aiResponseContainer'); // New
                const aiAnalysisContent = document.getElementById('aiAnalysisContent'); // New
                const noAiAnalysisMessage = document.getElementById('noAiAnalysisMessage'); // New
                const aiFollowUpSection = document.getElementById('aiFollowUpSection'); // NEW
                const aiFollowUpAnswerContent = document.getElementById('aiFollowUpAnswerContent'); // NEW
                const aiQuestionInput = document.getElementById('aiQuestionInput'); // NEW
                const noAiFollowUpAnswerMessage = document.getElementById('noAiFollowUpAnswerMessage'); // NEW


                reportTableDiv.innerHTML = '';
                noRecordsMessage.classList.add('hidden');
                reportTableContainer.classList.add('hidden'); // Hide detailed records tab content by default
                resultContainer.classList.add('hidden'); 
                downloadPdfBtn.classList.add('hidden'); 
                loomSubtotalsContainer.classList.add('hidden'); // Hide subtotals tab content by default
                loomSubtotalsTableDiv.innerHTML = ''; // Clear previous subtotals
                dailySubtotalsContainer.classList.add('hidden'); // Hide daily subtotals tab content by default
                dailySubtotalsTableDiv.innerHTML = ''; // Clear previous daily subtotals
                aiResponseContainer.classList.add('hidden'); // Hide AI analysis by default
                aiAnalysisContent.innerHTML = ''; // Clear previous AI analysis
                noAiAnalysisMessage.classList.add('hidden'); // Hide no AI message
                aiFollowUpSection.classList.add('hidden'); // NEW: Hide AI follow-up section
                aiFollowUpAnswerContent.innerHTML = ''; // NEW: Clear follow-up answer
                aiQuestionInput.value = ''; // NEW: Clear question input
                noAiFollowUpAnswerMessage.classList.add('hidden'); // NEW: Hide follow-up message


                if (response.ok) {
                    totalMetersSpan.textContent = data.total_meters || 0;
                    totalSalarySpan.textContent = parseFloat(data.total_salary || 0).toFixed(2);
                    resultContainer.classList.remove('hidden'); 

                    // Ensure main total meters span doesn't have conditional colors
                    totalMetersSpan.classList.remove('meters-red', 'meters-orange', 'meters-green', 'meters-dark-red');


                    if (data.records && data.records.length > 0) {
                        let tableHTML = `
                            <table id="productionTable" class="min-w-full dark-table rounded-lg shadow-md">
                                <thead>
                                    <tr>
                                        <th class="px-4 py-2 text-indigo-700">Loomer Name</th>
                                        <th class="px-4 py-2 text-indigo-700">Loom Number</th>
                                        <th class="px-4 py-2 text-indigo-700">Shift</th>
                                        <th class="px-4 py-2 text-indigo-700">Meters</th>
                                        <th class="px-4 py-2 text-indigo-700">Salary/Meter</th>
                                        <th class="px-4 py-2 text-indigo-700">Calculated Salary</th>
                                        <th class="px-4 py-2 text-indigo-700">Date</th>
                                    </tr>
                                </thead>
                                <tbody>
                        `;

                        data.records.forEach(record => {
                            const recordMeters = parseFloat(record.meters || 0);
                            const recordSalaryPerMeter = parseFloat(record.salary_per_meter || 0);
                            const calculatedRecordSalary = (recordMeters * recordSalaryPerMeter).toFixed(2);

                            tableHTML += `
                                <tr>
                                    <td class="px-4 py-2">${record.loomer_name || ''}</td>
                                    <td class="px-4 py-2">${record.loom_number || ''}</td>
                                    <td class="px-4 py-2">${record.shift || ''}</td>
                                    <td class="px-4 py-2"><span class="detailed-record-meters">${recordMeters}</span></td>
                                    <td class="px-4 py-2">₹${recordSalaryPerMeter.toFixed(2)}</td>
                                    <td class="px-4 py-2">₹${calculatedRecordSalary}</td>
                                    <td class="px-4 py-2">${record.date_formatted || ''}</td>
                                </tr>
                            `;
                        });

                        tableHTML += `
                                </tbody>
                            </table>
                        `;
                        reportTableDiv.innerHTML = tableHTML;
                        reportTableContainer.classList.remove('hidden'); 
                        downloadPdfBtn.classList.remove('hidden'); 
                        showNotification('reportGeneratedSuccess', 'success');

                        // Apply color to each meter value in detailed records
                        document.querySelectorAll('#reportTable .detailed-record-meters').forEach(span => {
                            applyMeterColor(parseInt(span.textContent), span);
                        });

                        // Render Loom Subtotals if available
                        if (data.loom_subtotals && data.loom_subtotals.length > 0) {
                            let subtotalsTableHTML = `
                                <table class="min-w-full dark-table rounded-lg shadow-md">
                                    <thead>
                                        <tr>
                                            <th class="px-4 py-2 text-indigo-700 text-left">Loom Number</th>
                                            <th class="px-4 py-2 text-indigo-700 text-right">Total Meters</th>
                                            <th class="px-4 py-2 text-indigo-700 text-right">Total Salary</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                            `;
                            data.loom_subtotals.forEach(subtotal => {
                                subtotalsTableHTML += `
                                    <tr>
                                        <td class="px-4 py-2 text-left">${subtotal.loom_number}</td>
                                        <td class="px-4 py-2 text-right"><span class="loom-subtotal-meters">${subtotal.total_meters}</span></td>
                                        <td class="px-4 py-2 text-right">₹${subtotal.total_salary}</td>
                                    </tr>
                                `;
                            });
                            subtotalsTableHTML += `
                                    </tbody>
                                </table>
                            `;
                            loomSubtotalsTableDiv.innerHTML = subtotalsTableHTML;
                            // loomSubtotalsContainer.classList.remove('hidden'); // This will be handled by tab activation

                            // Apply color to each meter value in loom subtotals
                            document.querySelectorAll('#loomSubtotalsTable .loom-subtotal-meters').forEach(span => {
                                applyMeterColor(parseInt(span.textContent), span);
                            });
                        }

                        // Render Daily Subtotals if available and it's a multi-day query
                        if (data.daily_subtotals && data.daily_subtotals.length > 0) { // Removed isSingleDayQuery check here, as daily subtotals might be useful even for single day if user wants to see it
                            let dailySubtotalsTableHTML = `
                                <table class="min-w-full dark-table rounded-lg shadow-md">
                                    <thead>
                                        <tr>
                                            <th class="px-4 py-2 text-indigo-700 text-left">Date</th>
                                            <th class="px-4 py-2 text-indigo-700 text-right">Total Meters</th>
                                            <th class="px-4 py-2 text-indigo-700 text-right">Total Salary</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                            `;
                            data.daily_subtotals.forEach(subtotal => {
                                dailySubtotalsTableHTML += `
                                    <tr>
                                        <td class="px-4 py-2 text-left">${subtotal.date}</td>
                                        <td class="px-4 py-2 text-right"><span class="daily-subtotal-meters">${subtotal.total_meters}</span></td>
                                        <td class="px-4 py-2 text-right">₹${subtotal.total_salary}</td>
                                    </tr>
                                `;
                            });
                            dailySubtotalsTableHTML += `
                                    </tbody>
                                </table>
                            `;
                            dailySubtotalsTableDiv.innerHTML = dailySubtotalsTableHTML;
                            // dailySubtotalsContainer.classList.remove('hidden'); // This will be handled by tab activation

                            // Apply color to each meter value in daily subtotals
                            document.querySelectorAll('#dailySubtotalsTable .daily-subtotal-meters').forEach(span => {
                                applyMeterColor(parseInt(span.textContent), span);
                            });
                        }


                    } else {
                        noRecordsMessage.classList.remove('hidden'); 
                        showNotification('noRecordsFound', 'info');
                    }

                } else {
                    showNotification(data.message || `networkError: ${response.status} - ${response.statusText}`, 'error');
                }
            } catch (error) {
                showNotification('networkError', 'error');
                console.error("Client-side Fetch Error:", error);
            } finally {
                toggleSpinner('generateReportBtn', false); // Spinner hides
            }
        });


        document.getElementById('downloadPdfBtn').addEventListener('click', () => {
            const productionTable = document.getElementById('productionTable');

            // --- IMPORTANT: Added check for productionTable existence ---
            if (!productionTable) {
                showNotification('Please generate a report first before downloading the PDF.', 'info');
                return; // Stop execution if table is not found
            }
            // --- End of added check ---

            const doc = new jsPDF('p', 'pt', 'a4');

            const loomerName = document.querySelector('#dataQueryForm input[name="loomer_name"]').value;
            const fromDate = document.querySelector('#dataQueryForm input[name="from_date"]').value;
            const toDate = document.querySelector('#dataQueryForm input[name="to_date"]').value;

            doc.setFont('helvetica');

            doc.setFontSize(18);
            doc.text(`Powerloom Production Report for ${loomerName}`, 40, 40);
            doc.setFontSize(12);
            doc.text(`From: ${fromDate} To: ${toDate}`, 40, 60);

            const totalMeters = document.getElementById('totalMeters').textContent;
            const totalSalary = document.getElementById('totalSalary').textContent;
            
            doc.setFontSize(16); 
            doc.setFont('helvetica', 'bold'); 
            doc.text(`Total Meters: ${totalMeters}`, 40, 80); 
            doc.text(`Total Salary: Rs. ${totalSalary}`, 40, 100); 
            doc.setFontSize(12); 
            doc.setFont('helvetica', 'normal'); 

            // Define table headers for autoTable in pure English
            const tableHeaders = [
                `Loomer Name`,
                `Loom Number`,
                `Shift`,
                `Meters`,
                `Salary/Meter`,
                `Calculated Salary`,
                `Date`
            ];

            const tableRows = productionTable.querySelectorAll('tbody tr');
            const tableData = [];
            tableRows.forEach(row => {
                const rowData = [];
                // Extract text content from each cell, including the span for meters
                row.querySelectorAll('td').forEach((cell, index) => {
                    if (index === 3) { // Meters column
                        const span = cell.querySelector('.detailed-record-meters');
                        rowData.push(span ? span.textContent.trim() : '');
                    } else {
                        rowData.push(cell.textContent.trim());
                    }
                });
                tableData.push(rowData);
            });


            doc.autoTable({
                head: [tableHeaders], 
                body: tableData,    
                startY: 140, 
                theme: 'striped', 
                styles: {
                    font: 'helvetica', 
                    fontSize: 10,
                    cellPadding: 5,
                    overflow: 'linebreak',
                    lineWidth: 0.5,
                    lineColor: [200, 200, 200]
                },
                headStyles: {
                    fillColor: [79, 70, 229], 
                    textColor: [255, 255, 255],
                    fontStyle: 'bold'
                },
                alternateRowStyles: {
                    fillColor: [248, 250, 252] 
                },
                didParseCell: function(data) {
                    if (data.column.index === 4 || data.column.index === 5) {
                        let value = data.cell.text[0]; 
                        const numericValue = parseFloat(value.replace(/[^0-9.]/g, '')); 
                        
                        if (!isNaN(numericValue)) {
                            data.cell.text = [`Rs. ${numericValue.toFixed(2)}`]; 
                        }
                    }
                },
            });

            // Add Loom Subtotals to PDF if available
            const loomSubtotalsData = lastReportData ? lastReportData.loom_subtotals : []; 

            if (loomSubtotalsData && loomSubtotalsData.length > 0) {
                doc.addPage(); // Start a new page for subtotals
                doc.setFontSize(18);
                doc.text(`Loom Subtotals for ${loomerName}`, 40, 40);
                doc.setFontSize(12);
                doc.text(`From: ${fromDate} To: ${toDate}`, 40, 60);

                const subtotalHeaders = [
                    `Loom Number`,
                    `Total Meters`,
                    `Total Salary`
                ];
                const subtotalRows = loomSubtotalsData.map(s => [s.loom_number, s.total_meters, `Rs. ${s.total_salary}`]);

                doc.autoTable({
                    head: [subtotalHeaders],
                    body: subtotalRows,
                    startY: 80,
                    theme: 'striped',
                    styles: {
                        font: 'helvetica',
                        fontSize: 10,
                        cellPadding: 5,
                        overflow: 'linebreak',
                        lineWidth: 0.5,
                        lineColor: [200, 200, 200]
                    },
                    headStyles: {
                        fillColor: [79, 70, 229],
                        textColor: [255, 255, 255],
                        fontStyle: 'bold'
                    },
                    alternateRowStyles: {
                        fillColor: [248, 250, 252]
                    }
                });
            }

            // Add Daily Subtotals to PDF if available
            const dailySubtotalsData = lastReportData ? lastReportData.daily_subtotals : []; 

            if (dailySubtotalsData && dailySubtotalsData.length > 0) {
                doc.addPage(); // Start a new page for daily subtotals
                doc.setFontSize(18);
                doc.text(`Daily Subtotals for ${loomerName}`, 40, 40);
                doc.setFontSize(12);
                doc.text(`From: ${fromDate} To: ${toDate}`, 40, 60);

                const dailySubtotalHeaders = [
                    `Date`,
                    `Total Meters`,
                    `Total Salary`
                ];
                const dailySubtotalRows = dailySubtotalsData.map(s => [s.date, s.total_meters, `Rs. ${s.total_salary}`]);

                doc.autoTable({
                    head: [dailySubtotalHeaders],
                    body: dailySubtotalRows,
                    startY: 80,
                    theme: 'striped',
                    styles: {
                        font: 'helvetica',
                        fontSize: 10,
                        cellPadding: 5,
                        overflow: 'linebreak',
                        lineWidth: 0.5,
                        lineColor: [200, 200, 200]
                    },
                    headStyles: {
                        fillColor: [79, 70, 229],
                        textColor: [255, 255, 255],
                        fontStyle: 'bold'
                    },
                    alternateRowStyles: {
                        fillColor: [248, 250, 252]
                    }
                });
            }


            doc.save(`Powerloom_Report_${loomerName}_${fromDate}_to_${toDate}.pdf`);
            showNotification('reportDownloaded', 'success');
        });

        document.getElementById('addUserForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            toggleSpinner('addUserBtn', true); // No text needed, spinner replaces
            const formData = new FormData(e.target);

            try {
                const response = await fetch('/admin/add_user', {
                    method: 'POST',
                    body: formData
                });

                if (response.status === 401 || response.status === 403) { 
                    showNotification('sessionExpired', 'error');
                    setTimeout(() => window.location.href = '/login', 1500);
                    return;
                }

                const data = await response.json();
                if (response.ok && data.status === 'success') {
                    showNotification('userAddedSuccess', 'success');
                    e.target.reset();
                    fetchUsers(); 
                } else {
                    showNotification(data.message || 'failedToAddUser', 'error');
                }
            } catch (error) {
                showNotification('networkError', 'error');
                console.error("Client-side Fetch Error:", error);
            } finally {
                toggleSpinner('addUserBtn', false); // Spinner hides
            }
        });

        // Event listener for Suggest Loomer Name button - Added
        document.getElementById('suggestLoomerNameBtn').addEventListener('click', async () => {
            const newUsernameInput = document.getElementById('newUsernameInput');
            toggleSpinner('suggestLoomerNameBtn', true);

            try {
                const response = await fetch('/admin/suggest_loomer_name', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' } // Even if no body, some APIs expect this
                });

                if (response.status === 401 || response.status === 403) {
                    showNotification('sessionExpired', 'error');
                    setTimeout(() => window.location.href = '/login', 1500);
                    return;
                }

                const data = await response.json();
                if (response.ok && data.status === 'success') {
                    newUsernameInput.value = data.suggested_name;
                    showNotification('aiSuggestionGenerated', 'success');
                } else {
                    showNotification(data.message || 'failedToGenerateAiSuggestion', 'error');
                }
            } catch (error) {
                showNotification('networkError', 'error');
                console.error("Client-side Fetch Error (Suggest Loomer Name):", error);
            } finally {
                toggleSpinner('suggestLoomerNameBtn', false);
            }
        });


        document.getElementById('updatePasswordForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            toggleSpinner('updatePasswordBtn', true); // No text needed, spinner replaces
            const formData = new FormData(e.target);
            const newPassword = formData.get('new_password');
            const confirmPassword = formData.get('confirm_password');

            if (newPassword !== confirmPassword) {
                showNotification('passwordMismatch', 'error');
                toggleSpinner('updatePasswordBtn', false); // Ensure spinner hides
                return;
            }

            try {
                const response = await fetch('/admin/update_password', {
                    method: 'POST',
                    body: formData
                });

                if (response.status === 401 || response.status === 403) { 
                    showNotification('sessionExpired', 'error');
                    setTimeout(() => window.location.href = '/login', 1500);
                    return;
                }

                const data = await response.json();
                if (response.ok && data.status === 'success') {
                    showNotification('passwordUpdateSuccess', 'success');
                    e.target.reset();
                } else {
                    showNotification(data.message || 'passwordUpdateFailed', 'error');
                }
            } catch (error) {
                showNotification('networkError', 'error');
                console.error("Client-side Fetch Error:", error);
            } finally {
                toggleSpinner('updatePasswordBtn', false); // Spinner hides
            }
        });

        document.getElementById('removeUserForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            toggleSpinner('removeUserBtn', true); // No text needed, spinner replaces
            const formData = new FormData(e.target);
            const usernameToRemove = formData.get('username');
            const currentLoggedInUsername = document.getElementById('currentUsername').textContent;

            if (usernameToRemove === currentLoggedInUsername) {
                showNotification('cannotRemoveSelf', 'error');
                toggleSpinner('removeUserBtn', false); // Ensure spinner hides
                return;
            }

            // Use custom confirmation for removing user
            if (!await showCustomConfirm(`Are you sure you want to remove user "${usernameToRemove}"? This action cannot be undone.`)) {
                toggleSpinner('removeUserBtn', false); // Ensure spinner hides
                return;
            }

            try {
                const response = await fetch('/admin/remove_user', {
                    method: 'POST',
                    body: formData
                });

                if (response.status === 401 || response.status === 403) { 
                    showNotification('sessionExpired', 'error');
                    setTimeout(() => window.location.href = '/login', 1500);
                    return;
                }

                const data = await response.json();
                if (response.ok && data.status === 'success') {
                    showNotification('userRemovedSuccess', 'success');
                    e.target.reset();
                    fetchUsers(); 
                } else {
                    showNotification(data.message || 'failedToRemoveUser', 'error');
                }
            } catch (error) {
                showNotification('networkError', 'error');
                console.error("Client-side Fetch Error:", error);
            } finally {
                toggleSpinner('removeUserBtn', false); // Spinner hides
            }
        });

        document.getElementById('removeLoomDataForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            toggleSpinner('removeDataBtn', true); // No text needed, spinner replaces
            const formData = new FormData(e.target);

            const loomerName = formData.get('loomer_name').trim();
            const fromDate = formData.get('from_date');
            const toDate = formData.get('to_date');

            // Validation: At least loomer name or a date range must be provided
            if (!loomerName && (!fromDate || !toDate)) {
                showNotification('loomerNameOrDateRangeRequired', 'error');
                toggleSpinner('removeDataBtn', false); // Ensure spinner hides
                return;
            }

            // Date range validation
            if (fromDate && toDate) {
                if (new Date(fromDate) > new Date(toDate)) {
                    showNotification('fromDateAfterToDate', 'error');
                    toggleSpinner('removeDataBtn', false); // Ensure spinner hides
                    return;
                }
            } else if (fromDate || toDate) { // If only one date is provided
                showNotification('bothDatesRequired', 'error');
                toggleSpinner('removeDataBtn', false); // Ensure spinner hides
                return;
            }

            // Confirmation before removal
            if (!await showCustomConfirm(notifications.removeDataConfirm)) {
                toggleSpinner('removeDataBtn', false); // Ensure spinner hides
                return;
            }

            try {
                const response = await fetch('/admin/remove_data', {
                    method: 'POST',
                    body: formData
                });

                if (response.status === 401 || response.status === 403) {
                    showNotification('sessionExpired', 'error');
                    setTimeout(() => window.location.href = '/login', 1500);
                    return;
                }

                const data = await response.json();
                if (response.ok && data.status === 'success') {
                    showNotification('removeDataSuccess', 'success', { count: data.deleted_count });
                    e.target.reset(); // Clear the form
                } else if (data.status === 'info') {
                    showNotification('noMatchingRecords', 'info');
                } else {
                    showNotification(data.message || 'failedToRemoveData', 'error');
                }
            } catch (error) {
                showNotification('networkError', 'error');
                console.error("Client-side Fetch Error:", error);
            } finally {
                toggleSpinner('removeDataBtn', false); // Spinner hides
            }
        });

        document.getElementById('graphQueryForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            toggleSpinner('generateGraphBtn', true); // No text needed, spinner replaces

            try {
                const formData = new FormData(e.target);
                const response = await fetch('/get_graph_data', {
                    method: 'POST',
                    body: formData
                });

                if (response.status === 401 || response.status === 403) {
                    showNotification('sessionExpired', 'error');
                    setTimeout(() => window.location.href = '/login', 1500);
                    return;
                }

                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    const text = await response.text();
                    console.error('Server response was not JSON:', text);
                    showNotification('networkError', 'error');
                    return;
                }

                const data = await response.json();

                const productionChartCanvas = document.getElementById('productionChart');
                const noGraphDataMessage = document.getElementById('noGraphDataMessage');

                if (productionChartInstance) {
                    productionChartInstance.destroy(); // Destroy previous chart instance
                }

                if (data.graph_data && data.graph_data.labels.length > 0) {
                    noGraphDataMessage.classList.add('hidden');
                    productionChartCanvas.classList.remove('hidden'); // Ensure canvas is visible

                    productionChartInstance = new Chart(productionChartCanvas, {
                        type: 'line', // Line chart is good for time series
                        data: {
                            labels: data.graph_data.labels,
                            datasets: [
                                {
                                    label: 'Meters Produced',
                                    data: data.graph_data.meters,
                                    borderColor: 'rgb(75, 192, 192)',
                                    tension: 0.1,
                                    fill: false
                                },
                                {
                                    label: 'Salary Paid (RS. )',
                                    data: data.graph_data.salary,
                                    borderColor: 'rgb(255, 99, 132)',
                                    tension: 0.1,
                                    fill: false,
                                    yAxisID: 'y1', // Use a second Y-axis for salary
                                }
                            ]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    title: {
                                        display: true,
                                        text: 'Meters'
                                    }
                                },
                                y1: { // Second Y-axis for salary
                                    type: 'linear',
                                    display: true,
                                    position: 'right',
                                    beginAtZero: true,
                                    grid: {
                                        drawOnChartArea: false, // Only draw grid lines for the first Y-axis
                                    },
                                    title: {
                                        display: true,
                                        text: 'Salary (RS. )'
                                    }
                                }
                            },
                            plugins: {
                                title: {
                                    display: true,
                                    text: 'Production Metrics Over Time'
                                }
                            }
                        }
                    });
                    showNotification('graphGeneratedSuccess', 'success');
                } else {
                    productionChartCanvas.classList.add('hidden'); // Hide canvas if no data
                    noGraphDataMessage.classList.remove('hidden');
                    showNotification('noGraphDataFound', 'info');
                }
            } catch (error) {
                showNotification('networkError', 'error');
                console.error("Client-side Fetch Error:", error);
            } finally {
                toggleSpinner('generateGraphBtn', false); // Spinner hides
            }
        });

        // Event listener for Analyze Report with AI button
        document.getElementById('analyzeReportBtn').addEventListener('click', async () => {
            const dataQueryForm = document.getElementById('dataQueryForm');
            const formData = new FormData(dataQueryForm);
            const aiResponseContainer = document.getElementById('aiResponseContainer');
            const aiAnalysisContent = document.getElementById('aiAnalysisContent');
            const noAiAnalysisMessage = document.getElementById('noAiAnalysisMessage');
            const aiFollowUpSection = document.getElementById('aiFollowUpSection'); // NEW
            const aiFollowUpAnswerContent = document.getElementById('aiFollowUpAnswerContent'); // NEW
            const aiQuestionInput = document.getElementById('aiQuestionInput'); // NEW
            const noAiFollowUpAnswerMessage = document.getElementById('noAiFollowUpAnswerMessage'); // NEW

            toggleSpinner('analyzeReportBtn', true);
            aiResponseContainer.classList.add('hidden');
            aiAnalysisContent.innerHTML = '';
            noAiAnalysisMessage.classList.add('hidden');
            aiFollowUpSection.classList.add('hidden'); // NEW: Hide follow-up section initially
            aiFollowUpAnswerContent.innerHTML = ''; // NEW: Clear follow-up answer
            aiQuestionInput.value = ''; // NEW: Clear question input
            noAiFollowUpAnswerMessage.classList.add('hidden'); // NEW: Hide follow-up message

            try {
                const response = await fetch('/analyze_report_with_ai', {
                    method: 'POST',
                    body: formData
                });

                if (response.status === 401 || response.status === 403) {
                    showNotification('sessionExpired', 'error');
                    setTimeout(() => window.location.href = '/login', 1500);
                    return;
                }

                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    const text = await response.text();
                    console.error('Server response was not JSON:', text);
                    showNotification('networkError', 'error');
                    return;
                }

                const data = await response.json();

                if (response.ok && data.status === 'success' && data.ai_analysis) {
                    aiAnalysisContent.innerHTML = formatAiResponse(data.ai_analysis); // Format markdown
                    aiResponseContainer.classList.remove('hidden');
                    aiFollowUpSection.classList.remove('hidden'); // NEW: Show follow-up section on success
                    showNotification('aiAnalysisGenerated', 'success');
                } else if (data.status === 'info') {
                    noAiAnalysisMessage.classList.remove('hidden');
                    showNotification('noDataForAiAnalysis', 'info');
                } else {
                    showNotification(data.message || 'failedToGenerateAiAnalysis', 'error');
                }
            } catch (error) {
                showNotification('networkError', 'error');
                console.error("Client-side Fetch Error (AI Analysis):", error);
            } finally {
                toggleSpinner('analyzeReportBtn', false);
            }
        });

        // NEW: Event listener for Ask AI Question button
        document.getElementById('askAiQuestionBtn').addEventListener('click', async () => {
            const aiQuestionInput = document.getElementById('aiQuestionInput');
            const question = aiQuestionInput.value.trim();
            const aiFollowUpAnswerContent = document.getElementById('aiFollowUpAnswerContent');
            const noAiFollowUpAnswerMessage = document.getElementById('noAiFollowUpAnswerMessage');

            if (!question) {
                showNotification('Please enter a question.', 'error'); // Direct message, not key
                return;
            }

            toggleSpinner('askAiQuestionBtn', true);
            aiFollowUpAnswerContent.innerHTML = ''; // Clear previous answer
            noAiFollowUpAnswerMessage.classList.add('hidden'); // Hide no answer message

            try {
                const formData = new FormData();
                formData.append('question', question);

                const response = await fetch('/analyze_report_with_ai/ask_question', {
                    method: 'POST',
                    body: formData
                });

                if (response.status === 401 || response.status === 403) {
                    showNotification('sessionExpired', 'error');
                    setTimeout(() => window.location.href = '/login', 1500);
                    return;
                }

                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    const text = await response.text();
                    console.error('Server response was not JSON:', text);
                    showNotification('networkError', 'error');
                    return;
                }

                const data = await response.json();

                if (response.ok && data.status === 'success' && data.ai_answer) {
                    aiFollowUpAnswerContent.innerHTML = formatAiResponse(data.ai_answer);
                    showNotification('aiQuestionAnswered', 'success');
                    aiQuestionInput.value = ''; // Clear input after successful submission
                } else if (data.status === 'info') {
                    noAiFollowUpAnswerMessage.classList.remove('hidden');
                    showNotification(data.message || 'No data found for the original criteria to answer the question.', 'info');
                }
                else {
                    showNotification(data.message || 'failedToAnswerAiQuestion', 'error');
                }
            } catch (error) {
                showNotification('networkError', 'error');
                console.error("Client-side Fetch Error (AI Follow-up):", error);
            } finally {
                toggleSpinner('askAiQuestionBtn', false);
            }
        });


        // Helper to format AI response (simple Markdown to HTML)
        function formatAiResponse(text) {
            let html = text;
            html = html.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>'); // Bold
            html = html.replace(/\*(.*?)\*/g, '<em>$1</em>'); // Italics
            html = html.replace(/^- (.*)$/gm, '<li>$1</li>'); // List items
            // Convert multiple newlines to paragraphs, ensuring lists are not affected
            html = html.replace(/(?<!<\/li>)\n\n(?!<li)/g, '</p><p>'); 
            html = html.replace(/^(?!<ul|<\/ul>|<p>)/, '<p>'); // Add opening <p> if not already starting with one
            html = html.replace(/(?<!<\/p>)$/, '</p>'); // Add closing </p> if not ending with one
            html = html.replace(/\n/g, '<br>'); // Convert single newlines to <br>

            // Handle lists specifically: wrap <li>s in <ul> if not already
            if (html.includes('<li>') && !html.includes('<ul>')) {
                html = `<ul>${html}</ul>`;
            }
            // Clean up any stray <p></p> tags that might appear due to empty lines
            html = html.replace(/<p><\/p>/g, '');
            return html;
        }


        // --- WARP MANAGEMENT JAVASCRIPT (Now integrated into Admin Tools) ---

        // Helper function to fetch and display current total warp
        async function fetchCurrentTotalWarp() {
            const currentTotalWarpSpan = document.getElementById('currentTotalWarp');
            if (!currentTotalWarpSpan) return; // Exit if element not found

            try {
                const response = await fetch('/get_current_warp'); // New backend endpoint
                if (response.status === 401 || response.status === 403) {
                    showNotification('sessionExpired', 'error');
                    setTimeout(() => window.location.href = '/login', 1500);
                    return;
                }
                if (!response.ok) {
                    const errorData = await response.json();
                    showNotification(errorData.message || 'Failed to fetch current warp.', 'error');
                    return;
                }
                const data = await response.json();
                currentWarpValue = parseFloat(data.total_warp); // Ensure it's parsed as a float
                currentTotalWarpSpan.textContent = currentWarpValue.toFixed(2); // Display with 2 decimal places
            } catch (error) {
                showNotification('networkError', 'error');
                console.error("Client-side Fetch Error (Current Warp):", error);
            }
        }

        // Helper function to fetch and display warp history
        async function fetchWarpHistory() {
            const historyTableBody = document.getElementById('warpHistoryTableBody');
            const noWarpHistoryMessage = document.getElementById('noWarpHistoryMessage');
            historyTableBody.innerHTML = '<tr><td colspan="6" class="px-4 py-2 text-center text-gray-500">Loading history...</td></tr>'; // Adjusted colspan

            try {
                const response = await fetch('/get_warp_history'); // New backend endpoint
                if (response.status === 401 || response.status === 403) {
                    showNotification('sessionExpired', 'error');
                    setTimeout(() => window.location.href = '/login', 1500);
                    return;
                }
                if (!response.ok) {
                    const errorData = await response.json();
                    showNotification(errorData.message || 'Failed to fetch warp history.', 'error');
                    historyTableBody.innerHTML = '<tr><td colspan="6" class="px-4 py-2 text-center text-gray-500">Failed to load history.</td></tr>'; // Adjusted colspan
                    return;
                }
                const data = await response.json();

                historyTableBody.innerHTML = ''; // Clear loading message
                if (data.history && data.history.length > 0) {
                    noWarpHistoryMessage.classList.add('hidden');
                    data.history.forEach(record => {
                        const row = historyTableBody.insertRow();
                        const changeValue = parseFloat(record.value_change);
                        const changeColorClass = changeValue > 0 ? 'text-green-600' : (changeValue < 0 ? 'text-red-600' : 'text-gray-600');
                        
                        // Use event_date from backend, which is the user-selected date
                        const dateString = record.event_date || 'N/A'; 

                        row.innerHTML = `
                            <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-900">${dateString}</td>
                            <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-900">${record.username || 'N/A'}</td>
                            <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-900">${record.change_type}</td>
                            <td class="px-4 py-2 whitespace-nowrap text-sm ${changeColorClass}">${changeValue >= 0 ? '+' : ''}${changeValue.toFixed(2)}</td>
                            <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-900">${parseFloat(record.new_total_warp).toFixed(2)}</td>
                            <td class="px-4 py-2 text-sm text-gray-900">${record.remarks || '-'}</td>
                        `;
                    });
                } else {
                    noWarpHistoryMessage.classList.remove('hidden');
                    historyTableBody.innerHTML = '<tr><td colspan="6" class="px-4 py-2 text-center text-gray-500">No history to display.</td></tr>'; // Adjusted colspan
                }
            } catch (error) {
                showNotification('networkError', 'error');
                console.error("Client-side Fetch Error (Warp History):", error);
                historyTableBody.innerHTML = '<tr><td colspan="6" class="px-4 py-2 text-center text-gray-500">Failed to load history.</td></tr>'; // Adjusted colspan
            }
        }

        // Event listener for Update Warp Form submission
        document.getElementById('updateWarpForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            toggleSpinner('updateWarpBtn', true); // No text needed, spinner replaces
            const formData = new FormData(e.target);
            const value = parseFloat(formData.get('value'));
            const date = formData.get('date'); // Get the date
            const remarks = formData.get('remarks');

            if (isNaN(value)) {
                showNotification('invalidWarpValue', 'error');
                toggleSpinner('updateWarpBtn', false); // Ensure spinner hides
                return;
            }

            try {
                const response = await fetch('/update_warp', { // New backend endpoint
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ value: value, date: date, remarks: remarks }) // Include date
                });

                if (response.status === 401 || response.status === 403) {
                    showNotification('sessionExpired', 'error');
                    setTimeout(() => window.location.href = '/login', 1500);
                    return;
                }

                const data = await response.json();
                if (response.ok && data.status === 'success') {
                    showNotification('warpUpdateSuccess', 'success');
                    e.target.reset(); // Clear the form
                    // Set default date for new warp date inputs
                    const today = new Date().toISOString().split('T')[0];
                    document.getElementById('warpUpdateDate').value = today;
                    document.getElementById('knottingDate').value = today;

                    fetchCurrentTotalWarp(); // Refresh current warp display
                    fetchWarpHistory();     // Refresh history
                } else {
                    showNotification(data.message || 'failedToUpdateWarp', 'error');
                }
            } catch (error) {
                showNotification('networkError', 'error');
                console.error("Client-side Fetch Error (Update Warp):", error);
            } finally {
                toggleSpinner('updateWarpBtn', false); // Spinner hides
            }
        });

        // Event listener for Generate Knotting Form submission
        document.getElementById('applyKnottingForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            toggleSpinner('applyKnottingBtn', true); // No text needed, spinner replaces
            
            const formData = new FormData(e.target);
            const knottingValue = parseFloat(formData.get('knotting_value'));
            const currentTotalWarp = currentWarpValue; 

            if (isNaN(knottingValue) || knottingValue < 0) {
                showNotification('invalidKnottingValue', 'error');
                toggleSpinner('applyKnottingBtn', false); 
                document.getElementById('knottingResultDisplay').classList.add('hidden'); 
                return;
            }

            if (isNaN(currentTotalWarp)) { 
                showNotification('Failed to get current warp for calculation. Please refresh the page.', 'error');
                toggleSpinner('applyKnottingBtn', false); 
                document.getElementById('knottingResultDisplay').classList.add('hidden'); 
                return;
            }

            if (knottingValue > currentTotalWarp) { 
                if (!await showCustomConfirm(`Knotting value (${knottingValue}) is greater than current total warp (${currentTotalWarp}). Are you sure you want to proceed? This calculation will result in a negative value.`)) {
                    toggleSpinner('applyKnottingBtn', false); 
                    document.getElementById('knottingResultDisplay').classList.add('hidden'); 
                    return;
                }
            }

            try {
                const response = await fetch('/apply_knotting', { 
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ 
                        knotting_value: knottingValue, 
                        current_total_warp: currentTotalWarp 
                    }) 
                });

                if (response.status === 401 || response.status === 403) {
                    showNotification('sessionExpired', 'error');
                    setTimeout(() => window.location.href = '/login', 1500);
                    return;
                }

                const data = await response.json();
                const calculatedRemainingWarpSpan = document.getElementById('calculatedRemainingWarp');
                const knottingResultDisplay = document.getElementById('knottingResultDisplay');

                if (response.ok && data.status === 'success') {
                    showNotification('knottingAppliedSuccess', 'success'); 
                    
                    calculatedRemainingWarpSpan.textContent = parseFloat(data.calculated_remaining_warp).toFixed(2);
                    knottingResultDisplay.classList.remove('hidden'); 

                    document.getElementById('knottingCountValue').value = ''; 
                    const today = new Date().toISOString().split('T')[0];
                    document.getElementById('warpUpdateDate').value = today;
                    document.getElementById('knottingDate').value = today;

                } else {
                    showNotification(data.message || 'failedToApplyKnotting', 'error');
                    knottingResultDisplay.classList.add('hidden'); 
                }
            } catch (error) {
                showNotification('networkError', 'error');
                console.error("Client-side Fetch Error (Generate Knotting):", error);
                document.getElementById('knottingResultDisplay').classList.add('hidden'); 
            } finally {
                toggleSpinner('applyKnottingBtn', false); 
            }
        });

        // New function to clear warp history
        async function clearWarpHistory() {
            if (!await showCustomConfirm(notifications.confirmClearWarpHistory)) {
                return;
            }

            toggleSpinner('clearWarpHistoryBtn', true); // No text needed, spinner replaces
            try {
                const response = await fetch('/clear_warp_history', { // New backend endpoint
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                if (response.status === 401 || response.status === 403) {
                    showNotification('sessionExpired', 'error');
                    setTimeout(() => window.location.href = '/login', 1500);
                    return;
                }

                const data = await response.json();
                if (response.ok && data.status === 'success') {
                    showNotification('warpHistoryCleared', 'success');
                    fetchWarpHistory(); // Refresh history table
                } else {
                    showNotification(data.message || 'failedToClearWarpHistory', 'error');
                }
            } catch (error) {
                showNotification('networkError', 'error');
                console.error("Client-side Fetch Error (Clear Warp History):", error);
            } finally {
                toggleSpinner('clearWarpHistoryBtn', false); // Spinner hides
            }
        }

        // Attach event listener for Clear Warp History button
        document.getElementById('clearWarpHistoryBtn').addEventListener('click', clearWarpHistory);

        // Fetch users for admin panel (existing function)
        async function fetchUsers() {
            const usersTableBody = document.getElementById('usersTableBody');
            const usersTable = document.getElementById('usersTable');
            const noUsersMessage = document.getElementById('noUsersMessage');
            toggleSpinner('refreshUsersBtn', true); // No text needed, spinner replaces
            usersTableBody.innerHTML = '<tr><td colspan="3" class="px-4 py-2 text-center text-gray-500">Loading users...</td></tr>';
            usersTable.classList.add('hidden');
            noUsersMessage.classList.add('hidden');

            try {
                const response = await fetch('/admin/get_users');
                if (response.status === 401 || response.status === 403) {
                    showNotification('sessionExpired', 'error');
                    setTimeout(() => window.location.href = '/login', 1500);
                    return;
                }
                const data = await response.json();
                usersTableBody.innerHTML = ''; // Clear loading message

                if (response.ok && data.status === 'success' && data.users.length > 0) {
                    usersTable.classList.remove('hidden');
                    data.users.forEach(user => {
                        const row = usersTableBody.insertRow();
                        row.innerHTML = `
                            <td class="px-4 py-2">${user.username}</td>
                            <td class="px-4 py-2">${user.role}</td>
                            <td class="px-4 py-2 text-xs">${user._id}</td>
                        `;
                    });
                } else {
                    noUsersMessage.classList.remove('hidden');
                    usersTable.classList.add('hidden');
                    usersTableBody.innerHTML = '<tr><td colspan="3" class="px-4 py-2 text-center text-red-500">Error loading users.</td></tr>';
                }
            } catch (error) {
                showNotification('failedToFetchUsers', 'error');
                console.error("Failed to fetch users:", error);
                usersTableBody.innerHTML = '<tr><td colspan="3" class="px-4 py-2 text-center text-red-500">Error loading users.</td></tr>';
            } finally {
                toggleSpinner('refreshUsersBtn', false); // Spinner hides
            }
        }

        // Event listener for Refresh Users button
        document.getElementById('refreshUsersBtn').addEventListener('click', fetchUsers);
    </script>
</body>
</html>
