<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Powerloom Data Management System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- jsPDF and jspdf-autotable for PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .form-group {
            transition: all 0.3s ease;
        }
        .form-group:hover {
            transform: translateY(-2px);
        }
        .btn {
            transition: all 0.2s ease;
        }
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        #notification {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            transition: all 0.3s ease;
        }
        /* Basic table styles for better readability */
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }
        th, td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid #e2e8f0; /* gray-200 */
        }
        th {
            background-color: #f8fafc; /* gray-50 */
            font-weight: 600;
            color: #4a5568; /* gray-700 */
        }
        tr:hover {
            background-color: #f0f4f8; /* gray-100 */
        }
    </style>
</head>
<body class="bg-gray-50">
    <div id="notification" class="hidden"></div>

    <div class="container mx-auto px-4 py-8 max-w-4xl">
        <header class="mb-10 text-center">
            <img src="https://storage.googleapis.com/workspace-0f70711f-8b4e-4d94-86f1-2a93ccde5887/image/0635fec5-78d9-42fb-8cc2-e77505022dfb.png" class="w-full h-48 object-cover rounded-lg mb-6" alt="Modern textile factory with rows of mechanical power looms producing fabrics">
            <h1 class="text-3xl font-bold text-indigo-800">Powerloom Data Management System</h1>
            <p class="text-gray-600 mt-2">Efficiently track loom production metrics</p>
            
            <div class="mt-4 text-gray-700 flex justify-center items-center space-x-2">
                <p>Welcome, <span id="currentUsername" class="font-semibold capitalize"></span> (<span id="currentUserRole" class="font-semibold capitalize"></span>)</p>
                <button id="logoutBtn" class="btn bg-gray-200 text-gray-700 py-1 px-3 rounded-lg hover:bg-gray-300 text-sm">Logout</button>
            </div>
        </header>

        <div class="grid md:grid-cols-2 gap-8">
            <section id="dataEntrySection" class="bg-white p-6 rounded-lg shadow-md hidden"> <h2 class="text-xl font-semibold mb-4 text-indigo-700 border-b pb-2">Enter Loom Data</h2>
                <form id="dataEntryForm" class="space-y-4">
                    <div class="form-group">
                        <label class="block text-gray-700 mb-1 font-medium">Loomer Name</label>
                        <input type="text" name="loomer_name" required 
                               class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition">
                    </div>

                    <div class="form-group">
                        <label class="block text-gray-700 mb-1 font-medium">Loom Number</label>
                        <input type="text" name="loom_number" required 
                               class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition">
                    </div>

                    <div class="form-group">
                        <label class="block text-gray-700 mb-1 font-medium">Shift</label>
                        <select name="shift" required 
                                class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition">
                            <option value="">-- Select Shift --</option>
                            <option value="Morning">Morning</option>
                            <option value="Night">Night</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="block text-gray-700 mb-1 font-medium">Meters</label>
                        <input type="number" name="meters" min="0" required 
                               class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition">
                    </div>

                    <div class="form-group">
                        <label class="block text-gray-700 mb-1 font-medium">Salary per Meter</label>
                        <input type="number" name="salary_per_meter" min="0" step="0.01" required 
                               class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition">
                    </div>

                    <div class="form-group">
                        <label class="block text-gray-700 mb-1 font-medium">Date</label>
                        <input type="date" name="date" required max="2100-12-31" min="2000-01-01" 
                               class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition">
                    </div>

                    <button type="submit" class="btn w-full bg-indigo-600 text-white py-2 px-4 rounded-lg hover:bg-indigo-700">
                        Submit Data
                    </button>
                </form>
            </section>

            <section class="bg-white p-6 rounded-lg shadow-md">
                <h2 class="text-xl font-semibold mb-4 text-indigo-700 border-b pb-2">Production Report</h2>
                <form id="dataQueryForm" class="space-y-4">
                    <div class="form-group" id="loomerNameQueryGroup">
                        <label class="block text-gray-700 mb-1 font-medium">Loomer Name</label>
                        <input type="text" name="loomer_name" required 
                               class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition">
                        <p class="text-xs text-gray-500 mt-1 hidden">Enter "all" for all looms (Admin only)</p> </div>

                    <div class="form-group">
                        <label class="block text-gray-700 mb-1 font-medium">Shift</label>
                        <select name="shift" required 
                                class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition">
                            <option value="all">All Shifts</option>
                            <option value="Morning">Morning</option>
                            <option value="Night">Night</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="block text-gray-700 mb-1 font-medium">Loom Number</label>
                        <input type="text" name="loom_number" value="all" required 
                               class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition">
                        <p class="text-xs text-gray-500 mt-1">Enter "all" for all looms</p>
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div class="form-group">
                            <label class="block text-gray-700 mb-1 font-medium">From Date</label>
                            <input type="date" name="from_date" required max="2100-12-31" min="2000-01-01" 
                                   class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition">
                        </div>
                        <div class="form-group">
                            <label class="block text-gray-700 mb-1 font-medium">To Date</label>
                            <input type="date" name="to_date" required max="2100-12-31" min="2000-01-01" 
                                   class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition">
                        </div>
                    </div>

                    <button type="submit" class="btn w-full bg-indigo-600 text-white py-2 px-4 rounded-lg hover:bg-indigo-700">
                        Generate Report
                    </button>
                </form>

                <div id="resultContainer" class="mt-6 hidden">
                    <div class="bg-indigo-50 p-4 rounded-lg border border-indigo-100">
                        <h3 class="font-semibold text-indigo-800 mb-2">Total Production Summary</h3>
                        <p class="text-xl font-bold text-indigo-600 mb-2">Meters: <span id="totalMeters">0</span></p>
                        <p class="text-xl font-bold text-indigo-600">Salary: ₹<span id="totalSalary">0.00</span></p>
                        <p class="text-sm text-gray-500 mt-1">for the selected criteria</p>
                    </div>
                </div>

                <div id="reportTableContainer" class="mt-6 hidden">
                    <h3 class="font-semibold text-indigo-800 mb-2 border-b pb-2">Detailed Records</h3>
                    <div id="reportTable" class="overflow-x-auto">
                        </div>
                    <p id="noRecordsMessage" class="text-gray-600 text-center mt-4 hidden">No records found for the selected criteria.</p>
                    
                    <button id="downloadPdfBtn" class="btn w-full bg-red-600 text-white py-2 px-4 rounded-lg hover:bg-red-700 mt-4 hidden">
                        Download Report as PDF
                    </button>
                </div>
            </section>
        </div>

        <section id="adminSection" class="mt-10 bg-white p-6 rounded-lg shadow-md hidden">
            <h2 class="text-xl font-semibold mb-4 text-indigo-700 border-b pb-2">Admin: User Management</h2>
            
            <div class="mb-8">
                <h3 class="text-lg font-medium text-indigo-600 mb-3">Add New User</h3>
                <form id="addUserForm" class="space-y-4">
                    <div class="form-group">
                        <label class="block text-gray-700 mb-1">Username</label>
                        <input type="text" name="username" required class="w-full px-4 py-2 border rounded-lg">
                    </div>
                    <div class="form-group">
                        <label class="block text-gray-700 mb-1">Password</label>
                        <input type="password" name="password" required class="w-full px-4 py-2 border rounded-lg">
                    </div>
                    <div class="form-group">
                        <label class="block text-gray-700 mb-1">Role</label>
                        <select name="role" required class="w-full px-4 py-2 border rounded-lg">
                            <option value="">-- Select Role --</option>
                            <option value="loomer">Loomer</option>
                            <option value="admin">Admin</option>
                        </select>
                    </div>
                    <button type="submit" class="btn bg-green-600 text-white py-2 px-4 rounded-lg hover:bg-green-700">Add User</button>
                </form>
            </div>

            <div class="mb-8">
                <h3 class="text-lg font-medium text-indigo-600 mb-3">Remove User</h3>
                <form id="removeUserForm" class="space-y-4">
                    <div class="form-group">
                        <label class="block text-gray-700 mb-1">Username to Remove</label>
                        <input type="text" name="username" required class="w-full px-4 py-2 border rounded-lg">
                    </div>
                    <button type="submit" class="btn bg-red-600 text-white py-2 px-4 rounded-lg hover:bg-red-700">Remove User</button>
                </form>
            </div>

            <div class="mb-8">
                <h3 class="text-lg font-medium text-indigo-600 mb-3">Remove Loom Data</h3>
                <form id="removeLoomDataForm" class="space-y-4">
                    <p class="text-sm text-gray-600 mb-3">Specify criteria to remove matching loom data records. At least 'Loomer Name' or a 'Date Range' is required.</p>
                    <div class="form-group">
                        <label class="block text-gray-700 mb-1 font-medium">Loomer Name</label>
                        <input type="text" name="loomer_name" 
                               class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition">
                        <p class="text-xs text-gray-500 mt-1">Leave empty to not filter by loomer name.</p>
                    </div>

                    <div class="form-group">
                        <label class="block text-gray-700 mb-1 font-medium">Loom Number</label>
                        <input type="text" name="loom_number" value=""
                               class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition">
                        <p class="text-xs text-gray-500 mt-1">Leave empty to not filter by loom number.</p>
                    </div>

                    <div class="form-group">
                        <label class="block text-gray-700 mb-1 font-medium">Shift</label>
                        <select name="shift" 
                                class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition">
                            <option value="">-- Any Shift --</option>
                            <option value="Morning">Morning</option>
                            <option value="Night">Night</option>
                        </select>
                        <p class="text-xs text-gray-500 mt-1">Leave as "Any Shift" to not filter by shift.</p>
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div class="form-group">
                            <label class="block text-gray-700 mb-1 font-medium">From Date</label>
                            <input type="date" name="from_date" max="2100-12-31" min="2000-01-01" 
                                   class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition">
                        </div>
                        <div class="form-group">
                            <label class="block text-gray-700 mb-1 font-medium">To Date</label>
                            <input type="date" name="to_date" max="2100-12-31" min="2000-01-01" 
                                   class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition">
                        </div>
                    </div>
                    <p class="text-xs text-gray-500 mt-1">Both dates must be selected for date range filtering.</p>

                    <button type="submit" class="btn w-full bg-red-700 text-white py-2 px-4 rounded-lg hover:bg-red-800">
                        Remove Data
                    </button>
                </form>
            </div>

            <div>
                <h3 class="text-lg font-medium text-indigo-600 mb-3">All Users</h3>
                <button id="refreshUsersBtn" class="btn bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700 mb-4">Refresh User List</button>
                <div id="usersListContainer" class="overflow-x-auto">
                    <table id="usersTable" class="min-w-full bg-white rounded-lg shadow-md hidden">
                        <thead>
                            <tr>
                                <th class="px-4 py-2 text-indigo-700">Username</th>
                                <th class="px-4 py-2 text-indigo-700">Role</th>
                                <th class="px-4 py-2 text-indigo-700">ID</th>
                            </tr>
                        </thead>
                        <tbody>
                            </tbody>
                    </table>
                    <p id="noUsersMessage" class="text-gray-600 text-center mt-4 hidden">No users found.</p>
                </div>
            </div>
        </section>
    </div>

    <script>
        const { jsPDF } = window.jspdf;

        // Tamil Translations object removed as per request.
        // Keeping an empty object or removing the variable entirely if no other use for translations.
        // For clarity, I'm keeping a 'placeholder' with English if you ever want to re-introduce a specific translation.
        const tamilTranslations = {
            loomerName: "Loomer Name",
            loomNumber: "Loom Number",
            shift: "Shift",
            meters: "Meters",
            salaryPerMeter: "Salary per Meter",
            calculatedSalary: "Calculated Salary",
            date: "Date",
        };
        
        // English Notification messages (unchanged from previous version as they were already English)
        const notifications = {
            dataAddedSuccess: "Data added successfully!",
            failedToAddData: "Failed to add data (server reported an issue)",
            reportGeneratedSuccess: "Report generated successfully!",
            reportDownloaded: "Report downloaded as PDF!",
            sessionExpired: "Session expired or not authorized. Please log in.",
            notAuthorizedAdmin: "Session expired or not authorized. Please log in as an Admin.",
            networkError: "A network error occurred or client-side processing failed.",
            missingRequiredFields: "Missing required fields:",
            loomerNameRequired: "Loomer Name is required to generate a report.",
            invalidUsernameOrPassword: "Invalid username or password.",
            loginFailed: "Login failed.",
            logoutSuccess: "Logged out successfully.",
            logoutFailed: "Failed to log out.",
            userAddedSuccess: "User added successfully.",
            failedToAddUser: "Failed to add user.",
            userExists: "User with this username already exists.",
            userRemovedSuccess: "User removed successfully.",
            userNotFound: "User not found.",
            failedToRemoveUser: "Failed to remove user.",
            cannotRemoveSelf: "Cannot remove your own admin account.",
            failedToFetchUsers: "Failed to fetch users.",
            removeDataConfirm: "Are you sure you want to remove data based on the specified criteria? This action cannot be undone.",
            removeDataSuccess: "records removed successfully.", 
            noMatchingRecords: "No matching records found to remove.",
            loomerNameOrDateRangeRequired: "At least 'Loomer Name' or a 'Date Range' is required to remove data. To remove all data for a loomer, enter their name and leave other fields as 'all'.",
            fromDateAfterToDate: "From Date cannot be after To Date for removal.",
            invalidDateFormat: "Invalid date format.",
            bothDatesRequired: "Both From Date and To Date are required for date-based removal.",
            failedToRemoveData: "Failed to remove data. An internal error occurred."
        };


        function showNotification(messageKey, type = 'success', params = {}) {
            const notification = document.getElementById('notification');
            if (!notification) {
                console.error("Notification element not found!");
                return;
            }
            notification.className = type === 'success'
                ? 'bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg'
                : 'bg-red-500 text-white px-6 py-3 rounded-lg shadow-lg';
            
            let message = notifications[messageKey] || messageKey; 

            if (params.count !== undefined) {
                message = `${params.count} ${message}`; 
            }
            if (params.fields) {
                message = `${message} ${params.fields}`; 
            }

            notification.textContent = message;
            notification.classList.remove('hidden');

            setTimeout(() => {
                notification.classList.add('hidden');
            }, 3000);
        }

        document.addEventListener('DOMContentLoaded', () => {
            const username = "{{ username | default('') }}";
            const role = "{{ role | default('') }}";

            console.log("DOM Loaded. Username:", username, "Role:", role); 

            if (username && role) {
                const currentUsernameSpan = document.getElementById('currentUsername');
                const currentUserRoleSpan = document.getElementById('currentUserRole');

                if (currentUsernameSpan && currentUserRoleSpan) {
                    currentUsernameSpan.textContent = username;
                    currentUserRoleSpan.textContent = role;
                } else {
                    console.error("Required span elements for username/role (currentUsername, currentUserRole) not found!"); 
                }
                
                const dataEntrySection = document.getElementById('dataEntrySection');
                const adminSection = document.getElementById('adminSection');
                const loomerNameQueryInput = document.querySelector('#dataQueryForm input[name="loomer_name"]');
                const loomerNameHint = document.querySelector('#loomerNameQueryGroup p.text-xs');

                if (dataEntrySection && adminSection && loomerNameQueryInput && loomerNameHint) {
                    if (role === 'admin') {
                        dataEntrySection.classList.remove('hidden');
                        adminSection.classList.remove('hidden');
                        loomerNameQueryInput.readOnly = false;
                        loomerNameHint.classList.remove('hidden');
                        fetchUsers(); 
                    } else if (role === 'loomer') {
                        dataEntrySection.classList.add('hidden'); 
                        adminSection.classList.add('hidden'); 

                        loomerNameQueryInput.value = username;
                        loomerNameQueryInput.readOnly = true;
                        loomerNameHint.classList.add('hidden');
                    }
                } else {
                    console.error("One or more critical UI sections/elements not found on DOM load for role-based display.");
                }
            } else {
                console.log("Username or role missing in session. Redirecting to login."); 
                window.location.href = '/login'; 
            }
        });

        document.getElementById('logoutBtn').addEventListener('click', async () => {
            try {
                const response = await fetch('/logout', {
                    method: 'POST'
                });
                const data = await response.json();
                if (response.ok && data.status === 'success') {
                    showNotification('logoutSuccess', 'success');
                    window.location.href = '/login'; 
                } else {
                    showNotification('logoutFailed', 'error');
                }
            } catch (error) {
                showNotification('networkError', 'error');
                console.error('Logout error:', error);
            }
        });


        document.getElementById('dataEntryForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            try {
                const formData = new FormData(e.target);
                
                const requiredFields = ['loomer_name', 'loom_number', 'shift', 'meters', 'salary_per_meter', 'date']; 
                const missingFields = requiredFields.filter(field => {
                    const value = formData.get(field);
                    return value === null || value.trim() === '';
                });

                if (missingFields.length > 0) {
                    showNotification('missingRequiredFields', 'error', { fields: missingFields.join(', ') });
                    return;
                }

                const response = await fetch('/add_form', { 
                    method: 'POST',
                    body: formData 
                });
                
                if (response.status === 401 || response.status === 403) { 
                    showNotification('sessionExpired', 'error');
                    setTimeout(() => window.location.href = '/login', 1500); 
                    return;
                }

                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    const text = await response.text(); 
                    console.error('Server response was not JSON:', text);
                    showNotification('networkError', 'error'); 
                    return;
                }

                const data = await response.json();

                if (response.ok) {
                    if (data && data.status === 'success') {
                        showNotification('dataAddedSuccess', 'success');
                    } else {
                        showNotification(data.message || 'failedToAddData', 'error');
                    }
                } else {
                    showNotification(data.message || `networkError: ${response.status} - ${response.statusText}`, 'error');
                }
            } catch (error) {
                showNotification('networkError', 'error');
                console.error("Client-side Fetch Error:", error);
            }
        });

        document.getElementById('dataQueryForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            try {
                const formData = new FormData(e.target);

                if (!formData.get('loomer_name') || formData.get('loomer_name').trim() === '') {
                    showNotification('loomerNameRequired', 'error');
                    return;
                }
                
                const response = await fetch('/get_meters', {
                    method: 'POST',
                    body: formData
                });
                
                if (response.status === 401 || response.status === 403) { 
                    showNotification('sessionExpired', 'error');
                    setTimeout(() => window.location.href = '/login', 1500);
                    return;
                }

                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    const text = await response.text(); 
                    console.error('Server response was not JSON:', text);
                    showNotification('networkError', 'error');
                    return;
                }

                const data = await response.json();
                
                const resultContainer = document.getElementById('resultContainer');
                const totalMetersSpan = document.getElementById('totalMeters');
                const totalSalarySpan = document.getElementById('totalSalary');
                const reportTableContainer = document.getElementById('reportTableContainer');
                const reportTableDiv = document.getElementById('reportTable');
                const noRecordsMessage = document.getElementById('noRecordsMessage');
                const downloadPdfBtn = document.getElementById('downloadPdfBtn'); 

                reportTableDiv.innerHTML = '';
                noRecordsMessage.classList.add('hidden');
                reportTableContainer.classList.add('hidden');
                resultContainer.classList.add('hidden'); 
                downloadPdfBtn.classList.add('hidden'); 

                if (response.ok) {
                    totalMetersSpan.textContent = data.total_meters || 0;
                    totalSalarySpan.textContent = parseFloat(data.total_salary || 0).toFixed(2);
                    resultContainer.classList.remove('hidden'); 

                    if (data.records && data.records.length > 0) {
                        let tableHTML = `
                            <table id="productionTable" class="min-w-full bg-white rounded-lg shadow-md">
                                <thead>
                                    <tr>
                                        <th class="px-4 py-2 text-indigo-700">Loomer Name</th>
                                        <th class="px-4 py-2 text-indigo-700">Loom Number</th>
                                        <th class="px-4 py-2 text-indigo-700">Shift</th>
                                        <th class="px-4 py-2 text-indigo-700">Meters</th>
                                        <th class="px-4 py-2 text-indigo-700">Salary/Meter</th>
                                        <th class="px-4 py-2 text-indigo-700">Calculated Salary</th>
                                        <th class="px-4 py-2 text-indigo-700">Date</th>
                                    </tr>
                                </thead>
                                <tbody>
                        `;

                        data.records.forEach(record => {
                            const recordMeters = parseFloat(record.meters || 0);
                            const recordSalaryPerMeter = parseFloat(record.salary_per_meter || 0);
                            const calculatedRecordSalary = (recordMeters * recordSalaryPerMeter).toFixed(2);

                            tableHTML += `
                                <tr>
                                    <td class="px-4 py-2">${record.loomer_name || ''}</td>
                                    <td class="px-4 py-2">${record.loom_number || ''}</td>
                                    <td class="px-4 py-2">${record.shift || ''}</td>
                                    <td class="px-4 py-2">${recordMeters}</td>
                                    <td class="px-4 py-2">₹${recordSalaryPerMeter.toFixed(2)}</td>
                                    <td class="px-4 py-2">₹${calculatedRecordSalary}</td>
                                    <td class="px-4 py-2">${record.date || ''}</td>
                                </tr>
                            `;
                        });

                        tableHTML += `
                                </tbody>
                            </table>
                        `;
                        reportTableDiv.innerHTML = tableHTML;
                        reportTableContainer.classList.remove('hidden'); 
                        downloadPdfBtn.classList.remove('hidden'); 
                        showNotification('reportGeneratedSuccess', 'success');

                    } else {
                        noRecordsMessage.classList.remove('hidden'); 
                        showNotification('noRecordsFound', 'info');
                    }

                } else {
                    showNotification(data.message || `networkError: ${response.status} - ${response.statusText}`, 'error');
                }
            } catch (error) {
                showNotification('networkError', 'error');
                console.error("Client-side Fetch Error:", error);
            }
        });

        document.getElementById('downloadPdfBtn').addEventListener('click', () => {
            const doc = new jsPDF('p', 'pt', 'a4');

            const productionTable = document.getElementById('productionTable');
            const loomerName = document.querySelector('#dataQueryForm input[name="loomer_name"]').value;
            const fromDate = document.querySelector('#dataQueryForm input[name="from_date"]').value;
            const toDate = document.querySelector('#dataQueryForm input[name="to_date"]').value;

            // All Tamil font embedding logic and related warnings are removed.
            // PDF will use default jsPDF fonts (e.g., Helvetica), which support Latin characters.
            doc.setFont('helvetica');


            doc.setFontSize(18);
            doc.text(`Powerloom Production Report for ${loomerName}`, 40, 40);
            doc.setFontSize(12);
            doc.text(`From: ${fromDate} To: ${toDate}`, 40, 60);

            const totalMeters = document.getElementById('totalMeters').textContent;
            const totalSalary = document.getElementById('totalSalary').textContent;
            
            doc.setFontSize(14); 
            doc.setFont('helvetica', 'normal'); 
            doc.text(`Meters: ${totalMeters}`, 40, 80); 
            doc.setFontSize(16); 
            doc.setFont('helvetica', 'bold'); 
            doc.text(`Salary: ₹${totalSalary}`, 40, 100); 
            doc.setFontSize(12); 
            doc.setFont('helvetica', 'normal'); 

            // Define table headers for autoTable in pure English
            const tableHeaders = [
                `Loomer Name`,
                `Loom Number`,
                `Shift`,
                `Meters`,
                `Salary/Meter`,
                `Calculated Salary`,
                `Date`
            ];

            const tableRows = productionTable.querySelectorAll('tbody tr');
            const tableData = [];
            tableRows.forEach(row => {
                const rowData = [];
                row.querySelectorAll('td').forEach(cell => {
                    rowData.push(cell.textContent.trim());
                });
                tableData.push(rowData);
            });


            doc.autoTable({
                head: [tableHeaders], 
                body: tableData,     
                startY: 140, 
                theme: 'striped', 
                styles: {
                    font: 'helvetica', 
                    fontSize: 10,
                    cellPadding: 5,
                    overflow: 'linebreak',
                    lineWidth: 0.5,
                    lineColor: [200, 200, 200]
                },
                headStyles: {
                    fillColor: [79, 70, 229], 
                    textColor: [255, 255, 255],
                    fontStyle: 'bold'
                },
                alternateRowStyles: {
                    fillColor: [248, 250, 252] 
                },
                didParseCell: function(data) {
                    if (data.column.index === 4 || data.column.index === 5) {
                        let value = data.cell.text[0]; 
                        const numericValue = parseFloat(value.replace(/[^0-9.]/g, '')); 
                        
                        if (!isNaN(numericValue)) {
                            data.cell.text = [`₹${numericValue.toFixed(2)}`]; 
                        } else {
                            data.cell.text = ['₹0.00']; 
                        }
                    }
                },
            });

            doc.save(`Powerloom_Report_${loomerName}_${fromDate}_to_${toDate}.pdf`);
            showNotification('reportDownloaded', 'success');
        });

        document.getElementById('addUserForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);

            try {
                const response = await fetch('/admin/add_user', {
                    method: 'POST',
                    body: formData
                });

                if (response.status === 401 || response.status === 403) { 
                    showNotification('sessionExpired', 'error');
                    setTimeout(() => window.location.href = '/login', 1500);
                    return;
                }

                const data = await response.json();
                if (response.ok && data.status === 'success') {
                    showNotification('userAddedSuccess', 'success');
                    e.target.reset();
                    fetchUsers(); 
                } else {
                    showNotification(data.message || 'failedToAddUser', 'error');
                }
            } catch (error) {
                showNotification('networkError', 'error');
                console.error('Add user error:', error);
            }
        });

        document.getElementById('removeUserForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const usernameToRemove = formData.get('username').trim();

            const confirmation = window.confirm(`Are you sure you want to remove user '${usernameToRemove}'?`); 
            if (!confirmation) {
                return; 
            }
            
            try {
                const response = await fetch('/admin/remove_user', {
                    method: 'POST',
                    body: formData
                });

                if (response.status === 401 || response.status === 403) { 
                    showNotification('sessionExpired', 'error');
                    setTimeout(() => window.location.href = '/login', 1500);
                    return;
                }

                const data = await response.json();
                if (response.ok && data.status === 'success') {
                    showNotification('userRemovedSuccess', 'success');
                    e.target.reset();
                    fetchUsers(); 
                } else {
                    showNotification(data.message || 'failedToRemoveUser', 'error');
                }
            } catch (error) {
                showNotification('networkError', 'error');
                console.error('Remove user error:', error);
            }
        });

        document.getElementById('removeLoomDataForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);

            let hasCriteria = false;
            if (formData.get('loomer_name').trim() !== '') hasCriteria = true;
            if (formData.get('loom_number').trim() !== '') hasCriteria = true;
            if (formData.get('shift') !== '' && formData.get('shift') !== 'all') hasCriteria = true; 
            if (formData.get('from_date').trim() !== '' && formData.get('to_date').trim() !== '') hasCriteria = true;

            if (!hasCriteria) {
                showNotification('loomerNameOrDateRangeRequired', 'error'); 
                return;
            }

            const confirmation = window.confirm(notifications['removeDataConfirm']); 
            if (!confirmation) {
                return;
            }

            try {
                const response = await fetch('/admin/remove_data', {
                    method: 'POST',
                    body: formData
                });

                if (response.status === 401 || response.status === 403) {
                    showNotification('sessionExpired', 'error');
                    setTimeout(() => window.location.href = '/login', 1500);
                    return;
                }

                const data = await response.json();
                if (response.ok && data.status === 'success') {
                    showNotification('removeDataSuccess', 'success', { count: data.deleted_count }); 
                    e.target.reset(); 
                } else if (response.ok && data.status === 'info') {
                    showNotification('noMatchingRecords', 'info'); 
                }
                else {
                    showNotification(data.message || 'failedToRemoveData', 'error');
                }
            } catch (error) {
                showNotification('networkError', 'error');
                console.error('Remove data error:', error);
            }
        });


        async function fetchUsers() {
            const usersTableBody = document.querySelector('#usersTable tbody');
            const usersTable = document.getElementById('usersTable');
            const noUsersMessage = document.getElementById('noUsersMessage');
            
            if (!usersTableBody || !usersTable || !noUsersMessage) {
                console.error("User management table elements not found.");
                return;
            }

            usersTableBody.innerHTML = '';
            usersTable.classList.add('hidden');
            noUsersMessage.classList.add('hidden');

            try {
                const response = await fetch('/admin/get_users');

                if (response.status === 401 || response.status === 403) { 
                    showNotification('sessionExpired', 'error');
                    setTimeout(() => window.location.href = '/login', 1500);
                    return;
                }

                const data = await response.json();
                if (response.ok && data.status === 'success') {
                    if (data.users && data.users.length > 0) {
                        data.users.forEach(user => {
                            const row = usersTableBody.insertRow();
                            row.innerHTML = `
                                <td class="px-4 py-2">${user.username}</td>
                                <td class="px-4 py-2">${user.role}</td>
                                <td class="px-4 py-2 text-xs text-gray-500">${user._id}</td>
                            `;
                        });
                        usersTable.classList.remove('hidden');
                    } else {
                        noUsersMessage.classList.remove('hidden');
                    }
                } else {
                    showNotification(data.message || 'failedToFetchUsers', 'error');
                }
            } catch (error) {
                showNotification('networkError', 'error');
                console.error('Fetch users error:', error);
            }
        }

        document.getElementById('refreshUsersBtn').addEventListener('click', fetchUsers);
    </script>
</body>
</html>
